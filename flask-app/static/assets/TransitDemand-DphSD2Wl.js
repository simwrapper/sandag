import{d as W,n as Y,g as R,R as Z,r as J,j as et,M as ft,z as pt,l as mt,b as gt,H as vt,o as st,C as yt,m as St}from"./index-D5-tbn2z.js";import{l as kt,p as it,b as bt}from"./turf.es-DhhXp8l8.js";import{a as Lt}from"./avro-Dd9UqmeZ.js";import{c as Ct}from"./index-TZSCE1Yb.js";import{c as rt}from"./index-B9fw0f6a.js";import{d as _t}from"./index-CI0OoW-O.js";import{P as Tt}from"./papaparse.min-C96aDnBe.js";import{Y as xt}from"./index-BbtBDwfe.js";import{C as wt}from"./CollapsiblePanel-CMk_pN-v.js";import{W as at}from"./NewXmlFetcher.worker-BOgDa1_-.js";import{D as Dt}from"./DrawingTool-pbKihTAj.js";import{Z as Ot}from"./ZoomButtons-DPNPDnil.js";import{D as Rt}from"./DashboardDataManager-JgIt0Nd-.js";import{D as It,S as Pt,C as zt}from"./set-rtl-text-plugin-Bk__35WL.js";import{L as Mt,O as nt}from"./LineOffsetLayer-DNqAIXHv.js";import{G as Et}from"./geojson-layer-B0OdhzCL.js";import{S as Ft}from"./solid-polygon-layer-BTV7zvk-.js";import{c as ct}from"./color-DZRtpOAM.js";import{W as At}from"./GzipFetcher.worker-BOj_y5oQ.js";import"./text-layer-DXaVM5RI.js";import"./util-CHADgdP7.js";import"./fxp-4YEvQr-_.js";import"./extends-CCbyfPlC.js";import"./RoadNetworkLoader.worker-Bt7-RMFX.js";import"./Coords-CQQjH_Bj.js";import"./group-DobYzF2-.js";import"./index-_doEQLKC.js";import"./line-layer-DlkO3hlG.js";import"./path-layer-CxDndZO_.js";import"./cut-by-mercator-bounds-DcbBq5m8.js";const $t=W({name:"LeftDataPanel",props:{title:String},data:()=>({isHidden:!1,isLeaving:!1}),methods:{toggleHidePanel(){this.isHidden?this.isHidden=!this.isHidden:(this.isLeaving=!0,setTimeout(()=>{this.isHidden=!0,this.isLeaving=!1},300))}}});var jt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{attrs:{id:"datapanel"}},[s("div",{staticClass:"content-area",class:{"is-hidden":t.isHidden,bye:t.isLeaving}},[t.title?s("div",{staticClass:"info-header"},[s("h3",{staticStyle:{padding:"0.5rem 3rem","font-size":"1rem","font-weight":"normal",color:"white"}},[t._v(t._s(t.title))])]):t._e(),s("div",{staticClass:"top-area"},[t._t("default")],2)]),s("div",{staticClass:"restore-button",class:{"add-margin":!t.isHidden}},[s("button",{staticClass:"button is-small hide-button",on:{click:t.toggleHidePanel}},[t.isHidden?t._e():s("i",{staticClass:"fa fa-arrow-left"}),t.isHidden?s("i",{staticClass:"fa fa-arrow-right"}):t._e()])])])},Ht=[],Bt=Y($t,jt,Ht,!1,null,"51117d95");const Nt=Bt.exports;function ot(e){return new Worker("/assets/TransitSupplyHelper.worker-1BijG__s.js",{name:e?.name})}const Xt=(e,t)=>{const s=[];for(const h of e){const{center:u,radius:c,slices:d}=h,f=c*.05;let m=Math.PI/2,v=m;const b=48,I=Math.cos(u[1]*Math.PI/180),F=d.reduce((y,_)=>y+_.value,0);d.forEach(y=>{y.percent=y.value/F});const T=d.reduce((y,_)=>(y[_.label]=_.value,y),{}),C=[],M=f*1.02;for(let y=0;y<=b*2;y++)v=m+y/(b*2)*Math.PI*2,C.push([u[0]+M*Math.cos(v)/I,u[1]+M*Math.sin(v)]);const H=R.state.isDarkMode;s.push([{polygon:C,color:Q(H?"black":"white"),width:f+1e-5,values:T}]);const B=d.map(y=>{const _=[u];for(let g=0;g<=b;g++){const k=y.percent||0;v=m+g/b*k*Math.PI*2,_.push([u[0]+f*Math.cos(v)/I,u[1]+f*Math.sin(v)])}_.push(u),m=v;const O=Array.isArray(y.color)?y.color:Q(y.color);return{polygon:_,color:O,width:f,values:T}});s.push(B)}const l=s.flat();return l.sort((h,u)=>h.width<=u.width?1:-1),l},Q=e=>{try{const t=ct(e);return t?[t.r,t.g,t.b]:[0,0,0]}catch{return[0,0,0]}};function qt({viewId:e=0,links:t={},selectedFeatures:s=[],transitLines:r=[],stopMarkers:l=[],checkedTransitLines:h=[],mapIsIndependent:u=!1,projection:c="EPSG:4326",handleClickEvent:d=null,pieSlider:f=20,widthSlider:m=50}){const v=R.state.isDarkMode,b=R.state.locale;Z[e]=()=>{F(R.state.viewState)};const[I,F]=J.useState(R.state.viewState),T=J.useMemo(()=>t.features.map(k=>({source:[...k.geometry.coordinates[0],k.properties.sort],target:[...k.geometry.coordinates[1],k.properties.sort],color:k.properties.currentColor,width:k.properties.width})),[t]),C=J.useMemo(()=>{if(!l.length||!("boardings"in l[0]))return[];const g=l.map(x=>{let w=0,E=0;return Object.entries(r).forEach(([n,a])=>{const i=Object.values(x.ptLines).find(o=>o.name===a.id);i&&(w+=i.b,E+=i.a)}),{center:x.xy,radius:1e-5*f*Math.sqrt(w+E),slices:[{label:"boardings",color:"gold",value:w},{label:"alightings",color:"darkmagenta",value:E}]}});return Xt(g)},[l,f]);function M(g){d&&d(g)}function H(g){F(g),g.center=[g.longitude,g.latitude],u||R.commit("setMapCamera",g)}function B(g){const{object:k,index:x,layer:w}=g;if(x==-1)return null;if(w.id.startsWith("stop-pie-charts-layer")){let n='<div class="map-popup">';const{boardings:a,alightings:i}=k.values;k.values.total=a+i;for(const[o,p]of Object.entries(k.values))n+=`
        <div style="display: flex">
          <div>${o}:&nbsp;&nbsp;</div>
          <b style="margin-left: auto; text-align: right">${p}</b>
        </div>`;return n+="</div>",{html:n,style:{fontSize:"0.8rem",color:v?"#ccc":"#223",backgroundColor:v?"#2a4f4f":"#f4fff4",margin:"2rem 0 0rem 0rem"}}}const E=[{field:"pax",name_en:"Passengers",name_de:"Passagiere"},{field:"departures",name_en:"Departures",name_de:"Abfahrten"},{field:"cap",name_en:"Capacity",name_de:"Kapazität"},{field:"loadfac",name_en:"Load factor",name_de:"Load factor"}];try{let n='<div class="map-popup">';const a=t.features[x].properties;if(a.sort==0)return null;for(const i of E){let o=b=="de"?i.name_de:i.name_en;o=o.replaceAll(" ","&nbsp;"),Number.isFinite(a[i.field])&&(n+=`
            <div style="display: flex">
              <div>${o}:&nbsp;&nbsp;</div>
              <b style="margin-left: auto; text-align: right">${a[i.field]}</b>
            </div>`)}return n+="</div>",{html:n,style:{fontSize:"0.8rem",color:v?"#ccc":"#223",backgroundColor:v?"#2a3c4f":"white",margin:"2rem 0 0rem 0rem"}}}catch{return null}}const y=zt.DEFAULT,_=c&&c!=="Atlantis",O=[];return O.push(new Mt({id:"linkLayer",data:T,getSourcePosition:g=>g.source,getTargetPosition:g=>g.target,getColor:g=>g.color,getWidth:g=>g.width,widthUnits:"pixels",widthScale:m/50,widthMinPixels:1.5,widthMaxPixels:50,pickable:!0,coordinateSystem:y,opacity:1,autoHighlight:!1,offsetDirection:nt.RIGHT,parameters:{depthTest:!0},transitions:{getColor:200,getWidth:200}})),s.length&&O.push(new Et({id:"selected-links",data:s,getLineColor:Q(v?"#fbff66":"#ccff66"),getLineWidth:1,lineWidthUnits:"pixels",stroked:!0,filled:!1,pickable:!1,coordinateSystem:y,opacity:1,autoHighlight:!1,offsetDirection:nt.RIGHT,parameters:{depthTest:!1}})),O.push(new Ft({id:`stop-pie-charts-layer-${Math.random()}`,data:C,getPolygon:g=>g.polygon,getFillColor:g=>g.color,stroked:!1,filled:!0,pickable:!0,opacity:1,sizeScale:1,autoHighlight:!1,parameters:{depthTest:!1}})),et.createElement(It,{layers:O,viewState:I,controller:!0,pickingRadius:3,parameters:{blend:!1},getTooltip:B,getCursor:({isDragging:g,isHovering:k})=>g?"grabbing":k?"pointer":"grab",onClick:M,onViewStateChange:g=>H(g.viewState)},_&&et.createElement(Pt,{mapStyle:R.getters.mapStyle,mapboxApiAccessToken:ft}))}const Wt=W({name:"LegendBox",props:{rows:{type:Array,required:!0}},methods:{handleClick(e){this.$emit("item-clicked",e)}}});var Yt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"legend-container"},[s("p",{staticClass:"control-label"},[t._v("Legend")]),t._l(t.rows,function(r){return s("div",{key:r[0],staticClass:"legend-item",on:{click:function(l){return t.handleClick(r)}}},[s("div",{staticClass:"legend-col-1",style:{"background-color":r[0]}}),s("span",{staticClass:"legend-col-2"},[t._v(t._s(r[1]))])])})],2)},Gt=[],Kt=Y(Wt,Yt,Gt,!1,null,"fbd46ee2");const Vt=Kt.exports,Ut=W({name:"RouteDropdown",components:{},props:{source:{type:Object,required:!0},index:{type:Number,required:!0},selectedRoutes:{type:Array,required:!0},searchTerm:{type:String,required:!0},activeTransitLines:{type:Object,required:!0},color:String,cbToggleLineOpen:{type:Function,required:!0},cbToggleLineChecked:{type:Function,required:!0},cbToggleRouteChecked:{type:Function,required:!0}},data(){return{lineCheck:0,isChecked:!1,isOpen:!1,isPartial:!1,checkStates:{},stats:{departures:0,pax:0,loadfac:0}}},mounted(){this.isPartial=!1,this.isChecked=this.line.checked,this.isOpen=this.line.isOpen,this.selectedRoutes.forEach(e=>this.checkStates[e]=!0);for(const e of this.line.transitRoutes)e.departures&&(this.stats.departures+=e.departures),e.pax&&(this.stats.pax+=e.pax),e.loadfac&&(this.stats.loadfac+=e.loadfac);this.stats.loadfac=.001*Math.round(1e3*this.stats.loadfac),this.setRouteCheckmarks()},computed:{lineCheckActive(){return this.lineCheck!==0},line(){return this.source}},watch:{activeTransitLines(){this.line.id in this.activeTransitLines&&(this.stats=this.activeTransitLines[this.line.id].stats)},selectedRoutes(){this.setRouteCheckmarks(),this.selectedRoutes.length||(this.isChecked=!1)}},methods:{setRouteCheckmarks(){let e=0;this.isPartial=!1,this.checkStates={},this.line.transitRoutes.forEach(t=>{this.selectedRoutes.indexOf(t.id)>-1&&(this.checkStates[t.id]=!0,e++)}),this.lineCheck=0,e&&e==this.line.transitRoutes.length&&(this.isChecked=!0,this.lineCheck=2),e&&e<this.line.transitRoutes.length&&(this.lineCheck=1,this.isPartial=!0)},toggleCheck(){this.isChecked=!this.isChecked,this.cbToggleLineChecked({offset:this.line.offset,isChecked:this.isChecked})},toggleOpen(){this.isOpen=!this.isOpen,this.setRouteCheckmarks(),this.cbToggleLineOpen({offset:this.line.offset,isOpen:this.isOpen})},toggleRoute(e){this.cbToggleRouteChecked({route:e,offset:this.line.offset,isChecked:this.checkStates[e]})}}});var Jt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"route-dropdown flex-col",class:{"is-open":t.isOpen}},[s("div",{staticClass:"title-panel flex-row"},[s("div",{staticClass:"leftside flex-row flex1",on:{click:function(r){return r.preventDefault(),t.toggleCheck.apply(null,arguments)}}},[s("div",{staticClass:"mode-color-strip"}),s("b-checkbox",{staticClass:"fade",class:{faded:t.isPartial},attrs:{size:"is-small"},model:{value:t.lineCheckActive,callback:function(r){t.lineCheckActive=r},expression:"lineCheckActive"}}),s("div",{staticClass:"text-area flex-col"},[t.line.name?s("div",{staticClass:"line-title flex-row"},[t._v(t._s(t.line.name)),s("div",{staticClass:"span",staticStyle:{"font-weight":"normal"}},[t._v("  /  "+t._s(t.line.id))])]):s("div",{staticClass:"line-title"},[t._v(t._s(t.line.id))]),s("div",{staticClass:"metrics flex-row"},[s("div",{staticClass:"stat"},[t._v(t._s(t.stats.departures)+" deps")]),t.stats.pax?s("div",{staticClass:"stat"},[t._v(t._s(t.stats.pax)+" pax")]):t._e(),t.stats.loadfac?s("div",{staticClass:"stat"},[t._v(t._s(t.stats.loadfac.toFixed(3))+" Lfac")]):t._e()])])],1),s("div",{staticClass:"rightside flex-row"},[s("a",{staticClass:"card-header-icon",on:{click:t.toggleOpen}},[s("b-icon",{staticClass:"icon-reveal",attrs:{size:"is-small",icon:t.isOpen?"menu-down":"menu-up"}})],1)])]),t.isOpen?s("div",{staticClass:"card-details flex-col"},t._l(this.line.transitRoutes,function(r){return s("div",{key:r.id,staticClass:"route flex-row"},[s("div",{staticClass:"stuff flex-col"},[s("b-checkbox",{staticClass:"route-checkbox",attrs:{size:"is-small"},on:{input:function(l){return t.toggleRoute(r.id)}},model:{value:t.checkStates[r.id],callback:function(l){t.$set(t.checkStates,r.id,l)},expression:"checkStates[route.id]"}},[s("div",{staticClass:"route-title"},[t._v(t._s(r.id))])]),s("div",{staticClass:"service-period"},[t._v(t._s(r.firstDeparture)+" — "+t._s(r.lastDeparture))]),s("div",{staticClass:"detail flex-row"},[s("div",{staticClass:"deps"},[t._v("Deps: "+t._s(r.departures))]),r.pax?s("div",{staticClass:"deps clink"},[t._v("Pax: "+t._s(r.pax))]):t._e(),r.pax?s("div",{staticClass:"deps clink"},[t._v("Lfac: "+t._s(r.loadfac.toFixed(3)))]):t._e(),r.cap?s("div",{staticClass:"deps clink"},[t._v("Cap: "+t._s(r.cap))]):t._e()])],1)])}),0):t._e()])},Zt=[],Qt=Y(Ut,Jt,Zt,!1,null,"dea5530d");const K=Qt.exports;var ht={exports:{}};/*!
 * vue-virtual-scroll-list v2.3.4
 * open source under the MIT license
 * https://github.com/tangbc/vue-virtual-scroll-list#readme
 */(function(e,t){(function(s,r){e.exports=r(pt)})(mt,function(s){s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;function r(n,a){var i=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);a&&(o=o.filter(function(p){return Object.getOwnPropertyDescriptor(n,p).enumerable})),i.push.apply(i,o)}return i}function l(n){for(var a=1;a<arguments.length;a++){var i=arguments[a]!=null?arguments[a]:{};a%2?r(Object(i),!0).forEach(function(o){d(n,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach(function(o){Object.defineProperty(n,o,Object.getOwnPropertyDescriptor(i,o))})}return n}function h(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function u(n,a){for(var i=0;i<a.length;i++){var o=a[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}function c(n,a,i){return a&&u(n.prototype,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function d(n,a,i){return a in n?Object.defineProperty(n,a,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[a]=i,n}function f(n){return m(n)||v(n)||b(n)||F()}function m(n){if(Array.isArray(n))return I(n)}function v(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function b(n,a){if(n){if(typeof n=="string")return I(n,a);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(n);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return I(n,a)}}function I(n,a){(a==null||a>n.length)&&(a=n.length);for(var i=0,o=new Array(a);i<a;i++)o[i]=n[i];return o}function F(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var T={FRONT:"FRONT",BEHIND:"BEHIND"},C={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},M=0,H=function(){function n(a,i){h(this,n),this.init(a,i)}return c(n,[{key:"init",value:function(i,o){this.param=i,this.callUpdate=o,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.fixedSizeValue=0,this.calcType=C.INIT,this.offset=0,this.direction="",this.range=Object.create(null),i&&this.checkRange(0,i.keeps-1)}},{key:"destroy",value:function(){this.init(null,null)}},{key:"getRange",value:function(){var i=Object.create(null);return i.start=this.range.start,i.end=this.range.end,i.padFront=this.range.padFront,i.padBehind=this.range.padBehind,i}},{key:"isBehind",value:function(){return this.direction===T.BEHIND}},{key:"isFront",value:function(){return this.direction===T.FRONT}},{key:"getOffset",value:function(i){return(i<1?0:this.getIndexOffset(i))+this.param.slotHeaderSize}},{key:"updateParam",value:function(i,o){var p=this;this.param&&i in this.param&&(i==="uniqueIds"&&this.sizes.forEach(function(S,L){o.includes(L)||p.sizes.delete(L)}),this.param[i]=o)}},{key:"saveSize",value:function(i,o){this.sizes.set(i,o),this.calcType===C.INIT?(this.fixedSizeValue=o,this.calcType=C.FIXED):this.calcType===C.FIXED&&this.fixedSizeValue!==o&&(this.calcType=C.DYNAMIC,delete this.fixedSizeValue),this.calcType!==C.FIXED&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=f(this.sizes.values()).reduce(function(p,S){return p+S},0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}},{key:"handleDataSourcesChange",value:function(){var i=this.range.start;this.isFront()?i=i-M:this.isBehind()&&(i=i+M),i=Math.max(i,0),this.updateRange(this.range.start,this.getEndByStart(i))}},{key:"handleSlotSizeChange",value:function(){this.handleDataSourcesChange()}},{key:"handleScroll",value:function(i){this.direction=i<this.offset||i===0?T.FRONT:T.BEHIND,this.offset=i,this.param&&(this.direction===T.FRONT?this.handleFront():this.direction===T.BEHIND&&this.handleBehind())}},{key:"handleFront",value:function(){var i=this.getScrollOvers();if(!(i>this.range.start)){var o=Math.max(i-this.param.buffer,0);this.checkRange(o,this.getEndByStart(o))}}},{key:"handleBehind",value:function(){var i=this.getScrollOvers();i<this.range.start+this.param.buffer||this.checkRange(i,this.getEndByStart(i))}},{key:"getScrollOvers",value:function(){var i=this.offset-this.param.slotHeaderSize;if(i<=0)return 0;if(this.isFixedType())return Math.floor(i/this.fixedSizeValue);for(var o=0,p=0,S=0,L=this.param.uniqueIds.length;o<=L;){if(p=o+Math.floor((L-o)/2),S=this.getIndexOffset(p),S===i)return p;S<i?o=p+1:S>i&&(L=p-1)}return o>0?--o:0}},{key:"getIndexOffset",value:function(i){if(!i)return 0;for(var o=0,p=0,S=0;S<i;S++)p=this.sizes.get(this.param.uniqueIds[S]),o=o+(typeof p=="number"?p:this.getEstimateSize());return o}},{key:"isFixedType",value:function(){return this.calcType===C.FIXED}},{key:"getLastIndex",value:function(){return this.param.uniqueIds.length-1}},{key:"checkRange",value:function(i,o){var p=this.param.keeps,S=this.param.uniqueIds.length;S<=p?(i=0,o=this.getLastIndex()):o-i<p-1&&(i=o-p+1),this.range.start!==i&&this.updateRange(i,o)}},{key:"updateRange",value:function(i,o){this.range.start=i,this.range.end=o,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}},{key:"getEndByStart",value:function(i){var o=i+this.param.keeps-1,p=Math.min(o,this.getLastIndex());return p}},{key:"getPadFront",value:function(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}},{key:"getPadBehind",value:function(){var i=this.range.end,o=this.getLastIndex();return this.isFixedType()?(o-i)*this.fixedSizeValue:(o-i)*this.getEstimateSize()}},{key:"getEstimateSize",value:function(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}]),n}(),B={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0},dataComponent:{type:[Object,Function],required:!0},keeps:{type:Number,default:30},extraProps:{type:Object},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1},rootTag:{type:String,default:"div"},wrapTag:{type:String,default:"div"},wrapClass:{type:String,default:""},wrapStyle:{type:Object},itemTag:{type:String,default:"div"},itemClass:{type:String,default:""},itemClassAdd:{type:Function},itemStyle:{type:Object},headerTag:{type:String,default:"div"},headerClass:{type:String,default:""},headerStyle:{type:Object},footerTag:{type:String,default:"div"},footerClass:{type:String,default:""},footerStyle:{type:Object},itemScopedSlots:{type:Object}},y={index:{type:Number},event:{type:String},tag:{type:String},horizontal:{type:Boolean},source:{type:Object},component:{type:[Object,Function]},slotComponent:{type:Function},uniqueKey:{type:[String,Number]},extraProps:{type:Object},scopedSlots:{type:Object}},_={event:{type:String},uniqueKey:{type:String},tag:{type:String},horizontal:{type:Boolean}},O={created:function(){this.shapeKey=this.horizontal?"offsetWidth":"offsetHeight"},mounted:function(){var a=this;typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(function(){a.dispatchSizeChange()}),this.resizeObserver.observe(this.$el))},updated:function(){this.resizeObserver.observe(this.$el)},beforeDestroy:function(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},methods:{getCurrentSize:function(){return this.$el?this.$el[this.shapeKey]:0},dispatchSizeChange:function(){this.$parent.$emit(this.event,this.uniqueKey,this.getCurrentSize(),this.hasInitial)}}},g=s.component("virtual-list-item",{mixins:[O],props:y,render:function(a){var i=this.tag,o=this.component,p=this.extraProps,S=p===void 0?{}:p,L=this.index,D=this.source,P=this.scopedSlots,N=P===void 0?{}:P,X=this.uniqueKey,A=this.slotComponent,$=l(l({},S),{},{source:D,index:L});return a(i,{key:X,attrs:{role:"listitem"}},[A?A({item:D,index:L,scope:$}):a(o,{props:$,scopedSlots:N})])}}),k=s.component("virtual-list-slot",{mixins:[O],props:_,render:function(a){var i=this.tag,o=this.uniqueKey;return a(i,{key:o,attrs:{role:o}},this.$slots.default)}}),x={ITEM:"item_resize",SLOT:"slot_resize"},w={HEADER:"thead",FOOTER:"tfoot"},E=s.component("virtual-list",{props:B,data:function(){return{range:null}},watch:{"dataSources.length":function(){this.virtual.updateParam("uniqueIds",this.getUniqueIdFromDataSources()),this.virtual.handleDataSourcesChange()},keeps:function(a){this.virtual.updateParam("keeps",a),this.virtual.handleSlotSizeChange()},start:function(a){this.scrollToIndex(a)},offset:function(a){this.scrollToOffset(a)}},created:function(){this.isHorizontal=this.direction==="horizontal",this.directionKey=this.isHorizontal?"scrollLeft":"scrollTop",this.installVirtual(),this.$on(x.ITEM,this.onItemResized),(this.$slots.header||this.$slots.footer)&&this.$on(x.SLOT,this.onSlotResized)},activated:function(){this.scrollToOffset(this.virtual.offset),this.pageMode&&document.addEventListener("scroll",this.onScroll,{passive:!1})},deactivated:function(){this.pageMode&&document.removeEventListener("scroll",this.onScroll)},mounted:function(){this.start?this.scrollToIndex(this.start):this.offset&&this.scrollToOffset(this.offset),this.pageMode&&(this.updatePageModeFront(),document.addEventListener("scroll",this.onScroll,{passive:!1}))},beforeDestroy:function(){this.virtual.destroy(),this.pageMode&&document.removeEventListener("scroll",this.onScroll)},methods:{getSize:function(a){return this.virtual.sizes.get(a)},getSizes:function(){return this.virtual.sizes.size},getOffset:function(){if(this.pageMode)return document.documentElement[this.directionKey]||document.body[this.directionKey];var a=this.$refs.root;return a?Math.ceil(a[this.directionKey]):0},getClientSize:function(){var a=this.isHorizontal?"clientWidth":"clientHeight";if(this.pageMode)return document.documentElement[a]||document.body[a];var i=this.$refs.root;return i?Math.ceil(i[a]):0},getScrollSize:function(){var a=this.isHorizontal?"scrollWidth":"scrollHeight";if(this.pageMode)return document.documentElement[a]||document.body[a];var i=this.$refs.root;return i?Math.ceil(i[a]):0},scrollToOffset:function(a){if(this.pageMode)document.body[this.directionKey]=a,document.documentElement[this.directionKey]=a;else{var i=this.$refs.root;i&&(i[this.directionKey]=a)}},scrollToIndex:function(a){if(a>=this.dataSources.length-1)this.scrollToBottom();else{var i=this.virtual.getOffset(a);this.scrollToOffset(i)}},scrollToBottom:function(){var a=this,i=this.$refs.shepherd;if(i){var o=i[this.isHorizontal?"offsetLeft":"offsetTop"];this.scrollToOffset(o),setTimeout(function(){a.getOffset()+a.getClientSize()+1<a.getScrollSize()&&a.scrollToBottom()},3)}},updatePageModeFront:function(){var a=this.$refs.root;if(a){var i=a.getBoundingClientRect(),o=a.ownerDocument.defaultView,p=this.isHorizontal?i.left+o.pageXOffset:i.top+o.pageYOffset;this.virtual.updateParam("slotHeaderSize",p)}},reset:function(){this.virtual.destroy(),this.scrollToOffset(0),this.installVirtual()},installVirtual:function(){this.virtual=new H({slotHeaderSize:0,slotFooterSize:0,keeps:this.keeps,estimateSize:this.estimateSize,buffer:Math.round(this.keeps/3),uniqueIds:this.getUniqueIdFromDataSources()},this.onRangeChanged),this.range=this.virtual.getRange()},getUniqueIdFromDataSources:function(){var a=this.dataKey;return this.dataSources.map(function(i){return typeof a=="function"?a(i):i[a]})},onItemResized:function(a,i){this.virtual.saveSize(a,i),this.$emit("resized",a,i)},onSlotResized:function(a,i,o){a===w.HEADER?this.virtual.updateParam("slotHeaderSize",i):a===w.FOOTER&&this.virtual.updateParam("slotFooterSize",i),o&&this.virtual.handleSlotSizeChange()},onRangeChanged:function(a){this.range=a},onScroll:function(a){var i=this.getOffset(),o=this.getClientSize(),p=this.getScrollSize();i<0||i+o>p+1||!p||(this.virtual.handleScroll(i),this.emitEvent(i,o,p,a))},emitEvent:function(a,i,o,p){this.$emit("scroll",p,this.virtual.getRange()),this.virtual.isFront()&&this.dataSources.length&&a-this.topThreshold<=0?this.$emit("totop"):this.virtual.isBehind()&&a+i+this.bottomThreshold>=o&&this.$emit("tobottom")},getRenderSlots:function(a){for(var i=[],o=this.range,p=o.start,S=o.end,L=this.dataSources,D=this.dataKey,P=this.itemClass,N=this.itemTag,X=this.itemStyle,A=this.isHorizontal,$=this.extraProps,G=this.dataComponent,V=this.itemScopedSlots,U=this.$scopedSlots&&this.$scopedSlots.item,z=p;z<=S;z++){var j=L[z];if(j){var q=typeof D=="function"?D(j):j[D];typeof q=="string"||typeof q=="number"?i.push(a(g,{props:{index:z,tag:N,event:x.ITEM,horizontal:A,uniqueKey:q,source:j,extraProps:$,component:G,slotComponent:U,scopedSlots:V},style:X,class:"".concat(P).concat(this.itemClassAdd?" "+this.itemClassAdd(z):"")})):console.warn("Cannot get the data-key '".concat(D,"' from data-sources."))}else console.warn("Cannot get the index '".concat(z,"' from data-sources."))}return i}},render:function(a){var i=this.$slots,o=i.header,p=i.footer,S=this.range,L=S.padFront,D=S.padBehind,P=this.isHorizontal,N=this.pageMode,X=this.rootTag,A=this.wrapTag,$=this.wrapClass,G=this.wrapStyle,V=this.headerTag,U=this.headerClass,z=this.headerStyle,j=this.footerTag,q=this.footerClass,dt=this.footerStyle,tt={padding:P?"0px ".concat(D,"px 0px ").concat(L,"px"):"".concat(L,"px 0px ").concat(D,"px")},ut=G?Object.assign({},G,tt):tt;return a(X,{ref:"root",on:{"&scroll":!N&&this.onScroll}},[o?a(k,{class:U,style:z,props:{tag:V,event:x.SLOT,uniqueKey:w.HEADER}},o):null,a(A,{class:$,attrs:{role:"group"},style:ut},this.getRenderSlots(a)),p?a(k,{class:q,style:dt,props:{tag:j,event:x.SLOT,uniqueKey:w.FOOTER}},p):null,a("div",{ref:"shepherd",style:{width:P?"0px":"100%",height:P?"100%":"0px"}})])}});return E})})(ht);var te=ht.exports;const ee=gt(te),se=W({name:"RouteDropdown",components:{RouteDropDown:K,VirtualList:ee},props:{highlightedTransitLines:{type:Array,required:!0},listProps:{type:Object,required:!0}},data(){return{listComponent:K}},watch:{"listProps.activeTransitLines"(){}},computed:{visibleLines(){return this.highlightedTransitLines.map((e,t)=>(e.offset=t,e)).filter(e=>e.show)}}});var ie=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("virtual-list",{staticClass:"my-list",attrs:{"data-sources":t.visibleLines,"data-key":"id","data-component":t.listComponent,keeps:48,"estimate-size":48,"extra-props":t.listProps}})},re=[],ae=Y(se,ie,re,!1,null,"b40e4d1c");const ne=ae.exports,oe="/assets/icon-pie-chart-BS7BHQ_l.png",le="/assets/icon-blue-ramp-D1d4h-6x.png",ce={messages:{en:{metrics:"Metrics",viewer:"Transit Network"},de:{metrics:"Metrics",viewer:"ÖV Netzwerk"}}},he="EPSG:31468",de=10,lt=[{match:{gtfsRouteType:[3,700,701,702,703,704]},color:"#95276E",label:"Bus (GTFS)"},{match:{gtfsRouteType:[109]},color:"#408335",label:"S-Bahn (GTFS)"},{match:{gtfsRouteType:[401,402]},color:"#115D91",label:"U-Bahn (GTFS)"},{match:{gtfsRouteType:[0,3,900,901,902,903,904,905,906]},color:"#BE1414",label:"Tram (GTFS)"},{match:{gtfsRouteType:[4,1e3,1200]},color:"#0480c1",label:"Ferry (GTFS)"},{match:{transportMode:["rail","subway"],id:"U*"},color:"#115D91",label:"U-Bahn"},{match:{transportMode:"rail",id:"S*"},color:"#408335",label:"S-Bahn"},{match:{transportMode:"ferry"},color:"#0480c1",label:"Ferry"},{match:{transportMode:"tram"},color:"#9E1444",label:"Tram"},{match:{transportMode:"pt"},color:"#05c",label:"Public Transport"},{match:{transportMode:"rail"},color:"#EC0016 ",label:"Train"},{match:{transportMode:"train"},color:"#0a0",label:"Rail"},{match:{transportMode:"bus"},color:"#95276E",label:"Bus"},{match:{id:"**"},color:"#aae",label:"Other"}],ue=W({name:"TransitViewer",i18n:ce,components:{CollapsiblePanel:wt,DrawingTool:Dt,LeftDataPanel:Nt,LegendBox:Vt,RouteDropDown:K,TransitLayers:qt,ZoomButtons:Ot,LazyList:ne},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:{type:Object},thumbnail:Boolean,datamanager:{type:Object}},data(){const e=[{field:"departures",name_en:"Departures",name_de:"Abfahrten"}];return{viewId:Math.floor(1e12*Math.random()),icons:{piechart:oe,blueramp:le},loadProgress:0,loadSteps:0,totalLoadSteps:7,searchText:"",isDraggingDivider:0,dragStartWidth:250,legendSectionWidth:275,stopHTML:{html:"",x:0,y:0},buttonColors:["#5E8AAE","#BF7230","#269367","#9C439C"],metrics:e,activeMetric:e[0].field,activeRoutes:[],checkedTransitLines:[],vizDetails:{transitSchedule:"",network:"",demand:"",projection:"",title:"",description:"",colors:[]},myDataManager:this.datamanager||new Rt(this.root,this.subfolder),debounceHandleSearchText:{},myState:{subfolder:"",yamlConfig:"",thumbnail:!0},avroNetwork:null,isDarkMode:R.state.isDarkMode,isMapMoving:!1,isHighlightingLink:!1,loadingText:"MATSim Transit Inspector",projection:he,routesOnLink:[],selectedLinkId:"",selectedRouteIds:[],selectedTransitLine:"",selectedFeatures:[],summaryStats:{departures:0,pax:0,loadfac:0},stopMarkers:[],_departures:{},_mapExtentXYXY:null,_maximum:-1/0,_network:{},transitLinks:{type:"FeatureCollection",features:[]},transitLinkOffset:{},routeData:{},_stopFacilities:{},transitLines:[],highlightedTransitLineIds:new Set,_roadFetcher:{},_transitFetcher:{},_transitHelper:{},pieSlider:30,widthSlider:50,resolvers:{},resolverId:0,xmlWorker:null,cfDemand1:null,cfDemand2:null,cfDemandLink1:null,cfDemandLink2:null,cfDemandStop1:null,cfDemandStop2:null,stopLevelDemand:{},routeColors:[],usedLabels:[],listComponent:K}},computed:{fileApi(){return new vt(this.fileSystem,R)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},routeListProps(){return{activeTransitLines:this.activeTransitLines,selectedRoutes:this.selectedRouteIds,searchTerm:this.searchTermClean,color:"#06f",cbToggleLineChecked:this.toggleLineChecked,cbToggleLineOpen:this.toggleLineOpen,cbToggleRouteChecked:this.toggleRouteChecked}},searchTermClean(){return this.searchText.trim().toLocaleLowerCase()},highlightedTransitLines(){const e=!this.highlightedTransitLineIds.size;return this.transitLines.forEach(t=>{t.show=e||this.highlightedTransitLineIds.has(t.id)}),[...this.transitLines]},activeTransitLines(){const e={};if(this.routesOnLink.forEach(r=>{r.lineId in e||(e[r.lineId]={id:r.lineId,routes:[],isOpen:!1,stats:{departures:0,pax:0,cap:0}}),e[r.lineId].routes.push(r)}),!this.selectedLinkId)return e;const t={};this.cfDemandStop1?.filterAll(),this.cfDemandStop2?.filterAll(),this.cfDemandLink1?.filter(r=>r.indexOf(this.selectedLinkId)>-1);let s=this.cfDemand1?.allFiltered();return s&&s.forEach(r=>{r.transitRoute in t||(t[r.transitRoute]=[]),t[r.transitRoute].push(r)}),this.cfDemandLink2?.filter(r=>r.indexOf(this.selectedLinkId)>-1),s=this.cfDemand2?.allFiltered(),s&&s.forEach(r=>{r.transitRoute in t||(t[r.transitRoute]=[]),t[r.transitRoute].push(r)}),Object.values(e).forEach(r=>{r.routes.sort((l,h)=>st(l.id,h.id)),r.routes.forEach(l=>{l.pax=0,l.cap=0,r.stats.departures+=l.departures;const h=t[l.id];if(h){const u=h.reduce((d,f)=>d+f.passengersAtArrival,0);r.stats.pax+=u,l.pax+=u;const c=h.reduce((d,f)=>d+f.totalVehicleCapacity,0);r.stats.cap+=c,l.cap+=c}l.loadfac=l.pax/l.cap})}),e},legendRows(){return this.routeColors.filter(e=>this.usedLabels.includes(e.label)).map(e=>[e.color,e.label])}},watch:{"$store.state.viewState"(){Z[this.viewId]&&Z[this.viewId]()},"$store.state.colorScheme"(){this.isDarkMode=this.$store.state.colorScheme===yt.DarkMode,this.highlightAllAttachedRoutes()},selectedRouteIds(){this.showTransitRoutes(),this.showTransitStops(),this.updateSummaryStats()},searchText(){this.debounceHandleSearchText()}},methods:{clickedLegend(e){console.log("boop!",e)},toggleRouteChecked(e){e.isChecked?this.routesOnLink.push(this.routeData[e.route]):this.routesOnLink=this.routesOnLink.filter(t=>t.id!==e.route),this.routesOnLink.length?this.highlightAllAttachedRoutes():(this.selectedLinkId="",this.resetLinkColors(),this.highlightedTransitLineIds=new Set,this.transitLinks={...this.transitLinks}),this.selectedRouteIds=this.routesOnLink.map(t=>t.id)},toggleLineOpen(e){const t=this.transitLines[e.offset];t.isOpen=e.isOpen},toggleLineChecked(e){const t=this.transitLines[e.offset],s=t.id.toLocaleLowerCase();t.check=e.isChecked;const r=Object.values(this.routeData).filter(l=>l.lineId.toLocaleLowerCase()==s);if(t.check)r.forEach(l=>{this.selectedRouteIds.includes(l.id)||this.routesOnLink.push(l)}),this.selectedTransitLine=t.id;else{const l=r.map(h=>h.id);this.routesOnLink=this.routesOnLink.filter(h=>!l.includes(h.id))}this.selectedRouteIds=this.routesOnLink.map(l=>l.id),this.routesOnLink.length?this.highlightAllAttachedRoutes():(this.selectedLinkId="",this.resetLinkColors(),this.highlightedTransitLineIds=new Set,this.transitLinks={...this.transitLinks})},updateSummaryStats(){this.summaryStats={departures:0,pax:0,loadfac:0};for(const e of this.selectedRouteIds){const t=this.routeData[e];t.departures&&(this.summaryStats.departures+=t.departures),t.pax&&(this.summaryStats.pax+=t.pax)}},handleMapClick(e){if(e.index>-1&&e.layer?.id==="linkLayer")this.clickedOnTransitLink(e.index);else{if(e.index>-1)return;this.handleEmptyClick(!0,!1)}},incrementLoadProgress(){this.loadSteps+=1,this.loadProgress=100*this.loadSteps/this.totalLoadSteps},handleSearchText(){this.handleEmptyClick(null,!0),this.selectedLinkId="";const e=this.searchText.trim().toLocaleLowerCase();if(!e){this.resetLinkColors();return}let t=Object.keys(this.routeData).filter(r=>r.toLocaleLowerCase().indexOf(e)>-1);this.routesOnLink=t.map(r=>this.routeData[r]),this.highlightAllAttachedRoutes();const s=this.transitLines.filter(r=>r.id.toLocaleLowerCase().indexOf(e)>-1).map(r=>r.id);this.highlightedTransitLineIds=new Set(s),this.selectedRouteIds=this.routesOnLink.map(r=>r.id)},hoverOverStop(e,t){this.stopHTML.html="";const s=[];e.name&&s.push(`<b>${e.name}</b>`);for(const r of["id","linkRefId"])e[r]&&s.push(`${r}: ${e[r]}`);this.stopHTML.html="<p>"+s.join("<br/>")+"</p>",this.stopHTML.x=e.xy.x+8,this.stopHTML.y=e.xy.y-36},dividerDragStart(e){console.log("dragstart"),this.isDraggingDivider=e.clientX,this.dragStartWidth=this.legendSectionWidth},dividerDragEnd(e){this.isDraggingDivider=0},dividerDragging(e){if(!this.isDraggingDivider)return;const t=this.isDraggingDivider-e.clientX;this.legendSectionWidth=Math.max(0,this.dragStartWidth+t)},async getVizDetails(){if(this.config)return this.vizDetails=Object.assign({},this.config),!0;if(this.myState.yamlConfig?.endsWith("yaml")||this.myState.yamlConfig?.endsWith("yml"))return this.loadYamlConfig();const e=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("transitSchedule"));return this.vizDetails={transitSchedule:this.myState.yamlConfig,network:"",title:e,description:"",demand:"",projection:"",colors:[]},this.$emit("title",e),!0},async findInputFiles(){const{files:e}=await this.fileApi.getDirectory(this.myState.subfolder);let t=this.vizDetails.network;if(!t){const r=e.filter(l=>l.toLocaleLowerCase().endsWith(".avro")).filter(l=>l.toLocaleLowerCase().indexOf("network")>-1);r.length&&(console.log("avro network found"),t=r[0]),r.length>1&&console.warn("MULTIPLE Avro files found - using first of ",r)}if(t||(t=this.myState.yamlConfig.replaceAll("transitSchedule","network")),e.indexOf(t)==-1){const r=e.filter(l=>l.endsWith("network.xml.gz"));r.length?t=r[0]:(this.loadingText="No road network found.",t="")}let s=[];if(this.myState.yamlConfig.indexOf("output_transitSchedule")>-1)try{s=(await this.fileApi.getDirectory(`${this.myState.subfolder}/analysis/pt/`)).files.filter(l=>l.endsWith("pt_pax_volumes.csv.gz"))}catch(r){console.warn("error",""+r)}this.vizDetails.network=t,s.length&&(this.vizDetails.demand=`analysis/pt/${s[0]}`)},async guessProjection(e){if(this.vizDetails.projection)return this.vizDetails.projection;if(this.config?.projection)return this.config.projection;if(e?.roadXML?.crs)return e?.roadXML?.crs;if(e?.roadXML?.network?.attributes?.attribute?.name==="coordinateReferenceSystem")return e?.roadXML?.network?.attributes?.attribute["#text"];const t=`${this.root}/${this.subfolder}`,s=/EPSG:.\d/,{files:r}=await this.fileApi.getDirectory(this.myState.subfolder),l=r.filter(c=>c.indexOf(".output_config.xml")>-1||c.indexOf(".output_config_reduced.xml")>-1);if(l.length&&this.fileSystem)for(const c of l)try{return(await this.fetchXML({worker:null,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+c})).config.module.filter(b=>b.$name==="global")[0].param.filter(b=>b.$name==="coordinateSystem")[0].$value}catch{console.warn("Failed parsing",c)}let h=prompt("Need coordinate EPSG number:","")||"";if(!h)return"";if(Number.isNaN(parseInt(h,10))&&!s.test(h))return this.guessProjection(e);h.startsWith("EPSG:")||(h="EPSG:"+h);const u=h;return localStorage.setItem(t,JSON.stringify({networkProjection:u})),u},async loadYamlConfig(){const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig;try{const s=await this.fileApi.getFileText(e);this.vizDetails=xt.parse(s)}catch(s){const r=s;if(this.fileSystem&&this.fileSystem.needPassword&&r.status===401)this.$store.commit("requestLogin",this.fileSystem.slug);else{const l="Could not load "+e;this.$emit("error",l),this.loadingText=l}return!1}const t=this.vizDetails.title?this.vizDetails.title:"Transit Ridership";return this.$emit("title",t),this.projection=this.vizDetails.projection,!0},isMobile(){const e=window,t=document,s=t.documentElement,r=t.getElementsByTagName("body")[0],l=e.innerWidth||s.clientWidth||r.clientWidth;return e.innerHeight||s.clientHeight||r.clientHeight,l<640},drawMetric(){this.transitLinks.features.forEach(e=>{let t=1;switch(this.activeMetric){case"departures":t=e.properties.departures*.025;break;case"pax":t=e.properties.pax*15e-5;break;case"loadfac":t=e.properties.loadfac*25;break}e.properties.width=t}),this.transitLinks={...this.transitLinks}},handleClickedMetric(e){console.log("metric:",e.field),this.activeMetric=e.field,this.drawMetric()},handleEmptyClick(e,t){if(!e&&this.isHighlightingLink){this.isHighlightingLink=!1;return}this.isHighlightingLink=!1,this.highlightedTransitLineIds=new Set,t||(this.searchText=""),!(this.searchText&&!t)&&(this.removeStopMarkers(),this.removeSelectedRoute(),this.resetLinkColors(),this.routesOnLink=[],this.stopHTML.html="",this.summaryStats={departures:0,pax:0,loadfac:0},this.transitLinks={...this.transitLinks})},async loadEverything(){const e=await this.loadNetworks(),t=await this.guessProjection(e);this.vizDetails.projection=t,this.projection=this.vizDetails.projection,e&&this.processInputs(e),console.log(e)},setupKeyListeners(){window.addEventListener("keyup",e=>{e.keyCode===27&&this.pressedEscape()}),window.addEventListener("keydown",e=>{e.keyCode===38&&this.pressedArrowKey(-1),e.keyCode===40&&this.pressedArrowKey(1)})},fetchXML(e){let t=e.worker;t.onmessage=l=>{const{resolve:h,reject:u}=this.resolvers[l.data.id];t.terminate(),l.data.error&&u(l.data.error),h(l.data.xml)};const s=this.resolverId++;return t.postMessage({id:s,fileSystem:this.fileSystem,filePath:e.filePath,options:e.options}),new Promise((l,h)=>{this.resolvers[s]={resolve:l,reject:h}})},async updateStatus(e){this.loadingText=e},async loadAvroRoadNetwork(){console.log("LOADING AVRO:",this.vizDetails.network);const e=`${this.subfolder}/${this.vizDetails.network}`,t=await this.fileApi.getFileBlob(e),s=await new Promise((r,l)=>{const h=[];Lt.createBlobDecoder(t).on("metadata",u=>{}).on("data",u=>{h.push(u)}).on("end",()=>{r(h)})});return this.avroNetwork=s[0],s[0]},async loadNetworks(){try{if(!this.fileSystem||!this.vizDetails.network||!this.vizDetails.transitSchedule)return;this.loadingText="Loading networks...",this.incrementLoadProgress();const t=this.vizDetails.network.indexOf(".avro")>-1?this.loadAvroRoadNetwork():this.fetchXML({worker:this._roadFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+this.vizDetails.network,options:{attributeNamePrefix:""}}),s=this.fetchXML({worker:this._transitFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+this.vizDetails.transitSchedule,options:{attributeNamePrefix:"",alwaysArray:["transitSchedule.transitLine.transitRoute","transitSchedule.transitLine.transitRoute.departures.departure"]}}),r=await Promise.all([t,s]);return{roadXML:r[0],transitXML:r[1],ridership:[]}}catch(e){return console.error("TRANSIT:",e),this.loadingText,this.$emit("error",""+e),null}},loadDemandData(e){return this.totalLoadSteps+=3,this.loadingText="Loading demand...",new Promise((s,r)=>{e||s([]),this.incrementLoadProgress();const l=new At;l.onmessage=h=>{if(this.loadingText="Processing demand...",this.incrementLoadProgress(),l.terminate(),h.data.error){this.$emit("error",h.data.error),this.loadingText="";return}const u=new TextDecoder("utf-8").decode(h.data);Tt.parse(u,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,worker:!0,complete:c=>{const d=this.processDemand(c);s(d)}})},l.postMessage({filePath:this.myState.subfolder+"/"+e,fileSystem:this.fileSystem})})},processDemand(e){this.loadingText="Summarizing demand data...",this.incrementLoadProgress();const t=["passengersAlighting","passengersAtArrival","passengersBoarding","stopSequence","totalVehicleCapacity"];e.data.forEach(c=>{for(const d of t)c[d]=parseFloat(c[d])});const s=Math.floor(e.data.length/2),r=e.data.slice(0,s),l=e.data.slice(s);this.cfDemand1=rt(r),this.cfDemand2=rt(l),this.cfDemandLink1=this.cfDemand1.dimension(c=>c.linkIdsSincePreviousStop),this.cfDemandLink2=this.cfDemand2.dimension(c=>c.linkIdsSincePreviousStop);for(const c of e.data){const d=c.stop;this.stopLevelDemand[d]||(this.stopLevelDemand[d]={b:0,a:0,ptLines:{}}),this.stopLevelDemand[d].b+=c.passengersBoarding,this.stopLevelDemand[d].a+=c.passengersAlighting;const f=c.transitLine;this.stopLevelDemand[d].ptLines[f]||(this.stopLevelDemand[d].ptLines[f]={name:f,b:0,a:0}),this.stopLevelDemand[d].ptLines[f].a+=c.passengersAlighting,this.stopLevelDemand[d].ptLines[f].b+=c.passengersBoarding}console.log("---Calculating link-by-link pax/cap");const h={},u={};for(const c of e.data)if(c.linkIdsSincePreviousStop){const d=c.linkIdsSincePreviousStop.split(";");for(const f of d)h[f]||(h[f]=0),h[f]+=c.passengersAtArrival,u[f]||(u[f]=0),u[f]+=c.totalVehicleCapacity}for(const c of this.transitLinks.features)c.properties||(c.properties={}),c.properties.pax=h[c.properties.id],c.properties.cap=u[c.properties.id],c.properties.loadfac=Math.round(1e3*h[c.properties.id]/u[c.properties.id])/1e3;return this.metrics=this.metrics.concat([{field:"pax",name_en:"Passengers",name_de:"Passagiere"},{field:"loadfac",name_en:"Load Factor",name_de:"Auslastung"}]),this.loadProgress=100,[]},async processInputs(e){this.loadingText="Examining networks...",this.incrementLoadProgress(),this._transitHelper=new ot,this._transitHelper.onmessage=t=>{this.receivedProcessedTransit(t)},this._transitHelper.postMessage({xml:e,projection:this.projection})},async receivedProcessedTransit(e){if(e.data.status){this.loadingText=e.data.status,this.incrementLoadProgress();return}if(e.data.error){console.error(e.data.error),this.$emit("error",""+e.data.error),this.loadingText="";return}const{network:t,routeData:s,stopFacilities:r,transitLines:l,mapExtent:h}=e.data;this._network=t,this.routeData=s,this._stopFacilities=r,this.transitLines=l,this._mapExtentXYXY=h,this._transitHelper.terminate(),this.loadingText="Summarizing departures...",this.incrementLoadProgress();const u=this.vizDetails.customRouteTypes||this.vizDetails.colors||null;u&&Array.isArray(u)&&u.length>0?this.routeColors=u:u&&!Array.isArray(u)?(this.$emit("error","YAML colors must be a list of rules, see docs"),this.routeColors=lt):this.routeColors=lt,await this.processDepartures(),this.transitLinks=await this.constructDepartureFrequencyGeoJson(),this._network={links:{},nodes:{}},this.transitLinkOffset={},this.transitLinks.features.forEach((v,b)=>{this.transitLinkOffset[v.properties.id]=b}),this.drawMetric(),this.handleClickedMetric({field:"departures"});const c=.5*(this._mapExtentXYXY[0]+this._mapExtentXYXY[2]),d=.5*(this._mapExtentXYXY[1]+this._mapExtentXYXY[3]),f=Math.abs(this._mapExtentXYXY[0]-this._mapExtentXYXY[2]),m=Math.floor(Math.log2(360/f));this.$store.commit("setMapCamera",{longitude:c,latitude:d,zoom:m,initial:!0}),localStorage.setItem(this.$route.fullPath+"-bounds",JSON.stringify(this._mapExtentXYXY)),this.vizDetails.demand&&await this.loadDemandData(this.vizDetails.demand),this.loadingText=""},async processDepartures(){this.loadingText="Processing departures...",this.incrementLoadProgress();for(const e of this.transitLines){e.transitRoutes.sort((t,s)=>st(t.id,s.id));for(const t of e.transitRoutes)for(const s of t.route)s in this._departures||(this._departures[s]={total:0,routes:new Set}),this._departures[s].total+=t.departures,this._departures[s].routes.add(t.id)}Object.values(this._departures).forEach(e=>this._maximum=Math.max(this._maximum,e.total))},async constructDepartureFrequencyGeoJson(){const e=[];this.usedLabels=[];const t=this.avroNetwork?.nodeCoordinates;for(const s in this._departures)if(this._departures.hasOwnProperty(s)){const r=this._network.links[s];if(r==null)continue;let l;try{if(this.avroNetwork){const m=2*this.avroNetwork.from[r],v=2*this.avroNetwork.to[r];l=[[t[m],t[1+m]],[t[v],t[1+v]]]}else l=[[this._network.nodes[r.from].x,this._network.nodes[r.from].y],[this._network.nodes[r.to].x,this._network.nodes[r.to].y]]}catch(m){console.warn(""+m);continue}const h=this._departures[s].total,c=[...this._departures[s].routes][0],{color:d,hideThisLine:f}=this.determineRouteColor(c);if(!f){let m={type:"Feature",geometry:{type:"LineString",coordinates:l},properties:{...this.$props,color:d,departures:h,id:s,from:r.from,to:r.to,currentColor:d}};m=this.offsetLineByMeters(m,5),e.push(m)}}return{type:"FeatureCollection",features:e}},determineRouteColor(e){let t="#888",s=!1;const r=this.routeData[e];for(const h of this.routeColors){s=!1,h.hide&&(s=!0);let u=!0,c=h.match;try{if(Array.isArray(c)){const d={};for(const f of c){const[m,v]=Object.entries(f)[0];d[m]=v}c=d}}catch{console.warn("Match rules malformed",c)}for(const[d,f]of Object.entries(c)){const m=r[d];if(!m){u=!1;break}if(d==="gtfsRouteType"){if(Array.isArray(f)){if(!f.includes(m)){u=!1;break}}else if(m!==f){u=!1;break}}else if(!St.isMatch(m,f)){u=!1;break}}if(u){t=h.color,!this.usedLabels.includes(h.label)&&!s&&this.usedLabels.push(h.label);break}}t=="#888"&&console.log("OHE NOES",e);const l=Array.isArray(t)?t:this.colorToRGB(t);return r.color=l,{color:l,hideThisLine:s}},colorToRGB(e){try{const t=ct(e);return t?[t.r,t.g,t.b]:[0,0,0]}catch{return[0,0,0]}},offsetLineByMeters(e,t){try{return kt(e,t,{units:"meters"})}catch{}return e},removeStopMarkers(){this.stopMarkers=[],this.stopHTML.html=""},XXtoggleTransitLine(e){e.isOpen=!e.isOpen,e.isOpen?(this.selectedTransitLine=e.id,this.selectAllRoutesInLine(e)):(this.selectedTransitLine="",this.removeStopMarkers(),this.removeSelectedRoute()),this.$forceUpdate()},selectAllRoutesInLine(e){const t=e.routes.map(s=>s.id);this.selectedRouteIds=t,this.showTransitRoutes(),this.showTransitStops()},showRouteDetails(e,t){if(t>1&&this.selectedRouteIds.length==t)this.selectedRouteIds=[e];else{const s=new Set(this.selectedRouteIds);s.has(e)?s.delete(e):s.add(e),this.selectedRouteIds=[...s]}this.showTransitRoutes(),this.showTransitStops()},showTransitStops(){const e={};this.selectedRouteIds.forEach(t=>{const s=this.routeData[t],r=s.routeProfile,l=r.length;let h;for(const[u,c]of r.entries()){const d=this._stopFacilities[c.refId],f=it([d.x,d.y]);if(u<l-1){const v=this._stopFacilities[s.routeProfile[u+1].refId],b=it([v.x,v.y]);h=bt(f,b)}const m={i:u,bearing:h,xy:[d.x,d.y],name:d.name||"",id:c.refId||"",linkRefId:d.linkRefId||""};if(this.stopLevelDemand){const v=this.stopLevelDemand[c.refId];v&&(m.boardings=v.b,m.alightings=v.a,m.ptLines=v.ptLines)}m.id in e?(e[m.id].boardings=m.boardings,e[m.id].alightings=m.alightings):e[m.id]=m}}),this.stopMarkers=Object.values(e)},showTransitRoutes(){this.stopHTML.html="";const e=[];this.selectedRouteIds.forEach(t=>{const s=this.routeData[t];e.push(s.geojson)}),this.selectedFeatures=e},removeSelectedRoute(){this.selectedFeatures=[],this.selectedRouteIds=[]},clickedOnTransitLink(e){this.isHighlightingLink=!0,this.removeStopMarkers(),this.removeSelectedRoute();const t=this.transitLinks.features[e].properties;this.selectedLinkId=t.id;const s=this._departures[t.id].routes;let r={departures:0,pax:0,loadfac:0};const l=this.transitLinks[this.transitLinkOffset[t.id]];this.summaryStats=l?l.properties:r;const h=[],u=new Set;for(const c of s){const d=this.routeData[c];d.color=t.color,d.currentColor=t.color,h.push(d),u.add(d.lineId)}this.routesOnLink=h,this.highlightAllAttachedRoutes(),this.selectedRouteIds=this.routesOnLink.map(c=>c.id),this.highlightedTransitLineIds=u},resetLinkColors(e){if(e)for(const t of this.transitLinks.features)t.properties.currentColor=e,t.properties.sort=0;else for(const t of this.transitLinks.features)t.properties.currentColor=t.properties.color,t.properties.sort=1},highlightAllAttachedRoutes(){if(this.transitLinks){if(this.routesOnLink.length){const e=this.colorToRGB(this.isDarkMode?"#333344":"#ccccdd");this.resetLinkColors(e)}else this.resetLinkColors();for(const e of this.routesOnLink)for(const t of e.route){const s=this.transitLinkOffset[t],r=this.transitLinks.features[s];r.properties.currentColor=e.color||r.properties.color,r.properties.sort=5}if(this.selectedLinkId){const e=this.transitLinks.features[this.transitLinkOffset[this.selectedLinkId]];e.properties.currentColor=this.colorToRGB("#f4f"),e.properties.sort=5}this.transitLinks={...this.transitLinks}}},pressedEscape(){console.log("ESC"),this.removeSelectedRoute(),this.removeStopMarkers(),this.resetLinkColors(),this.routesOnLink=[]},pressedArrowKey(e){},clearData(){this._departures={},this._mapExtentXYXY=[180,90,-180,-90],this._maximum=0,this._network={nodes:{},links:{}},this.routeData={},this._stopFacilities={},this.transitLinks={type:"FeatureCollection",features:[]},this.transitLines=[],this.selectedRouteIds=[],this.cfDemand1=null,this.cfDemand2=null,this.cfDemandLink1?.dispose(),this.cfDemandLink2?.dispose(),this.cfDemandStop1?.dispose(),this.cfDemandStop2?.dispose(),this.resolvers={},this.routesOnLink=[],this.stopMarkers=[],this.searchText=""}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.debounceHandleSearchText=_t.debounce(this.handleSearchText,350),this.clearData(),this._roadFetcher=new at,this._transitFetcher=new at,this._transitHelper=new ot,this.myState.subfolder=this.subfolder,this.myState.yamlConfig=this.yamlConfig??"",this.myState.thumbnail=this.thumbnail,await this.getVizDetails()&&(this.thumbnail||(await this.findInputFiles(),this.loadEverything()))},beforeDestroy(){this.clearData(),this.xmlWorker&&this.xmlWorker.terminate(),this._roadFetcher&&this._roadFetcher.terminate(),this._transitFetcher&&this._transitFetcher.terminate(),this._transitHelper&&this._transitHelper.terminate(),this.$store.commit("setFullScreen",!1)}});Ct({colormap:"viridis",nshades:de});var fe=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"transit-viz",class:{"hide-thumbnail":!t.thumbnail}},[t.thumbnail?t._e():s("div",{staticClass:"main-layout",on:{mousemove:t.dividerDragging,mouseup:t.dividerDragEnd}},[s("div",{staticClass:"dragger",on:{mousedown:t.dividerDragStart,mouseup:t.dividerDragEnd,mousemove:function(r){return r.stopPropagation(),t.dividerDragging.apply(null,arguments)}}}),s("div",{staticClass:"map-container",class:{"hide-thumbnail":!t.thumbnail},attrs:{oncontextmenu:"return false"}},[t.transitLinks?.features.length?s("transit-layers",{staticClass:"map-styles",attrs:{viewId:t.viewId,links:t.transitLinks,selectedFeatures:t.selectedFeatures,stopMarkers:t.stopMarkers,handleClickEvent:t.handleMapClick,pieSlider:t.pieSlider,widthSlider:t.widthSlider,transitLines:t.activeTransitLines}}):t._e(),t.transitLines.length?s("div",{staticClass:"width-sliders flex-row",style:{backgroundColor:t.isDarkMode?"#00000099":"#ffffffaa"}},[s("img",{staticClass:"icon-blue-ramp",attrs:{src:t.icons.blueramp}}),s("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!1,size:"is-small"},model:{value:t.widthSlider,callback:function(r){t.widthSlider=r},expression:"widthSlider"}}),t.cfDemand1?s("img",{staticClass:"icon-pie-slider",attrs:{src:t.icons.piechart}}):t._e(),t.cfDemand1?s("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!1,size:"is-small"},model:{value:t.pieSlider,callback:function(r){t.pieSlider=r},expression:"pieSlider"}}):t._e()],1):t._e(),s("zoom-buttons"),t.loadingText?s("div",{staticClass:"status-corner"},[s("p",[t._v(t._s(t.loadingText))]),t.loadProgress>0?s("b-progress",{staticClass:"load-progress",attrs:{value:t.loadProgress,rounded:!1,type:"is-success"}}):t._e()],1):t._e()],1),s("div",{staticClass:"right-panel-holder",style:{width:`${t.legendSectionWidth}px`}},[s("div",{staticClass:"right-side-column"},[t._m(0),t.metrics.length>1?s("div",{staticClass:"panel-item"},[s("div",{staticClass:"metric-buttons"},t._l(t.metrics,function(r,l){return s("button",{key:r.field,staticClass:"button is-small metric-button",style:{color:t.activeMetric===r.field?"white":t.buttonColors[l],border:`1px solid ${t.buttonColors[l]}`,"background-color":t.activeMetric===r.field?t.buttonColors[l]:t.isDarkMode?"#333":"white"},on:{click:function(h){return t.handleClickedMetric(r)}}},[t._v(t._s(t.$i18n.locale==="de"?r.name_de:r.name_en))])}),0)]):t._e(),t.transitLines.length?s("b-input",{staticClass:"searchbox",staticStyle:{padding:"0rem 0.5rem 0.75rem 0"},attrs:{size:"is-small",placeholder:"Search line ID..."},model:{value:t.searchText,callback:function(r){t.searchText=r},expression:"searchText"}}):t._e(),s("div",{staticClass:"transit-lines flex-col flex1"},[s("lazy-list",{staticClass:"flex1",attrs:{highlightedTransitLines:t.highlightedTransitLines,listProps:t.routeListProps}})],1),s("div",{staticClass:"summary-stats flex-col"},[t._m(1),s("p",{style:{visibility:t.selectedRouteIds.length?"visible":"hidden"}},[s("b",[t._v(t._s(t.selectedRouteIds.length))]),t._v("  selected route"+t._s(t.selectedRouteIds.length!=1?"s":""))]),s("div",{staticClass:"flex-row",style:{visibility:t.selectedRouteIds.length?"visible":"hidden",gap:"0.5rem"}},[s("div",{staticClass:"aa"},[s("b",[t._v(t._s(t.summaryStats.departures))]),t._v(" Departures")]),t.cfDemand1?s("div",{staticClass:"aa"},[s("b",[t._v(t._s(t.summaryStats.pax))]),t._v(" Passengers")]):t._e()])]),t.thumbnail?t._e():s("legend-box",{staticClass:"legend",attrs:{rows:t.legendRows},on:{click:t.clickedLegend}})],1)])])])},pe=[function(){var e=this,t=e._self._c;return e._self._setupProxy,t("p",{staticStyle:{"margin-top":"0.25rem"}},[t("b",[e._v("TRANSIT INSPECTOR")])])},function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"sum-stat-title"},[t("b",[e._v("SUMMARY STATISTICS")])])}],me=Y(ue,fe,pe,!1,null,"33aae7fd");const Ye=me.exports;export{Ye as default};
