import{r as x,g as H,R as V,j as T,M as pt,o as O,d as ut,H as dt,C as tt,n as gt}from"./index-D5-tbn2z.js";import{d as mt}from"./index-CiDs3pW_.js";import{Y as ft}from"./index-BbtBDwfe.js";import{c as bt}from"./index-TZSCE1Yb.js";import{P as Ct,C as vt}from"./LegendColors-CQgC8iXr.js";import{Z as Tt}from"./ZoomButtons-DPNPDnil.js";import{t as St,p as et,f as kt,g as $t}from"./util-CHADgdP7.js";import{W as wt}from"./RoadNetworkLoader.worker-Bt7-RMFX.js";import{a as yt}from"./avro-Dd9UqmeZ.js";import{D as Lt,S as Pt}from"./set-rtl-text-plugin-Bk__35WL.js";import{T as N,S as M}from"./text-layer-DXaVM5RI.js";import{P as G}from"./path-layer-CxDndZO_.js";import{A as R}from"./arc-layer-VmKOccQN.js";import"./layer-extension-n6Qv6sdI.js";import"./fxp-4YEvQr-_.js";import"./extends-CCbyfPlC.js";import"./cut-by-mercator-bounds-DcbBq5m8.js";const E={pickup:[0,150,255],delivery:[240,0,60],service:[255,64,255]};var j=[];function Ht(s){const[t,i]=x.useState(H.state.viewState),[e,r]=x.useState({}),[n,o]=x.useState({type:"activity",pickups:[],deliveries:[]});var{dark:l,activeTab:c,numSelectedTours:d,lspShipmentChains:b,shipments:h,legs:k,settings:$,stopActivities:A,onClick:X,projection:U}=s;const{simplifyTours:B,scaleFactor:w,scaleFactorShipments:D,shipmentDotsOnTourMap:J,selectedTour:Y,showEachCarrierTour:_}=$;let z=w==0?1e-6:1/Math.pow(2,(100-w)/5-6),st=D==0?1e-6:1/Math.pow(2,(100-D)/5-6);var[P,q]=x.useState([]);const Z=x.useRef(b);V[s.viewId]=()=>{i(H.state.viewState)},x.useEffect(()=>{const p={},g={};h.forEach(m=>{let a=`${m.fromX}-${m.fromY}`;p[a]||(p[a]={type:"pickup",shipmentIds:[],coord:[m.fromX,m.fromY]}),p[a].shipmentIds.push(m.$id),a=`${m.toX}-${m.toY}`,g[a]||(g[a]={type:"delivery",shipmentIds:[],coord:[m.toX,m.toY]}),g[a].shipmentIds.push(m.$id)}),o({type:"activity",pickups:Object.values(p),deliveries:Object.values(g)})},[h]);function it(p){p.object?X(p.object):X(null)}function rt(p){i(p),p.center=[p.longitude,p.latitude],H.commit("setMapCamera",p)}function nt(p){const{object:g}=p;if(!g)return null;if(g?.type=="pickup")return K(p,"pickup");if(g?.type=="delivery")return K(p,"delivery");if(g?.type=="leg")return lt(p);if(g?.color)return ot(p);if(g?.label=="Depot"||g?.locationX&&g?.locationY)return at(p);if(g?.tour)return ht(p)}function K(p,g){const{object:m,x:a,y:v}=p;return T.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:a+20,top:v+20}},T.createElement("table",{style:{maxWidth:"30rem",fontSize:"0.8rem"}},T.createElement("tbody",null,T.createElement("tr",null,T.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},g,":"),T.createElement("td",{style:{paddingTop:"0.2rem"}},m.shipmentIds.join(", "))))))}function ot(p){const{object:g,x:m,y:a}=p;return console.log(g),p.layer.id=="HubChain"?T.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:m+20,top:a-30}}):T.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:m+20,top:a-30}},"Shipment Id: ",g.shipmentId," ",T.createElement("br",null))}function lt(p){const{object:g,x:m,y:a}=p;return T.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:m+20,top:a-30}},"Vehicle Id: ",g?.tour.vehicleId," ",T.createElement("br",null),"Tour Id: ",g?.tour.tourId," ",T.createElement("br",null))}function at(p){const{object:g,x:m,y:a}=p;let v=j.find(S=>S.hubId===g?.id);return T.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:m+20,top:a-30}},"Hub Id: ",v?.hubId," ",T.createElement("br",null),"Total Shipments: ",v?.shipmentTotal," ",T.createElement("br",null))}function ht(p){const{object:g,x:m,y:a}=p,v=g.visits.length,S=g.visits.reduce((L,F)=>L+F.pickup.length,0),f=g.visits.reduce((L,F)=>L+F.delivery.length,0),y=g.visits.reduce((L,F)=>L+F.service.length,0),u=S+f,C={visits:v,pickups:S,deliveries:f,services:y},W=Object.keys(g).length*20+32;let I=a-30;return I+W>window.innerHeight&&(I=a-W),T.createElement("div",{className:"tooltip",style:{fontSize:"0.7rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:m+20,top:I}},T.createElement("table",{style:{fontSize:"0.8rem"}},T.createElement("tbody",null,Object.keys(C).map(L=>T.createElement("tr",{key:L},T.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem"}},L,":"),T.createElement("td",{style:{fontWeight:"bold"}}," ",C[L]))),u==1&&Object.keys(g.details).map(L=>T.createElement("tr",{key:L},T.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},L.slice(1),":"),T.createElement("td",{style:{paddingTop:"0.2rem"}},g.details[L]))))))}if(c=="lspTours"){let p=function(a){let v=0;for(let u=0;u<a.length;u++)v=a.charCodeAt(u)+((v<<5)-v);const S=(v&16711680)>>16,f=(v&65280)>>8,y=v&255;return[S,f,y]},g=function(a){let v=0;for(let u=0;u<a.tour.tourId.length;u++)v=a.tour.tourId.charCodeAt(u)+((v<<5)-v);v*=a.tour.tourNumber;const S=(v%360+360)%360;return m(S,70,50)},m=function(a,v,S){v/=100,S/=100;const f=C=>(C+a/30)%12,y=v*Math.min(S,1-S),u=C=>S-y*Math.max(-1,Math.min(f(C)-3,Math.min(9-f(C),1)));return[Math.round(u(0)*255),Math.round(u(8)*255),Math.round(u(4)*255)]};P=[],s.showHub===!0&&s.hubLocation.length>0?P.push(new N({id:"pickupsHubChain",data:s.hubLocation,getPosition:[s.hubLocation[0],s.hubLocation[1]],getText:()=>s.hubName,getRadius:2,opacity:.9,background:!0,backgroundPadding:d!==1?[2,1,2,1]:[3,2,3,1],getBackgroundColor:()=>[240,130,0],getColor:[255,255,255],parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",getSize:a=>11,getTextAnchor:"middle",getAlignmentBaseline:"center",noAlloc:!1,billboard:!0,sizeScale:1,autoHighlight:!0,onHover:r})):(P.push(new G({id:"shipmentLocationDashedLine",data:A,getPath:a=>[a.ptFrom,a.ptTo],getColor:[128,128,128],getOffset:2,opacity:1,widthMinPixels:3,jointRounded:!0,shadowEnabled:!1,pickable:!1,autoHighlight:!1,highlightColor:[255,255,255],parameters:{depthTest:!1},getDashArray:[3,2],dashJustified:!0,extensions:[new Ct({dash:!0})]})),!_&&B?P.push(new R({id:"leg-arcs",data:k,getSourcePosition:a=>a.points[0],getTargetPosition:a=>a.points[a.points.length-1],getSourceColor:a=>p(a.tour.vehicleId),getTargetColor:a=>p(a.tour.vehicleId),getWidth:w?a=>a.totalSize/2:3,getHeight:.5,widthMinPixels:2,widthMaxPixels:200,widthUnits:"pixels",opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[w]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:r})):_&&!B?P.push(new G({id:"deliveryroutes2",data:k,getPath:a=>a.points,getColor:a=>g(a),getWidth:w?a=>a.totalSize:3,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:200,widthUnits:"pixels",jointRounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:r,parameters:{depthTest:!1},updateTriggers:{getWidth:[w]},transitions:{getWidth:150}})):B&&_?P.push(new R({id:"leg-arcs-showAll",data:k,getSourcePosition:a=>a.points[0],getTargetPosition:a=>a.points[a.points.length-1],getSourceColor:a=>g(a),getTargetColor:a=>g(a),getWidth:w?a=>a.totalSize/2:3,getHeight:.5,widthMinPixels:2,widthMaxPixels:200,widthUnits:"pixels",opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[w]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:r})):P.push(new G({id:"deliveryroutes1",data:k,getPath:a=>a.points,getColor:a=>p(a.tour.vehicleId),getWidth:w?a=>a.totalSize:3,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:200,widthUnits:"pixels",jointRounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:r,parameters:{depthTest:!1},updateTriggers:{getWidth:[w]},transitions:{getWidth:150}})),P.push(new N({id:"dest-labels",data:A,background:!0,backgroundPadding:d!==1?[2,1,2,1]:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:a=>{const v=a.visits.reduce((y,u)=>y+u.pickup.length,0),S=a.visits.reduce((y,u)=>y+u.delivery.length,0),f=a.visits.reduce((y,u)=>y+u.service.length,0);return v&&S&&!a.depot?[0,0,255]:v&&!a.depot?E.pickup:S&&!a.depot||f&&!a.depot?E.delivery:a.depot?[240,130,0]:[240,130,0]},getPosition:a=>a.midpoint,getText:a=>a.label=="Hub"?a.label:d!==1?" ":`${a.label}`,getSize:a=>a.label=="Hub"?11:d!==1?4:11,getTextAnchor:"middle",getAlignmentBaseline:"center",opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:r,visible:J})),P.push(new N({id:"HubChain",data:s.tourHubs,getPosition:a=>[a.Xcoord,a.Ycoord],getText:a=>a.hubId,getAlignmentBaseline:"center",getColor:[255,255,255],getBackgroundColor:[240,130,0],background:!0,backgroundPadding:[2,2,2,2],fontWeight:"normal",getSize:10,getTextAnchor:"middle",pickable:!0,onHover:r})))}function Q(p){p.push(new M({id:"deliveries",data:n.deliveries,getPosition:m=>m.coord,getFillColor:E.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:r})),p.push(new M({id:"pickups",data:n.pickups,getPosition:m=>m.coord,getFillColor:E.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:r}));const g=h.length>1?32:255;p.push(new R({id:"shipments",data:h,getSourcePosition:m=>[m.fromX,m.fromY],getTargetPosition:m=>[m.toX,m.toY],getSourceColor:[0,228,255,g],getTargetColor:[240,0,60,224],getWidth:D?m=>parseInt(m.$size)||1:1,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthScale:st,widthMinPixels:1,widthMaxPixels:100,updateTriggers:{getWidth:[D]},transitions:{getWidth:200}}))}if(c=="shipments"&&D===0&&Q(P),x.useEffect(()=>{const p=[];Q(p),q(p),Z.current=b},[$.scaleFactorShipments]),c==="lspShipmentChains"&&s.showHub&&s.hubLocation.length>0){let p=b;b=[],b=p,P.push(new N({id:"lspHubs2",data:s.hubLocation,getPosition:[s.hubLocation[0],s.hubLocation[1]],getText:()=>s.hubName,getRadius:2,opacity:.9,background:!0,backgroundPadding:d!==1?[2,1,2,1]:[3,2,3,1],getBackgroundColor:()=>[240,130,0],getColor:[255,255,255],parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",getSize:g=>11,getTextAnchor:"middle",getAlignmentBaseline:"center",noAlloc:!1,billboard:!0,sizeScale:1,autoHighlight:!0,onHover:r}))}x.useEffect(()=>{const p=[],g=h.length>1?32:255;function m(S,f){return S+1==Number(f.route.length-1)?1*(w/2):3*(w/2)}function a(S,f){return S+1==Number(f.route.length-1)?[0,228,255,g]:[255,140,0]}function v(S,f){return S+1==Number(f.route.length-1)?[240,0,60,224]:[255,140,0]}if(c=="lspShipmentChains"&&!s.showHub&&s.hubLocation.length==0){const S=h.length>1?32:255;if(b[0].hubsChains.length===0)p.push(new R({id:"shipmentdirectchains",data:b[0].directChains,getSourcePosition:f=>[f.fromX,f.fromY],getTargetPosition:f=>[f.toX,f.toY],getSourceColor:[0,228,255,S],getTargetColor:[240,0,60,224],getWidth:w?f=>parseInt(f.$size)||1:1,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthScale:z,widthMinPixels:1,widthMaxPixels:100,updateTriggers:{getWidth:[w]},transitions:{getWidth:200}})),p.push(new M({id:"deliveriesHubChain",data:b[0].directChains,getPosition:f=>[f.toX,f.toY],getColor:E.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:r})),p.push(new M({id:"pickupsHubChain",data:b[0].directChains,getPosition:f=>[f.fromX,f.fromY],getColor:E.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels"}));else{const f=b[0].hubsChains.flatMap(u=>u.hubs);let y=f.reduce((u,C)=>(u.find(I=>JSON.stringify(I)===JSON.stringify(C))||u.push(C),u),[]);y.forEach(u=>{let C={hubId:u.id,shipmentTotal:0};j.push(C)}),j.forEach(u=>{u.shipmentTotal=0}),b[0].hubsChains.forEach(u=>{u.hubs.forEach(C=>{if(y.some(I=>I.id===C.id)){let I=j.find(L=>L.hubId===C.id);I&&I.shipmentTotal++}});for(let C=0;C<u.route.length-1;C++)p.push(new R({id:"shipmenthubchains_"+u.shipmentId+"_route"+C,data:[{}],getSourcePosition:()=>[u.route[C][0],u.route[C][1]],getTargetPosition:()=>[u.route[C+1][0],u.route[C+1][1]],getSourceColor:a(C,u),getTargetColor:v(C,u),getWidth:m(C,u),widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthMinPixels:1,widthMaxPixels:100,transitions:{getWidth:200}})),p.push(new M({id:"HubChainMarker_"+u.shipmentId+"_"+C,data:[u],getPosition:()=>[u.route[u.route.length-1][0],u.route[u.route.length-1][1]],getFillColor:E.pickup,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:r}));p.push(new M({id:"pickupsHubChain",data:[{}],getPosition:C=>[u.route[0][0],u.route[0][1]],getColor:E.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels"}))}),p.push(new N({id:"HubChain",data:f,getPosition:u=>[u.locationX,u.locationY],getText:u=>u.id,getAlignmentBaseline:"center",getColor:[255,255,255],getBackgroundColor:[240,130,0],background:!0,backgroundPadding:[2,2,2,2],fontWeight:"normal",getSize:10,getTextAnchor:"middle",pickable:!0,onHover:r}))}}q(p),Z.current=b},[b,$.scaleFactor,c]);const ct=U&&U!=="Atlantis";return T.createElement(Lt,{layers:P,pickingRadius:3,controller:!0,getCursor:()=>"pointer",onClick:it,viewState:t,onViewStateChange:p=>rt(p.viewState)},ct&&T.createElement(Pt,{mapboxApiAccessToken:pt,mapStyle:H.getters.mapStyle}),nt(e))}const It={messages:{en:{carriers:"Carriers",vehicles:"VEHICLES",services:"SERVICES",shipments:"SHIPMENTS",tours:"TOURS",pickup:"Pickup",service:"service",delivery:"Delivery",flatten:"Simple&nbsp;tours",shipmentDots:"Show shipments",scaleSize:"Widths",scaleFactor:"Width",scaleFactorShipments:"Width","Shipment Chains":"Shipment Chains",Shipments:"Shipments","LSP Tours":"LSP Tours",lspShipmentChains:"lspShipmentChains","Lsp Shipments":"Lsp Shipments","Carrier Tours":"Carrier Tours",Tours:"Tours"},de:{carriers:"Unternehmen",vehicles:"FAHRZEUGE",services:"BETRIEBE",shipments:"LIEFERUNGEN",service:"service",tours:"TOUREN",pickup:"Abholung",delivery:"Lieferung","shipment Chains":"Lieferungketten",Tours:"Tours"}}};O.insensitive=!0;const At=ut({name:"LogisticsPlugin",i18n:It,components:{LegendColors:vt,ToggleButton:mt.ToggleButton,TourViz:Ht,ZoomButtons:Tt},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>({linkLayerId:Math.floor(1e12*Math.random()),vizSettings:{simplifyTours:!1,showEachCarrierTour:!1,scaleShipmentSizes:!0,shipmentDotsOnTourMap:!0,selectedTours:!1,scaleFactor:0,scaleFactorShipments:0},vizDetails:{network:"",carriers:"",lsps:"",projection:"",title:"",description:"",thumbnail:"",center:null},myState:{statusMessage:"",isRunning:!1,subfolder:"",yamlConfig:"",thumbnail:!0,data:[]},searchTerm:"",searchEnabled:!1,globalState:H.state,isLoaded:!0,showHelp:!1,activeTab:"",speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],links:null,toggleTours:!0,toggleVehicles:!0,toggleShipments:!0,toggleServices:!0,detailContent:"",linksCsvData:null,data:null,darkMode:null,lightMode:null,avroNetwork:null,lsps:[],lspPlan:{},resources:[],lspShipmentChains:[],lspShipmentDirectChains:[],lspShipmentHubChains:[],lspChainTours:[],lspChainToursAll:[],lspDirectToursAll:[],lspToursAll:[],lspCarriers:[],lspHubChainCarriers:[],lspHubCarriers:[],lspDirectCarriers:[],lspCarrier:{},globalHubChainBoolean:!1,tourHubs:[],allHubChains:[],allCarrierHubIds:[],hubLocation:[],showHub:!1,hubName:"",carriers:[],carrierTours:[],carrierServicesAll:new Set,showCompleteHubChain:!1,showCarrierTours:!1,showCarrierToursList:!1,vehicles:[],shipments:[],shipmentLookup:{},services:[],stopActivities:[],tours:[],plans:[],shownShipments:[],shipmentIdsInTour:[],depots:[],shownDepots:[],shownLegs:[],selectedLsp:"",selectedCarrier:"",lspHubChainTours:"Hub Chain0",selectedLspHubChainTours:"",selectedTours:[],selectedPlan:null,selectedPlanIndex:null,selectedShipment:null,selectedLSPChain:null,thumbnailUrl:"",vehicleLookup:[],vehicleLookupString:{},rgb:bt({colormap:"phase",nshades:9,format:"rba"}).map(s=>s.slice(0,3)).reverse(),dropdownIsActive:!1}),computed:{fileApi(){return new dt(this.fileSystem,H)},fileSystem(){const s=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(s.length===0)throw console.log("no such project"),Error;return s[0]},textColor(){const s={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.globalState.isDarkMode?t:s}},watch:{"$store.state.viewState"(){V[this.linkLayerId]&&V[this.linkLayerId]()},"globalState.isDarkMode"(){this.updateLegendColors()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()}},methods:{checkIfHubChain(){return this.lspShipmentHubChains.length>0},checkIfDirectChain(){return this.globalHubChainBoolean=!1,this.lspShipmentDirectChains.length>0&&this.lspShipmentHubChains.length==0},handleSelectShipment(s){if(this.selectedShipment===s){if(this.selectedShipment=null,this.shownShipments=[],!this.selectedTours.length){const t=this.carriers.filter(i=>i.$id==this.selectedCarrier);this.selectedCarrier="",this.handleSelectCarrier(t[0],!0,"")}return}this.shownShipments=this.shipments.filter(t=>t.$id===s.$id),this.selectedShipment=s},handleSelectShipmentChain(s){if(this.selectedLSPChain===s){if(this.selectedLSPChain=null,this.shownShipments=[],this.selectedLSPChain==null){const i=this.lsps.filter(r=>r.$id==this.selectedLsp);let e;i[0].resources.carrier.forEach(r=>{r.$id==this.selectedCarrier&&(e=r)}),this.shipments=this.processShipments(e),this.lspShipmentChains=[],this.lspShipmentChains.push(this.processLogisticChains(this.shipments)),this.shownShipments=this.shipments}return}let t={hubsChains:this.lspShipmentHubChains,directChains:this.lspShipmentDirectChains};t.hubsChains=this.lspShipmentHubChains.filter(i=>i.shipmentId===s.shipmentId),t.directChains=[],this.lspShipmentChains=[],this.lspShipmentChains.push(t),this.selectedLSPChain=s},processActivitiesInTour(s){const t=[];let i=0;const e={};let r=[],n="";if(this.lspShipmentHubChains.length>0)for(let l=0;l<this.lspShipmentHubChains[0].hubs.length;l++){const c=this.links[this.lspShipmentHubChains[0].hubs[l].location];r=[.5*(c[0]+c[2]),.5*(c[1]+c[3])],n=this.lspShipmentHubChains[0].hubs[l].location,e[`L${this.lspShipmentHubChains[0].hubs[l].location}`]={link:this.lspShipmentHubChains[0].hubs[l].location,midpoint:r,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:s,hub:!0,depot:!1,details:{},ptFrom:[c[0],c[1]],ptTo:[c[2],c[3]]}}else if(this.lspShipmentDirectChains.length>0&&!this.globalHubChainBoolean){const l=this.links[this.lspShipmentDirectChains[0].from];r=[.5*(l[0]+l[2]),.5*(l[1]+l[3])],n=this.lspShipmentDirectChains[0].from,e[`L${this.lspShipmentDirectChains[0].from}`]={link:this.lspShipmentDirectChains[0].from,midpoint:r,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:s,hub:!1,depot:!0,details:{},ptFrom:[l[0],l[1]],ptTo:[l[2],l[3]]}}else for(let l=0;l<this.lspShipmentHubChains[0].hubs.length;l++){const c=this.links[this.lspShipmentHubChains[0].hubs[l].location];r=[.5*(c[0]+c[2]),.5*(c[1]+c[3])],n=this.lspShipmentHubChains[0].hubs[l].location,e[`L${this.lspShipmentHubChains[0].hubs[l].location}`]={link:this.lspShipmentHubChains[0].hubs[l].location,midpoint:r,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:s,hub:!0,depot:!1,details:{},ptFrom:[c[0],c[1]],ptTo:[c[2],c[3]]}}s.plan.forEach(l=>{if(!(!l.$serviceId&&!l.$shipmentId))if(l.$serviceId&&t.push(l.$serviceId),l.$shipmentId&&t.push(l.$shipmentId),s.vehicleId=="mainTruck"){const c=s.legs[0].links[0],d=[this.links[c][0],this.links[c][1]],b=[this.links[c][2],this.links[c][3]],h=[.5*(d[0]+b[0]),.5*(d[1]+b[1])],k=this.$t(String(l.$type)),$={id:s.id,type:k,count:i++,link:c,midpoint:h,label:"",tour:s,ptFrom:d,ptTo:b};if(c==n)e[`L${c}`].visits[e[`L${c}`].visits.length-1][l.$type].push($);else if(`L${c}`in e){const A={pickup:[],delivery:[],service:[]};A[l.$type].push($),e[`L${c}`].visits.push(A)}else{const A={pickup:[],delivery:[],service:[]};A[l.$type].push($),e[`L${c}`]={link:c,midpoint:h,label:"",tour:s,hub:!1,depot:!0,ptFrom:d,ptTo:b,visits:[A]}}n=c}else{const c=this.shipmentLookup[l.$serviceId]||this.shipmentLookup[l.$shipmentId];if(!c)return;const d=l.$type==="pickup"?c.$from:c.$to,b=[this.links[d][0],this.links[d][1]],h=[this.links[d][2],this.links[d][3]],k=[.5*(b[0]+h[0]),.5*(b[1]+h[1])],$=this.$t(l.$type),{from:A,fromX:X,fromY:U,to:B,toX:w,toY:D,id:J,...Y}=c,_={id:c.$id,type:$,count:i++,link:d,midpoint:k,label:"",tour:s,details:Y,ptFrom:b,ptTo:h};if(d==n)e[`L${d}`].visits[e[`L${d}`].visits.length-1][l.$type].push(_);else if(`L${d}`in e){const z={pickup:[],delivery:[],service:[]};z[l.$type].push(_),e[`L${d}`].visits.push(z)}else{const z={pickup:[],delivery:[],service:[]};z[l.$type].push(_),e[`L${d}`]={link:d,midpoint:k,label:"",tour:s,hub:!1,depot:!1,details:Y,ptFrom:b,ptTo:h,visits:[z]}}n=d}});const o=Object.values(e);for(let l=0;l<o.length;l++)o[l].hub?o[l].label="hub":o[l].depot?o[l].label="depot":o[l].label=`${l}`;return{shipmentIdsInTour:t,stopActivities:o}},setupDepots(){const s={};this.vehicles.forEach(t=>{const i=t.$depotLinkId;let e=this.links[i];e&&(s[i]||(s[i]={type:"depot",link:t.$depotLinkId,midpoint:[.5*(e[0]+e[2]),.5*(e[1]+e[3])],coords:this.links[t.$depotLinkId],vehicles:{}}),s[i].vehicles[t.$id]=t)}),this.depots=Object.values(s),this.shownDepots=this.depots.slice(0)},selectAllLspTours(){this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0);let s=this.lsps.find(t=>t.$id===this.selectedLsp);if(this.tourHubs=[],s.resources.hub&&s.resources.hub.forEach(t=>{let i={Xcoord:(this.links[t.$location][0]+this.links[t.$location][2])/2,Ycoord:(this.links[t.$location][1]+this.links[t.$location][3])/2,hubId:t.$id};this.tourHubs.push(i)}),this.globalHubChainBoolean)for(const t of this.lspChainToursAll){t.legs.forEach((e,r)=>this.addRouteToMap(t,e,r++));const i=this.processActivitiesInTour(t);this.stopActivities=this.stopActivities.concat(i.stopActivities),this.setupDepots()}else if(this.selectedCarrier)for(const t of this.lspChainToursAll)for(const i of t){i.legs.forEach((r,n)=>this.addRouteToMap(i,r,n++));const e=this.processActivitiesInTour(i);this.stopActivities=this.stopActivities.concat(e.stopActivities),this.setupDepots()}else if(!this.selectedCarrier&&!this.globalHubChainBoolean)for(const t of this.lspChainToursAll)for(const i of t){i.legs.forEach((r,n)=>this.addRouteToMap(i,r,n++));const e=this.processActivitiesInTour(i);this.stopActivities=this.stopActivities.concat(e.stopActivities),this.setupDepots()}else for(const t of this.lspChainToursAll){t.legs.forEach((e,r)=>this.addRouteToMap(t,e,r++));const i=this.processActivitiesInTour(t);this.stopActivities=this.stopActivities.concat(i.stopActivities),this.setupDepots()}},selectAllTours(){if(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0),this.carrierTours.length>0)for(const s of this.carrierTours[0]){s.legs.forEach((i,e)=>this.addRouteToMap(s,i,e++));const t=this.processActivitiesInTour(s);this.stopActivities=this.stopActivities.concat(t.stopActivities),this.setupDepots()}else if(this.lspChainToursAll)for(const s of this.lspChainToursAll){s.legs.forEach((i,e)=>this.addRouteToMap(s,i,e++));const t=this.processActivitiesInTour(s);this.stopActivities=this.stopActivities.concat(t.stopActivities),this.setupDepots()}},hslToRgb(s,t,i){t/=100,i/=100;const e=o=>(o+s/30)%12,r=t*Math.min(i,1-i),n=o=>i-r*Math.max(-1,Math.min(e(o)-3,Math.min(9-e(o),1)));return[Math.round(n(0)*255),Math.round(n(8)*255),Math.round(n(4)*255)]},getTourColor(s,t){let i=0;for(let l=0;l<s.length;l++)i=s.charCodeAt(l)+((i<<5)-i);i*=t;const e=(i%360+360)%360;let o=this.hslToRgb(e,70,50);return`rgb(${o[0]}, ${o[1]}, ${o[2]})`},getLspTourColor(s){let t=0;for(let n=0;n<s.length;n++)t=s.charCodeAt(n)+((t<<5)-t);const i=(t&16711680)>>16,e=(t&65280)>>8,r=t&255;return`rgb(${i}, ${e}, ${r})`},async handleSelectTour(s){if(this.vizSettings.selectedTours=!0,!s.legs.length){console.log("No Route.");for(let r=0;r<s.plan.length;r++)if(s.plan[r].$shipmentId){const n=s.plan[r].$shipmentId,o=[this.shipmentLookup[n].$from,this.shipmentLookup[n].$to];s.legs.push({links:o})}this.vizSettings.simplifyTours=!0}if(this.selectedTours.includes(s)){this.selectedTours=this.selectedTours.filter(r=>r!==s),this.shownLegs=this.shownLegs.filter(r=>r.tour!==s),this.stopActivities=this.stopActivities.filter(r=>r.tour!==s),!this.selectedTours.length&&!this.selectedCarrier?(this.selectAllLspTours(),this.vizSettings.selectedTours=!1):!this.selectedCarrier&&this.selectedTours.length?this.vizSettings.selectedTours=!1:(this.selectAllTours(),this.vizSettings.selectedTours=!1);return}this.selectedTours.length||(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[]),this.selectedTours.push(s);const{shipmentIdsInTour:t,stopActivities:i}=this.processActivitiesInTour(s);this.shipmentIdsInTour=t;let e=0;for(const r of s.legs)this.addRouteToMap(s,r,e++);this.stopActivities=this.stopActivities.concat(i)},addRouteToMap(s,t,i){const e=[[this.links[t.links[0]][0],this.links[t.links[0]][1]]];for(const r of t.links){const n=e[e.length-1],o=[this.links[r][0],this.links[r][1]];(o[0]!==n[0]||o[1]!==n[1])&&e.push(o),e.push([this.links[r][2],this.links[r][3]])}this.shownLegs=this.shownLegs.concat([{tour:s,shipmentsOnBoard:t.shipmentsOnBoard,totalSize:t.totalSize,count:i,points:e,color:this.rgb[(3+e.length)%this.rgb.length],type:"leg"}])},handleSelectLspButton(s){this.showCarrierToursList=!1,this.activeTab="lspTours",this.selectedCarrier="",this.handleSelectLsp(s,!1,null)},handleSelectLspFromList(s){this.showCarrierToursList=!1,this.lspShipmentDirectChains.length==0&&this.lspShipmentHubChains.length==0?this.activeTab="lspShipmentChains":this.activeTab="shipments",this.selectedCarrier=this.getFirstCarrierFromSelectedLsp(s),this.vizSettings.showEachCarrierTour=!1,this.handleSelectLsp(s,!1,null)},handleSelectLsp(s,t,i){this.globalHubChainBoolean=t,typeof s=="string"&&(s=this.lsps.find(o=>o.$id===s)),this.lspToursAll=[],this.lspCarriers=[],this.lspHubChainCarriers=[],this.allHubChains=[];const e=s.LspPlans.LspPlan.find(o=>o.$selected=="true");e.logisticChains.logisticChain.forEach(o=>{if(o.$id.includes("direct")||o.$id.includes("Direct"))this.lspCarriers.push(o.logisticChainElement[0].$resourceId);else if(o.$id.includes("hub")||o.$id.includes("Hub")){let l=[];l.push(o);let c=0;l.forEach(d=>{let b={chainIds:[],chainIndex:c};d.logisticChainElement.forEach(h=>{b.chainIds.push(h.$resourceId),this.allCarrierHubIds.push(h.$resourceId)}),this.allHubChains.push(b),c++})}}),this.lspHubChainCarriers=this.allHubChains;const r=s.$id;this.selectedLsp=r,this.lspCarrier=this.carriers.filter(o=>o.$id==e.logisticChains.logisticChain[0].logisticChainElement[0].$resourceId)[0],this.lspCarrier==null&&console.error("no logistic chain elements for lsp Plan."),this.shipments=this.processShipments(this.lspCarrier),this.lspShipmentChains=[],this.lspShipmentChains.push(this.processLogisticChains(this.shipments)),this.shownShipments=[],this.shownShipments=this.shipments;let n=s.LspPlans.LspPlan.find(o=>o.$selected==="true");this.lspChainToursAll=[],n.logisticChains.logisticChain.forEach(o=>{i!=null&&t?JSON.stringify(this.allHubChains[i].chainIds)==JSON.stringify(o.logisticChainElement.flatMap(l=>l.$resourceId))&&(this.allHubChains[i].chainIds.forEach(l=>{this.handleSelectCarrier(l,!0,"")}),this.selectedCarrier="",this.lspToursAll=this.lspChainToursAll):i==null&&!t&&(this.lspHubChainTours="",this.selectedLspHubChainTours="Hub_Chain_0",o.logisticChainElement.forEach(l=>{let c=this.processTours(l);c.length>0&&this.lspChainToursAll.push(c)}),this.lspChainToursAll.forEach(l=>{this.lspToursAll=this.lspToursAll.concat(l)}))}),this.selectAllLspTours()},getCarrierServicesForHubChain(s,t){if(this.activeTab=="lspTours"||this.activeTab=="tours"){if(this.lspHubChainTours===this.selectedLspHubChainTours){this.lspHubChainTours="Hub Chain0",this.selectedLspHubChainTours="",this.selectedCarrier="",console.log("carriers unselected - TRIGGER THE LSP!"),this.handleSelectLsp(this.lsps.find(i=>i.$id==this.selectedLsp),!1,null);return}this.lspHubChainTours="Hub_Chain_"+t,this.selectedLspHubChainTours="Hub_Chain_"+t,this.showCompleteHubChain=!0,this.handleSelectLsp(s,!0,t)}},handleSelectCarrier(s,t,i){let e={};if(St(s)=="string"?e=this.carriers.find(h=>h.$id===s):e=this.carriers.find(h=>h.$id===s.$id),this.showHub=!1,this.hubLocation=[],e==null){this.shipments=[],this.hubLocation=[],this.lspShipmentChains=[];let k=this.lsps.find($=>$.$id==this.selectedLsp).resources.hub.find($=>$.$id==s);this.hubLocation.push(.5*(this.links[k.$location][0]+this.links[k.$location][2])),this.hubLocation.push(.5*(this.links[k.$location][1]+this.links[k.$location][3])),this.hubName=s,this.showHub=!0,this.globalHubChainBoolean||(this.selectedCarrier=s,this.lspHubChainTours="",this.selectedLspHubChainTours="Hub_Chain_0");return}if(this.dropdownIsActive=!1,!this.links)return;const r=e.$id;if(this.vehicles=[],this.shipments=[],this.services=[],this.plans=[],this.shownShipments=[],this.shownDepots=[],this.selectedShipment=null,this.shipmentIdsInTour=[],this.stopActivities=[],this.shownLegs=[],this.selectedCarrier===r&&t&&!this.globalHubChainBoolean){this.selectedCarrier="",console.log("carriers unselected - TRIGGER THE LSP!"),this.handleSelectLsp(this.lsps.find(h=>h.$id==this.selectedLsp),!1,null);return}i=="direct"&&(this.lspHubChainTours="",this.selectedLspHubChainTours="Hub_Chain_0"),this.globalHubChainBoolean||(this.selectedCarrier=r),this.setupDepots(),this.shipments=this.processShipments(e),this.lspShipmentChains=[],this.lspShipmentChains.push(this.processLogisticChains(this.shipments)),e.services?.service?.length&&(this.services=e?.services.service.map(h=>h.$).sort((h,k)=>O(h.$id,k.$id))),this.shownShipments=this.shipments,this.lspChainTours=[],this.lspChainToursAll=[];let n={};this.lsps.forEach(h=>{h.resources.carrier.find(k=>k.$id==e.$id)&&(n=h)});let o={};n.LspPlans.LspPlan.forEach(h=>{h.$selected==="true"&&(o=h)}),this.carrierTours=[];let l=o.logisticChains.logisticChain.find(h=>h.$id.includes("Direct")||h.$id.includes("direct")),c=o.logisticChains.logisticChain.find(h=>h.$id.includes("Hub")||h.$id.includes("hub")),d=[],b=[];l&&l.logisticChainElement.forEach(h=>{d.push(h.$resourceId)}),c&&c.logisticChainElement.forEach(h=>{b.push(h.$resourceId)}),d.find(h=>h===e.$id)?l.logisticChainElement.forEach(h=>{h.$resourceId===e.$id&&this.carrierTours.push(this.processTours(h))}):b.find(h=>h===e.$id)&&c.logisticChainElement.forEach(h=>{h.$resourceId===e.$id&&this.carrierTours.push(this.processTours(h)),this.lspChainTours.push(this.processTours(h))}),this.lspChainTours.forEach(h=>{this.lspChainToursAll=this.lspChainToursAll.concat(h)}),this.lspChainToursAll.length==0?this.lspChainToursAll.push(this.carrierTours):this.lspChainToursAll.concat(this.carrierTours),this.activeTab!="lspTours"&&this.activeTab!="tours"&&!this.allCarrierHubIds.includes(s)&&(this.activeTab="shipments"),this.activeTab!="lspTours"&&this.activeTab!="tours"&&this.allCarrierHubIds.includes(s)&&(this.activeTab="lspShipmentChains"),this.selectAllTours()},getAllPlans(s){if(s.plan!=null){this.plans.push(s.plan),this.selectedPlan=s.plan;return}if(s.plans!=null){if(s.plans.plan.length==null){this.plans.push(s.plans.plan),this.selectedPlan=s.plans.plan;return}this.plans=s.plans.plan;for(let t=0;t<s.plans.plan.length;t++){if(s.plans.plan[t].selected=="true"){this.selectedPlan=s.plans.plan[t];break}this.selectedPlan=s.plans.plan[t]}}},processTours(s){let t=this.carriers.find(i=>i.$id===s.$resourceId);if(t!=null){this.getAllPlans(t),Array.isArray(this.selectedPlan.tour)||(this.selectedPlan.tour=[this.selectedPlan.tour]);const i=this.selectedPlan.tour.map((e,r)=>{const n=[e.act[0]],o=new Set;for(let d=1;d<e.act.length;d++)e.leg[d-1].shipmentsOnBoard=[...o],n.push(e.leg[d-1]),n.push(e.act[d]),e.act[d].$type=="pickup"&&e.act[d].$shipmentId&&o.add(e.act[d].$shipmentId),e.act[d].$type=="delivery"&&e.act[d].$shipmentId&&o.delete(e.act[d].$shipmentId);const l=e.leg.filter(d=>d.route&&d.route.length).map(d=>{const b=d.shipmentsOnBoard.map(k=>this.shipmentLookup[k]),h=b.reduce((k,$)=>k+parseFloat($?.$size||0),0);return{shipmentsOnBoard:b,totalSize:h,links:d.route?d.route.split(" "):[]}});return{vehicleId:e.$vehicleId,tourId:e.$tourId,plan:n,legs:l,tourNumber:0}});return i.sort((e,r)=>O(e.vehicleId,r.vehicleId)),i.forEach((e,r)=>e.tourNumber=r),i}else return[]},processLogisticChains(s){this.lspShipmentHubChains=[],this.lspShipmentDirectChains=[];let t=this.lsps.find(e=>e.$id===this.selectedLsp);for(let e=0;e<t.LspPlans.LspPlan.length;e++)t.LspPlans.LspPlan[e].$selected=="true"&&(this.lspPlan=t.LspPlans.LspPlan[e]);try{for(let e=0;e<this.lspPlan.shipmentPlans.shipmentPlan.length;e++){let r=s.find(n=>n.$id==this.lspPlan.shipmentPlans.shipmentPlan[e].$shipmentId);if(r){let n={isDirectChain:!0,hubs:[],from:r.$from,to:r.$to,fromX:.5*(this.links[r.$from][0]+this.links[r.$from][2]),fromY:.5*(this.links[r.$from][1]+this.links[r.$from][3]),toX:.5*(this.links[r.$to][0]+this.links[r.$to][2]),toY:.5*(this.links[r.$to][1]+this.links[r.$to][3]),chainId:this.lspPlan.shipmentPlans.shipmentPlan[e].$chainId,route:[],color:0,shipmentId:r.$id};if(n.chainId.includes("direct"))this.lspShipmentDirectChains.push(n);else if(n.chainId.includes("hub")){n.isDirectChain=!1;for(let o=0;o<this.lspPlan.shipmentPlans.shipmentPlan[e].element.length;o++){let l=t.resources.hub.find(c=>c.$id==this.lspPlan.shipmentPlans.shipmentPlan[e].element[o].$resourceId);if(l){let c={id:this.lspPlan.shipmentPlans.shipmentPlan[e].element[o].$resourceId,location:l.$location,locationX:.5*(this.links[l.$location][0]+this.links[l.$location][2]),locationY:.5*(this.links[l.$location][1]+this.links[l.$location][3])};n.hubs.push(c)}}n.route.push([n.fromX,n.fromY]),n.hubs.forEach(o=>{n.route.push([o.locationX,o.locationY])}),n.route.push([n.toX,n.toY]),n.color=this.rgb[(3+n.route.length)%this.rgb.length],this.lspShipmentHubChains.push(n)}}}}catch{console.log("processing of logisitc chains failed")}return{hubsChains:this.lspShipmentHubChains,directChains:this.lspShipmentDirectChains}},processShipments(s){this.shipmentLookup={};let t={};if(this.lsps.forEach(o=>{o.resources.carrier.find(l=>l.$id==s.$id)&&(t=o)}),!t.shipments?.shipment?.length)return[];this.carriers.forEach(o=>{o.$id==s.$id});const i=t.LspPlans.LspPlan.find(o=>o.$selected=="true"),e=[];i.shipmentPlans.shipmentPlan.forEach(o=>{o.element.forEach(l=>{l.$resourceId==s.$id&&e.push(o.$shipmentId)})});let r=[];[...new Set(e)].forEach(o=>{t.shipments.shipment.find(l=>{l.$id==o&&r.push(l)})}),r=r.sort((o,l)=>O(o.$id,l.$id));try{r.forEach(o=>{o.fromX=.5*(this.links[o.$from][0]+this.links[o.$from][2]),o.fromY=.5*(this.links[o.$from][1]+this.links[o.$from][3]),o.toX=.5*(this.links[o.$to][0]+this.links[o.$to][2]),o.toY=.5*(this.links[o.$to][1]+this.links[o.$to][3]),this.shipmentLookup[o.$id]=o})}catch{}return r},addToSet(s,t){Array.from(s).some(e=>JSON.stringify(e)===JSON.stringify(t))||s.add(t)},buildRouteFromUrl(){const s=this.$route.params;if(!s.project||!s.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const t=1+s.pathMatch.lastIndexOf("/"),i=s.pathMatch.substring(0,t),e=s.pathMatch.substring(t);this.myState.subfolder=i,this.myState.yamlConfig=e},async getVizDetails(){if(this.config){this.vizDetails=Object.assign({},this.config);return}if(this.yamlConfig?.endsWith("yaml")||this.yamlConfig?.endsWith("yml"))try{const r=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig,n=await this.fileApi.getFileText(r);this.vizDetails=ft.parse(n);return}catch(r){console.log("failed"+r);const n=r;this.fileSystem.needPassword&&n.status===401?H.commit("requestLogin",this.fileSystem.slug):this.$emit("error",""+r);return}const s=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("carriers")),{files:t}=await this.fileApi.getDirectory(this.myState.subfolder);let i=this.myState.yamlConfig.replaceAll("carriers","network");if(t.indexOf(i)==-1){const r=t.filter(n=>n.indexOf("network")>-1);r.length?i=r[0]:(this.myState.statusMessage="No road network found.",i="")}this.vizDetails={lsps:this.yamlConfig,network:i,carriers:"",title:s,description:"",center:this.vizDetails.center,projection:"",thumbnail:""},this.$emit("title","Logistics Viewer")},async setMapCenter(){let s=0,t=0,i=0;if(this.vizDetails.center)typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),t=this.vizDetails.center[0],i=this.vizDetails.center[1];else if(!this.vizDetails.center){if(this.data=Object.entries(this.links),!this.data.length)return;const e=this.data.length/2,r=4096;for(let n=0;n<e;n+=r)t+=this.data[n*2][1][0],i+=this.data[n*2+1][1][1],s++;t=t/s,i=i/s}t&&i&&this.$store.commit("setMapCamera",{longitude:t,latitude:i,zoom:9,bearing:0,pitch:0,jump:!1})},handleClick(s){console.log("CLICK!",s),s||this.clickedEmptyMap(),s?.type=="depot"&&this.clickedDepot(s),s?.type=="leg"&&this.clickedLeg(s)},clickedDepot(s){const t=Object.values(s.vehicles).map(i=>i.$id);this.selectedTours=[],this.shownShipments=[];for(const i of this.lspChainToursAll)t.includes(i.vehicleId)&&(this.handleSelectTour(i),this.shipmentIdsInTour.forEach(e=>{this.shownShipments.push(this.shipmentLookup[e])}))},clickedLeg(s){s?.tour&&this.handleSelectTour(s?.tour)},clickedEmptyMap(){},updateLegendColors(){},async loadLSPS(){const s=await this.loadFileOrGzippedFile(this.vizDetails.lsps);return s?(await et(s,{alwaysArray:["lsps.lsp","lsps.lsp.resources.carrier","lsps.lsp.resources.hub","lsps.lsp.shipments.shipment","lsps.lsp.LspPlans.LspPlan","lsps.lsp.LspPlans.LspPlan.logisticChains.logisticChain","lsps.lsp.LspPlans.LspPlan.logisticChains.logisticChain.logisticChainElement","lsps.lsp.LspPlans.LspPlan.shipmentPlans.shipmentPlan","lsps.lsp.LspPlans.LspPlan.shipmentPlans.shipmentPlan.element"]})).lsps.lsp.sort((e,r)=>O(e.$id,r.$id)):[]},async loadLinksCsv(){const s=await this.loadFileOrGzippedFile("output_links.csv.gz");return s&&[]},async loadCarriers(){var s=[];this.lsps.forEach(r=>{r.resources.carrier.forEach(n=>{s.includes(n)||s.push(n)})});const t=await this.loadFileOrGzippedFile("output_carriers.xml.gz");if(!t)return console.log("can't find carriers"),[];var e=(await et(t,{alwaysArray:["carriers.carrier","carriers.carrier.capabilities.vehicles.vehicle","carriers.carrier.plan.tour","carriers.carrier.shipments.shipment","carriers.carrier.services.service"]})).carriers.carrier.sort((r,n)=>O(r.$id,n.$id));return s.forEach(r=>{if(e.filter(o=>o.$id===r.$id).length==0){let o={$id:r.$id,attributes:{},capabilities:{},plans:{},services:{}};e.push(o)}}),e},async loadAvroRoadNetwork(){console.log("LOADING AVRO:",this.vizDetails.network);const s=`${this.subfolder}/${this.vizDetails.network}`,t=await this.fileApi.getFileBlob(s),i=await new Promise((e,r)=>{const n=[];yt.createBlobDecoder(t).on("metadata",o=>{}).on("data",o=>{n.push(o)}).on("end",()=>{e(n)})});return console.log(i[0]),i[0]},async loadNetwork(){if(this.myState.statusMessage="Loading network...",this.vizDetails.network.indexOf(".xml.")>-1){const s=`${this.myState.subfolder}/${this.vizDetails.network}`,t=await this.fetchNetwork(s,{});this.vizDetails.projection=""+t.projection,this.myState.statusMessage="Building network link table";const i={};return t.linkIds.forEach((e,r)=>{i[e]=[t.source[r*2],t.source[r*2+1],t.dest[r*2],t.dest[r*2+1]]}),i}else if(this.vizDetails.network.indexOf(".avro")>-1){this.avroNetwork=await this.loadAvroRoadNetwork();const s={};if(this.avroNetwork){const t=this.avroNetwork?.nodeCoordinates;this.avroNetwork.linkId.forEach((i,e)=>{const r=2*this.avroNetwork.from[e],n=2*this.avroNetwork.to[e];s[i]=[t[r],t[1+r],t[n],t[1+n]]})}return this.vizDetails.projection="EPSG:31468",console.log(s[6e3]),s}else return await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.network)},async fetchNetwork(s,t){return new Promise((i,e)=>{const r=new wt;try{r.postMessage({filePath:s,fileSystem:this.fileSystem,vizDetails:t}),r.onmessage=n=>{if(n.data.promptUserForCRS){let o=prompt("Enter the coordinate reference system, e.g. EPSG:25832")||"EPSG:31468";Number.isFinite(parseInt(o))&&(o=`EPSG:${o}`),r.postMessage({crs:o});return}if(n.data.status){this.myState.statusMessage=""+n.data.status;return}r.terminate(),n.data.error&&(console.error(n.data.error),H.commit("error",n.data.error),this.myState.statusMessage=n.data.error,e(n.data.error)),i(n.data.links)}}catch(n){r.terminate(),console.error(n),e(n)}})},toggleLoaded(s){this.isLoaded=s},rotateColors(){localStorage.setItem("plugin/agent-animation/colorscheme",this.globalState.isDarkMode?tt.DarkMode:tt.LightMode)},async loadFileOrGzippedFile(s){let t=`${this.subfolder}/${s}`;try{if(t.indexOf("*")>-1||t.indexOf("?")>-1){const r=t.substring(1+t.lastIndexOf("/")),n=t.substring(0,t.lastIndexOf("/")),{files:o}=await this.fileApi.getDirectory(n),l=kt(o,r);if(l.length==0)throw Error(`No files matched "${r}"`);if(l.length>1)throw Error(`More than one file matched "${r}": ${l}`);t=`${n}/${l[0]}`}let e="";if(t.endsWith("xml")||t.endsWith("gz")){const n=await(await this.fileApi.getFileBlob(t)).arrayBuffer(),o=$t(n);return new TextDecoder("utf-8").decode(o)}}catch{}const i=`Error loading ${t}`;return H.commit("error",i),this.myState.statusMessage=i,""},selectDropdown(){this.dropdownIsActive=!this.dropdownIsActive},selectPlan(s){for(let t=0;t<this.plans.length;t++)this.plans[t].$selected="false";s.$selected="true",this.selectedPlanIndex=this.plans.indexOf(s),this.selectedTours=[],this.selectDropdown(),this.selectedPlan=s},getFirstCarrierFromSelectedLsp(s){return s.LspPlans.LspPlan.find(i=>i.$selected=="true").logisticChains.logisticChain[0].logisticChainElement[0].$resourceId}},async mounted(){H.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails(),!this.thumbnail&&(this.showHelp=!1,this.updateLegendColors(),this.myState.statusMessage="Loading carriers...",this.lsps=await this.loadLSPS(),this.carriers=await this.loadCarriers(),await this.$nextTick(),this.links=await this.loadNetwork(),this.setMapCenter(),this.myState.statusMessage="",this.lsps.length&&this.handleSelectLsp(this.lsps[0],!1,null),this.lspShipmentHubChains.length>0?this.activeTab="lspShipmentChains":this.activeTab="shipments",this.lspChainTours.length&&this.selectAllTours(),this.selectedCarrier=this.getFirstCarrierFromSelectedLsp(this.lsps[0]))},beforeDestroy(){this.myState.isRunning=!1,H.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1)}});var Et=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"carrier-viewer",class:{"hide-thumbnail":!t.thumbnail},attrs:{oncontextmenu:"return false"}},[i("div",{staticClass:"container-1"},[i("div",{staticClass:"main-panel"},[t.thumbnail?t._e():i("tour-viz",{staticClass:"anim",attrs:{activeTab:t.activeTab,shipments:t.shownShipments,lspShipmentChains:t.lspShipmentChains,carrierTours:t.carrierTours,carrierServices:t.carrierServicesAll,showCompleteHubChain:t.showCompleteHubChain,depots:t.shownDepots,legs:t.shownLegs,showHub:t.showHub,hubLocation:t.hubLocation,hubName:t.hubName,tourHubs:t.tourHubs,stopActivities:t.stopActivities,dark:t.globalState.isDarkMode,center:t.vizDetails.center,viewId:t.linkLayerId,settings:t.vizSettings,numSelectedTours:t.selectedTours.length,onClick:t.handleClick,projection:t.vizDetails.projection}}),t.thumbnail?t._e():i("ZoomButtons"),t.myState.statusMessage?i("div",{staticClass:"xmessage"},[t._v(t._s(t.myState.statusMessage))]):t._e()],1),t.thumbnail?t._e():i("div",{staticClass:"right-panel",attrs:{darkMode:!0}},[t.lsps.length?i("h3",{staticStyle:{"margin-left":"0.25rem"}},[t._v(t._s("Service Providers"))]):t._e(),i("div",{staticClass:"lsp-list"},t._l(t.lsps,function(e){return i("div",{key:e.$id,staticClass:"lsp",class:{selected:e.$id===t.selectedLsp},on:{click:function(r){return t.handleSelectLspFromList(e)}}},[i("div",{staticClass:"lsp-title"},[t._v(t._s(e.$id))])])}),0),i("h4",[t._v(t._s(t.selectedLsp||"Details"))]),t.selectedLsp?i("b-field",{staticClass:"detail-buttons",attrs:{size:"is-small"}},[t.checkIfDirectChain()?i("b-radio-button",{attrs:{"native-value":"shipments",size:"is-small",type:"is-warning"},nativeOn:{click:function(e){return t.handleSelectCarrier(t.lspCarrier,!1,"")}},model:{value:t.activeTab,callback:function(e){t.activeTab=e},expression:"activeTab"}},[i("span",[t._v(t._s(t.$t("Shipment Chains")))])]):t._e(),t.checkIfHubChain()?i("b-radio-button",{attrs:{"native-value":"lspShipmentChains",size:"is-small",type:"is-warning"},nativeOn:{click:function(e){return t.handleSelectCarrier(t.lspCarrier,!1,"")}},model:{value:t.activeTab,callback:function(e){t.activeTab=e},expression:"activeTab"}},[i("span",[t._v(t._s(t.$t("Shipment Chains")))])]):t._e(),i("b-radio-button",{staticStyle:{},attrs:{"native-value":"lspTours",size:"is-small",type:"is-warning"},nativeOn:{click:function(e){return t.handleSelectLspButton(t.selectedLsp)}},model:{value:t.activeTab,callback:function(e){t.activeTab=e},expression:"activeTab"}},[i("span",[t._v(t._s(t.$t("LSP Tours")))])])],1):t._e(),i("br"),i("br"),t.activeTab=="lspTours"||t.activeTab=="tours"?i("h6",[i("b",[t._v("*All Carriers shown. Please select individual Carrier to view its specific tours.")])]):t._e(),i("br"),t.lsps.length?i("h3",{staticStyle:{"margin-left":"0.25rem"}},[t._v(t._s("Carriers"))]):t._e(),i("div",{staticClass:"carrier-list"},[i("h5",{staticStyle:{"font-weight":"bold"}},[t._v(t._s("Direct Chain Carriers:"))]),t._l(t.lspCarriers,function(e){return i("div",{key:e,staticClass:"carrier",class:{selected:e==t.selectedCarrier},on:{click:function(r){return t.handleSelectCarrier(e,!0,"direct")}}},[i("div",{staticClass:"carrier-title"},[t._v(t._s(e))])])}),i("br"),i("h5",{staticStyle:{"font-weight":"bold"}},[t._v(t._s("Hub Chain Carriers:")),t._l(t.allHubChains,function(e){return i("div",{key:e.chainIndex,staticClass:"carrierHub"},[i("div",{staticClass:"carrierHubTitle",class:{selected:t.lspHubChainTours===t.selectedLspHubChainTours},staticStyle:{"font-weight":"bold"},attrs:{name:""},on:{click:function(r){return t.getCarrierServicesForHubChain(t.selectedLsp,e.chainIndex)}}},[t._v(t._s("Hub Chain "+e.chainIndex+":"))]),t._l(e.chainIds,function(r){return i("div",{key:r,staticClass:"carrier",class:{selected:r===t.selectedCarrier},on:{click:function(n){return t.handleSelectCarrier(r,!0,"")}}},[i("div",{staticClass:"carrier-title"},[t._v(t._s(r))])])})],2)})],2)],2),i("h4",[t._v(t._s(t.selectedCarrier||"Details"))]),i("div",{staticClass:"switchbox"},[i("div",{staticClass:"switches"},[(t.activeTab=="lspTours"||t.activeTab=="tours")&&t.selectedCarrier!=""?i("b-switch",{model:{value:t.vizSettings.showEachCarrierTour,callback:function(e){t.$set(t.vizSettings,"showEachCarrierTour",e)},expression:"vizSettings.showEachCarrierTour"}},[i("span",{domProps:{innerHTML:t._s(t.$t("Carrier Tours"))}})]):t._e()],1)]),i("div",{staticClass:"detail-area"},[t.activeTab=="lspShipmentChains"?i("div",{staticClass:"lspShipmentChains"},[i("span",[t._v(t._s(t.$t("Lsp Shipments"))+": "+t._s(t.lspShipmentHubChains.length))]),t._l(t.lspShipmentHubChains,function(e,r){return i("div",{key:`${r}-${e.shipmentId}`,staticClass:"leaf tour",class:{selected:e==t.selectedLSPChain},on:{click:function(n){return t.handleSelectShipmentChain(e)}}},[t._v(t._s(`${e.shipmentId}: ${e.chainId}`))])})],2):t._e(),t.activeTab=="shipments"?i("div",{staticClass:"lspShipmentChains"},[i("span",[t._v(t._s(t.$t("Shipments"))+": "+t._s(t.shipments.length))]),t._l(t.shipments,function(e,r){return i("div",{key:`${r}-${e.$id}`,staticClass:"leaf tour",class:{selected:e==t.selectedShipment},on:{click:function(n){return t.handleSelectShipment(e)}}},[t._v(t._s(`${e.$id}`))])})],2):t._e(),t.activeTab=="lspTours"&&t.selectedCarrier&&t.hubLocation.length==0?i("div",{staticClass:"tours"},[i("span",[t._v(t._s(t.$t("tours"))+": "+t._s(t.carrierTours[0].length))]),t._l(t.carrierTours[0],function(e,r){return i("div",{key:`${r}-${e.$id}`,staticClass:"leaf tour",class:{selected:t.selectedTours.includes(e)},on:{click:function(n){return t.handleSelectTour(e)}}},[e.tourId?i("div",{staticClass:"carrier-tours"},[e.tourId&&t.vizSettings.showEachCarrierTour?i("div",{style:{backgroundColor:t.getTourColor(e.tourId,e.tourNumber)},attrs:{id:"tourColor"}}):t._e(),e.tourId&&!t.vizSettings.showEachCarrierTour?i("div",{style:{backgroundColor:t.getLspTourColor(e.vehicleId)},attrs:{id:"tourColor"}}):t._e(),e.tourId?i("div",{attrs:{id:"tour"}},[t._v(t._s(e.tourId)+": "+t._s(`${e.vehicleId}`))]):i("div",[t._v(t._s(`${e.vehicleId}`))])]):t._e()])})],2):t._e(),t.activeTab=="lspTours"&&!t.selectedCarrier||t.globalHubChainBoolean?i("div",{staticClass:"lsptours"},[i("span",[t._v(t._s(t.$t("tours"))+": "+t._s(t.lspToursAll.length))]),t._l(t.lspToursAll,function(e,r){return i("div",{key:`${r}-${e.$id}`,staticClass:"leaf tour",class:{selected:t.selectedTours.includes(e)},on:{click:function(n){return t.handleSelectTour(e)}}},[e.tourId?i("div",{staticClass:"lsp-tours"},[e.tourId?i("div",{style:{backgroundColor:t.getLspTourColor(e.vehicleId)},attrs:{id:"tourColor"}}):t._e(),e.tourId?i("div",[t._v(t._s(e.tourId)+": "+t._s(`${e.vehicleId}`))]):i("div",[t._v(t._s(`${e.vehicleId}`))])]):t._e()])})],2):t._e()]),i("div",{staticClass:"switchbox"},[t.activeTab=="shipments"||t.activeTab=="lspShipmentChains"?i("div",{staticClass:"switches"},[i("p",[t._v(t._s(t.$t("scaleSize")))]),t.activeTab=="lspShipmentChains"?i("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:t.vizSettings.scaleFactor,callback:function(e){t.$set(t.vizSettings,"scaleFactor",e)},expression:"vizSettings.scaleFactor"}}):t._e(),t.activeTab=="shipments"?i("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:t.vizSettings.scaleFactorShipments,callback:function(e){t.$set(t.vizSettings,"scaleFactorShipments",e)},expression:"vizSettings.scaleFactorShipments"}}):t._e()],1):t._e(),t.activeTab=="tours"||t.activeTab=="lspTours"?i("div",{staticClass:"addedSpace"},[i("br")]):t._e(),t.activeTab=="tours"||t.activeTab=="lspTours"?i("div",{staticClass:"switches"},[i("b-switch",{model:{value:t.vizSettings.shipmentDotsOnTourMap,callback:function(e){t.$set(t.vizSettings,"shipmentDotsOnTourMap",e)},expression:"vizSettings.shipmentDotsOnTourMap"}},[i("span",{domProps:{innerHTML:t._s(t.$t("shipmentDots"))}})]),i("b-switch",{model:{value:t.vizSettings.simplifyTours,callback:function(e){t.$set(t.vizSettings,"simplifyTours",e)},expression:"vizSettings.simplifyTours"}},[i("span",{domProps:{innerHTML:t._s(t.$t("flatten"))}})])],1):t._e()])],1)])])},xt=[],_t=gt(At,Et,xt,!1,null,"90b09be4");const Zt=_t.exports;export{Zt as default};
