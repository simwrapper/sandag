import{d as W,n as Y,g as O,R as Z,r as J,j as et,M as ft,u as pt,l as mt,b as gt,C as vt}from"./index-DXwMd8J6.js";import{l as yt,p as st,b as St}from"./turf.es-DhhXp8l8.js";import{a as kt}from"./avro-Dd9UqmeZ.js";import{c as bt}from"./index-BaMiGLGj.js";import{c as it}from"./index-B9fw0f6a.js";import{d as Ct}from"./index-DXHHUSZh.js";import{P as Lt}from"./papaparse.min-BiqfovEr.js";import{Y as _t}from"./index-6F3aLhar.js";import{H as Tt,n as rt,m as xt}from"./HTTPFileSystem-mhJZeBxO.js";import{C as wt}from"./CollapsiblePanel-Xr3kzqwk.js";import{W as at}from"./NewXmlFetcher.worker-i6Sbj_zV.js";import{D as Ot}from"./DrawingTool-ryYUP9o2.js";import{Z as Dt}from"./ZoomButtons-DjT_93U7.js";import{D as Rt}from"./DashboardDataManager-BPyHyjlN.js";import{D as It,S as Pt,C as zt}from"./set-rtl-text-plugin-Cr2Q1psc.js";import{L as Mt,O as ot}from"./LineOffsetLayer-dnRJHt_c.js";import{G as Et}from"./geojson-layer-BIUM1AhK.js";import{S as Ft}from"./solid-polygon-layer-GmKLAUU6.js";import{c as ct}from"./color-DZRtpOAM.js";import{W as At}from"./GzipFetcher.worker-CUXR-wwH.js";import"./text-layer-BIdA0DCN.js";import"./util-DDCxpZ5I.js";import"./fxp-4YEvQr-_.js";import"./extends-CCbyfPlC.js";import"./RoadNetworkLoader.worker-Dk5IXYzf.js";import"./Coords-D-UV8-Xi.js";import"./group-DobYzF2-.js";import"./index-_doEQLKC.js";import"./line-layer-DG6F2WFV.js";import"./path-layer-CD8MEmh-.js";import"./cut-by-mercator-bounds-4NGqEMJI.js";const $t=W({name:"LeftDataPanel",props:{title:String},data:()=>({isHidden:!1,isLeaving:!1}),methods:{toggleHidePanel(){this.isHidden?this.isHidden=!this.isHidden:(this.isLeaving=!0,setTimeout(()=>{this.isHidden=!0,this.isLeaving=!1},300))}}});var Ht=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{attrs:{id:"datapanel"}},[s("div",{staticClass:"content-area",class:{"is-hidden":t.isHidden,bye:t.isLeaving}},[t.title?s("div",{staticClass:"info-header"},[s("h3",{staticStyle:{padding:"0.5rem 3rem","font-size":"1rem","font-weight":"normal",color:"white"}},[t._v(t._s(t.title))])]):t._e(),s("div",{staticClass:"top-area"},[t._t("default")],2)]),s("div",{staticClass:"restore-button",class:{"add-margin":!t.isHidden}},[s("button",{staticClass:"button is-small hide-button",on:{click:t.toggleHidePanel}},[t.isHidden?t._e():s("i",{staticClass:"fa fa-arrow-left"}),t.isHidden?s("i",{staticClass:"fa fa-arrow-right"}):t._e()])])])},jt=[],Bt=Y($t,Ht,jt,!1,null,"51117d95");const Nt=Bt.exports;function nt(e){return new Worker("/assets/TransitSupplyHelper.worker-BMqxO5O_.js",{name:e?.name})}const Xt=(e,t)=>{const s=[];for(const c of e){const{center:d,radius:h,slices:u}=c,p=h*.05;let m=Math.PI/2,v=m;const b=48,D=Math.cos(d[1]*Math.PI/180),E=u.reduce((y,f)=>y+f.value,0);u.forEach(y=>{y.percent=y.value/E});const x=u.reduce((y,f)=>(y[f.label]=f.value,y),{}),T=[],P=p*1.02;for(let y=0;y<=b*2;y++)v=m+y/(b*2)*Math.PI*2,T.push([d[0]+P*Math.cos(v)/D,d[1]+P*Math.sin(v)]);const F=O.state.isDarkMode;s.push([{polygon:T,color:Q(F?"black":"white"),width:p+1e-5,values:x}]);const B=u.map(y=>{const f=[d];for(let C=0;C<=b;C++){const A=y.percent||0;v=m+C/b*A*Math.PI*2,f.push([d[0]+p*Math.cos(v)/D,d[1]+p*Math.sin(v)])}f.push(d),m=v;const k=Array.isArray(y.color)?y.color:Q(y.color);return{polygon:f,color:k,width:p,values:x}});s.push(B)}const n=s.flat();return n.sort((c,d)=>c.width<=d.width?1:-1),n},Q=e=>{try{const t=ct(e);return t?[t.r,t.g,t.b]:[0,0,0]}catch{return[0,0,0]}};function qt({viewId:e=0,links:t={},selectedFeatures:s=[],stopMarkers:i=[],mapIsIndependent:n=!1,projection:c="EPSG:4326",handleClickEvent:d=null,pieSlider:h=20,widthSlider:u=50}){const p=O.state.isDarkMode,m=O.state.locale;Z[e]=()=>{b(O.state.viewState)};const[v,b]=J.useState(O.state.viewState),D=J.useMemo(()=>t.features.map(k=>({source:[...k.geometry.coordinates[0],k.properties.sort],target:[...k.geometry.coordinates[1],k.properties.sort],color:k.properties.currentColor,width:k.properties.width})),[t]),E=J.useMemo(()=>{if(!i.length||!("boardings"in i[0]))return[];const f=i.map(C=>({center:C.xy,radius:1e-5*h*Math.sqrt(C.boardings+C.alightings),slices:[{label:"boardings",color:"gold",value:C.boardings},{label:"alightings",color:"darkmagenta",value:C.alightings}]}));return Xt(f)},[i,h]);function x(f){d&&d(f)}function T(f){b(f),f.center=[f.longitude,f.latitude],n||O.commit("setMapCamera",f)}function P(f){const{object:k,index:C,layer:A}=f;if(C==-1)return null;if(A.id.startsWith("stop-pie-charts-layer")){let _='<div class="map-popup">';const{boardings:M,alightings:o}=k.values;k.values.total=M+o;for(const[a,r]of Object.entries(k.values))_+=`
        <div style="display: flex">
          <div>${a}:&nbsp;&nbsp;</div>
          <b style="margin-left: auto; text-align: right">${r}</b>
        </div>`;return _+="</div>",{html:_,style:{fontSize:"0.8rem",color:p?"#ccc":"#223",backgroundColor:p?"#2a4f4f":"#f4fff4",margin:"2rem 0 0rem 0rem"}}}const z=[{field:"pax",name_en:"Passengers",name_de:"Passagiere"},{field:"departures",name_en:"Departures",name_de:"Abfahrten"},{field:"cap",name_en:"Capacity",name_de:"Kapazität"},{field:"loadfac",name_en:"Load factor",name_de:"Load factor"}];try{let _='<div class="map-popup">';const M=t.features[C].properties;if(M.sort==0)return null;for(const o of z){let a=m=="de"?o.name_de:o.name_en;a=a.replaceAll(" ","&nbsp;"),Number.isFinite(M[o.field])&&(_+=`
            <div style="display: flex">
              <div>${a}:&nbsp;&nbsp;</div>
              <b style="margin-left: auto; text-align: right">${M[o.field]}</b>
            </div>`)}return _+="</div>",{html:_,style:{fontSize:"0.8rem",color:p?"#ccc":"#223",backgroundColor:p?"#2a3c4f":"white",margin:"2rem 0 0rem 0rem"}}}catch{return null}}const F=zt.DEFAULT,B=c&&c!=="Atlantis",y=[];return y.push(new Mt({id:"linkLayer",data:D,getSourcePosition:f=>f.source,getTargetPosition:f=>f.target,getColor:f=>f.color,getWidth:f=>f.width,widthUnits:"pixels",widthScale:u/50,widthMinPixels:1.5,widthMaxPixels:50,pickable:!0,coordinateSystem:F,opacity:1,autoHighlight:!1,offsetDirection:ot.RIGHT,parameters:{depthTest:!0},transitions:{getColor:200,getWidth:200}})),s.length&&y.push(new Et({id:"selected-links",data:s,getLineColor:Q(p?"#fbff66":"#ccff66"),getLineWidth:1,lineWidthUnits:"pixels",stroked:!0,filled:!1,pickable:!1,coordinateSystem:F,opacity:1,autoHighlight:!1,offsetDirection:ot.RIGHT,parameters:{depthTest:!1}})),E.length&&y.push(new Ft({id:`stop-pie-charts-layer-${Math.random()}`,data:E,getPolygon:f=>f.polygon,getFillColor:f=>f.color,stroked:!1,filled:!0,pickable:!0,opacity:1,sizeScale:1,autoHighlight:!1,parameters:{depthTest:!1}})),et.createElement(It,{layers:y,viewState:v,controller:!0,pickingRadius:3,parameters:{blend:!1},getTooltip:P,getCursor:({isDragging:f,isHovering:k})=>f?"grabbing":k?"pointer":"grab",onClick:x,onViewStateChange:f=>T(f.viewState)},B&&et.createElement(Pt,{mapStyle:O.getters.mapStyle,mapboxApiAccessToken:ft}))}const Wt=W({name:"LegendBox",props:{rows:{type:Array,required:!0}},methods:{handleClick(e){this.$emit("item-clicked",e)}}});var Yt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"legend-container"},[s("p",{staticClass:"control-label"},[t._v("Legend")]),t._l(t.rows,function(i){return s("div",{key:i[0],staticClass:"legend-item",on:{click:function(n){return t.handleClick(i)}}},[s("div",{staticClass:"legend-col-1",style:{"background-color":i[0]}}),s("span",{staticClass:"legend-col-2"},[t._v(t._s(i[1]))])])})],2)},Kt=[],Gt=Y(Wt,Yt,Kt,!1,null,"fbd46ee2");const Vt=Gt.exports,Ut=W({name:"RouteDropdown",components:{},props:{source:{type:Object,required:!0},index:{type:Number,required:!0},selectedRoutes:{type:Array,required:!0},searchTerm:{type:String,required:!0},activeTransitLines:{type:Object,required:!0},color:String,cbToggleLineOpen:{type:Function,required:!0},cbToggleLineChecked:{type:Function,required:!0},cbToggleRouteChecked:{type:Function,required:!0}},data(){return{lineCheck:0,isChecked:!1,isOpen:!1,isPartial:!1,checkStates:{},stats:{departures:0,pax:0,loadfac:0}}},mounted(){this.isPartial=!1,this.isChecked=this.line.checked,this.isOpen=this.line.isOpen,this.selectedRoutes.forEach(e=>this.checkStates[e]=!0);for(const e of this.line.transitRoutes)e.departures&&(this.stats.departures+=e.departures),e.pax&&(this.stats.pax+=e.pax),e.loadfac&&(this.stats.loadfac+=e.loadfac);this.stats.loadfac=.001*Math.round(1e3*this.stats.loadfac),this.setRouteCheckmarks()},computed:{lineCheckActive(){return this.lineCheck!==0},line(){return this.source}},watch:{activeTransitLines(){this.line.id in this.activeTransitLines&&(this.stats=this.activeTransitLines[this.line.id].stats)},selectedRoutes(){this.setRouteCheckmarks(),this.selectedRoutes.length||(this.isChecked=!1)}},methods:{setRouteCheckmarks(){let e=0;this.isPartial=!1,this.checkStates={},this.line.transitRoutes.forEach(t=>{this.selectedRoutes.indexOf(t.id)>-1&&(this.checkStates[t.id]=!0,e++)}),this.lineCheck=0,e&&e==this.line.transitRoutes.length&&(this.isChecked=!0,this.lineCheck=2),e&&e<this.line.transitRoutes.length&&(this.lineCheck=1,this.isPartial=!0)},toggleCheck(){this.isChecked=!this.isChecked,this.cbToggleLineChecked({offset:this.line.offset,isChecked:this.isChecked})},toggleOpen(){this.isOpen=!this.isOpen,this.setRouteCheckmarks(),this.cbToggleLineOpen({offset:this.line.offset,isOpen:this.isOpen})},toggleRoute(e){this.cbToggleRouteChecked({route:e,offset:this.line.offset,isChecked:this.checkStates[e]})}}});var Jt=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"route-dropdown flex-col",class:{"is-open":t.isOpen}},[s("div",{staticClass:"title-panel flex-row"},[s("div",{staticClass:"leftside flex-row flex1",on:{click:function(i){return i.preventDefault(),t.toggleCheck.apply(null,arguments)}}},[s("div",{staticClass:"mode-color-strip"}),s("b-checkbox",{staticClass:"fade",class:{faded:t.isPartial},attrs:{size:"is-small"},model:{value:t.lineCheckActive,callback:function(i){t.lineCheckActive=i},expression:"lineCheckActive"}}),s("div",{staticClass:"text-area flex-col"},[t.line.name?s("div",{staticClass:"line-title flex-row"},[t._v(t._s(t.line.name)),s("div",{staticClass:"span",staticStyle:{"font-weight":"normal"}},[t._v("  /  "+t._s(t.line.id))])]):s("div",{staticClass:"line-title"},[t._v(t._s(t.line.id))]),s("div",{staticClass:"metrics flex-row"},[s("div",{staticClass:"stat"},[t._v(t._s(t.stats.departures)+" deps")]),t.stats.pax?s("div",{staticClass:"stat"},[t._v(t._s(t.stats.pax)+" pax")]):t._e(),t.stats.loadfac?s("div",{staticClass:"stat"},[t._v(t._s(t.stats.loadfac.toFixed(3))+" Lfac")]):t._e()])])],1),s("div",{staticClass:"rightside flex-row"},[s("a",{staticClass:"card-header-icon",on:{click:t.toggleOpen}},[s("b-icon",{staticClass:"icon-reveal",attrs:{size:"is-small",icon:t.isOpen?"menu-down":"menu-up"}})],1)])]),t.isOpen?s("div",{staticClass:"card-details flex-col"},t._l(this.line.transitRoutes,function(i){return s("div",{key:i.id,staticClass:"route flex-row"},[s("div",{staticClass:"stuff flex-col"},[s("b-checkbox",{staticClass:"route-checkbox",attrs:{size:"is-small"},on:{input:function(n){return t.toggleRoute(i.id)}},model:{value:t.checkStates[i.id],callback:function(n){t.$set(t.checkStates,i.id,n)},expression:"checkStates[route.id]"}},[s("div",{staticClass:"route-title"},[t._v(t._s(i.id))])]),s("div",{staticClass:"service-period"},[t._v(t._s(i.firstDeparture)+" — "+t._s(i.lastDeparture))]),s("div",{staticClass:"detail flex-row"},[s("div",{staticClass:"deps"},[t._v("Deps: "+t._s(i.departures))]),i.pax?s("div",{staticClass:"deps clink"},[t._v("Pax: "+t._s(i.pax))]):t._e(),i.pax?s("div",{staticClass:"deps clink"},[t._v("Lfac: "+t._s(i.loadfac.toFixed(3)))]):t._e(),i.cap?s("div",{staticClass:"deps clink"},[t._v("Cap: "+t._s(i.cap))]):t._e()])],1)])}),0):t._e()])},Zt=[],Qt=Y(Ut,Jt,Zt,!1,null,"dea5530d");const G=Qt.exports;var ht={exports:{}};/*!
 * vue-virtual-scroll-list v2.3.4
 * open source under the MIT license
 * https://github.com/tangbc/vue-virtual-scroll-list#readme
 */(function(e,t){(function(s,i){e.exports=i(pt)})(mt,function(s){s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;function i(o,a){var r=Object.keys(o);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(o);a&&(l=l.filter(function(g){return Object.getOwnPropertyDescriptor(o,g).enumerable})),r.push.apply(r,l)}return r}function n(o){for(var a=1;a<arguments.length;a++){var r=arguments[a]!=null?arguments[a]:{};a%2?i(Object(r),!0).forEach(function(l){u(o,l,r[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach(function(l){Object.defineProperty(o,l,Object.getOwnPropertyDescriptor(r,l))})}return o}function c(o,a){if(!(o instanceof a))throw new TypeError("Cannot call a class as a function")}function d(o,a){for(var r=0;r<a.length;r++){var l=a[r];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(o,l.key,l)}}function h(o,a,r){return a&&d(o.prototype,a),Object.defineProperty(o,"prototype",{writable:!1}),o}function u(o,a,r){return a in o?Object.defineProperty(o,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):o[a]=r,o}function p(o){return m(o)||v(o)||b(o)||E()}function m(o){if(Array.isArray(o))return D(o)}function v(o){if(typeof Symbol<"u"&&o[Symbol.iterator]!=null||o["@@iterator"]!=null)return Array.from(o)}function b(o,a){if(o){if(typeof o=="string")return D(o,a);var r=Object.prototype.toString.call(o).slice(8,-1);if(r==="Object"&&o.constructor&&(r=o.constructor.name),r==="Map"||r==="Set")return Array.from(o);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(o,a)}}function D(o,a){(a==null||a>o.length)&&(a=o.length);for(var r=0,l=new Array(a);r<a;r++)l[r]=o[r];return l}function E(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var x={FRONT:"FRONT",BEHIND:"BEHIND"},T={INIT:"INIT",FIXED:"FIXED",DYNAMIC:"DYNAMIC"},P=0,F=function(){function o(a,r){c(this,o),this.init(a,r)}return h(o,[{key:"init",value:function(r,l){this.param=r,this.callUpdate=l,this.sizes=new Map,this.firstRangeTotalSize=0,this.firstRangeAverageSize=0,this.fixedSizeValue=0,this.calcType=T.INIT,this.offset=0,this.direction="",this.range=Object.create(null),r&&this.checkRange(0,r.keeps-1)}},{key:"destroy",value:function(){this.init(null,null)}},{key:"getRange",value:function(){var r=Object.create(null);return r.start=this.range.start,r.end=this.range.end,r.padFront=this.range.padFront,r.padBehind=this.range.padBehind,r}},{key:"isBehind",value:function(){return this.direction===x.BEHIND}},{key:"isFront",value:function(){return this.direction===x.FRONT}},{key:"getOffset",value:function(r){return(r<1?0:this.getIndexOffset(r))+this.param.slotHeaderSize}},{key:"updateParam",value:function(r,l){var g=this;this.param&&r in this.param&&(r==="uniqueIds"&&this.sizes.forEach(function(S,L){l.includes(L)||g.sizes.delete(L)}),this.param[r]=l)}},{key:"saveSize",value:function(r,l){this.sizes.set(r,l),this.calcType===T.INIT?(this.fixedSizeValue=l,this.calcType=T.FIXED):this.calcType===T.FIXED&&this.fixedSizeValue!==l&&(this.calcType=T.DYNAMIC,delete this.fixedSizeValue),this.calcType!==T.FIXED&&typeof this.firstRangeTotalSize<"u"&&(this.sizes.size<Math.min(this.param.keeps,this.param.uniqueIds.length)?(this.firstRangeTotalSize=p(this.sizes.values()).reduce(function(g,S){return g+S},0),this.firstRangeAverageSize=Math.round(this.firstRangeTotalSize/this.sizes.size)):delete this.firstRangeTotalSize)}},{key:"handleDataSourcesChange",value:function(){var r=this.range.start;this.isFront()?r=r-P:this.isBehind()&&(r=r+P),r=Math.max(r,0),this.updateRange(this.range.start,this.getEndByStart(r))}},{key:"handleSlotSizeChange",value:function(){this.handleDataSourcesChange()}},{key:"handleScroll",value:function(r){this.direction=r<this.offset||r===0?x.FRONT:x.BEHIND,this.offset=r,this.param&&(this.direction===x.FRONT?this.handleFront():this.direction===x.BEHIND&&this.handleBehind())}},{key:"handleFront",value:function(){var r=this.getScrollOvers();if(!(r>this.range.start)){var l=Math.max(r-this.param.buffer,0);this.checkRange(l,this.getEndByStart(l))}}},{key:"handleBehind",value:function(){var r=this.getScrollOvers();r<this.range.start+this.param.buffer||this.checkRange(r,this.getEndByStart(r))}},{key:"getScrollOvers",value:function(){var r=this.offset-this.param.slotHeaderSize;if(r<=0)return 0;if(this.isFixedType())return Math.floor(r/this.fixedSizeValue);for(var l=0,g=0,S=0,L=this.param.uniqueIds.length;l<=L;){if(g=l+Math.floor((L-l)/2),S=this.getIndexOffset(g),S===r)return g;S<r?l=g+1:S>r&&(L=g-1)}return l>0?--l:0}},{key:"getIndexOffset",value:function(r){if(!r)return 0;for(var l=0,g=0,S=0;S<r;S++)g=this.sizes.get(this.param.uniqueIds[S]),l=l+(typeof g=="number"?g:this.getEstimateSize());return l}},{key:"isFixedType",value:function(){return this.calcType===T.FIXED}},{key:"getLastIndex",value:function(){return this.param.uniqueIds.length-1}},{key:"checkRange",value:function(r,l){var g=this.param.keeps,S=this.param.uniqueIds.length;S<=g?(r=0,l=this.getLastIndex()):l-r<g-1&&(r=l-g+1),this.range.start!==r&&this.updateRange(r,l)}},{key:"updateRange",value:function(r,l){this.range.start=r,this.range.end=l,this.range.padFront=this.getPadFront(),this.range.padBehind=this.getPadBehind(),this.callUpdate(this.getRange())}},{key:"getEndByStart",value:function(r){var l=r+this.param.keeps-1,g=Math.min(l,this.getLastIndex());return g}},{key:"getPadFront",value:function(){return this.isFixedType()?this.fixedSizeValue*this.range.start:this.getIndexOffset(this.range.start)}},{key:"getPadBehind",value:function(){var r=this.range.end,l=this.getLastIndex();return this.isFixedType()?(l-r)*this.fixedSizeValue:(l-r)*this.getEstimateSize()}},{key:"getEstimateSize",value:function(){return this.isFixedType()?this.fixedSizeValue:this.firstRangeAverageSize||this.param.estimateSize}}]),o}(),B={dataKey:{type:[String,Function],required:!0},dataSources:{type:Array,required:!0},dataComponent:{type:[Object,Function],required:!0},keeps:{type:Number,default:30},extraProps:{type:Object},estimateSize:{type:Number,default:50},direction:{type:String,default:"vertical"},start:{type:Number,default:0},offset:{type:Number,default:0},topThreshold:{type:Number,default:0},bottomThreshold:{type:Number,default:0},pageMode:{type:Boolean,default:!1},rootTag:{type:String,default:"div"},wrapTag:{type:String,default:"div"},wrapClass:{type:String,default:""},wrapStyle:{type:Object},itemTag:{type:String,default:"div"},itemClass:{type:String,default:""},itemClassAdd:{type:Function},itemStyle:{type:Object},headerTag:{type:String,default:"div"},headerClass:{type:String,default:""},headerStyle:{type:Object},footerTag:{type:String,default:"div"},footerClass:{type:String,default:""},footerStyle:{type:Object},itemScopedSlots:{type:Object}},y={index:{type:Number},event:{type:String},tag:{type:String},horizontal:{type:Boolean},source:{type:Object},component:{type:[Object,Function]},slotComponent:{type:Function},uniqueKey:{type:[String,Number]},extraProps:{type:Object},scopedSlots:{type:Object}},f={event:{type:String},uniqueKey:{type:String},tag:{type:String},horizontal:{type:Boolean}},k={created:function(){this.shapeKey=this.horizontal?"offsetWidth":"offsetHeight"},mounted:function(){var a=this;typeof ResizeObserver<"u"&&(this.resizeObserver=new ResizeObserver(function(){a.dispatchSizeChange()}),this.resizeObserver.observe(this.$el))},updated:function(){this.resizeObserver.observe(this.$el)},beforeDestroy:function(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)},methods:{getCurrentSize:function(){return this.$el?this.$el[this.shapeKey]:0},dispatchSizeChange:function(){this.$parent.$emit(this.event,this.uniqueKey,this.getCurrentSize(),this.hasInitial)}}},C=s.component("virtual-list-item",{mixins:[k],props:y,render:function(a){var r=this.tag,l=this.component,g=this.extraProps,S=g===void 0?{}:g,L=this.index,w=this.source,R=this.scopedSlots,N=R===void 0?{}:R,X=this.uniqueKey,$=this.slotComponent,H=n(n({},S),{},{source:w,index:L});return a(r,{key:X,attrs:{role:"listitem"}},[$?$({item:w,index:L,scope:H}):a(l,{props:H,scopedSlots:N})])}}),A=s.component("virtual-list-slot",{mixins:[k],props:f,render:function(a){var r=this.tag,l=this.uniqueKey;return a(r,{key:l,attrs:{role:l}},this.$slots.default)}}),z={ITEM:"item_resize",SLOT:"slot_resize"},_={HEADER:"thead",FOOTER:"tfoot"},M=s.component("virtual-list",{props:B,data:function(){return{range:null}},watch:{"dataSources.length":function(){this.virtual.updateParam("uniqueIds",this.getUniqueIdFromDataSources()),this.virtual.handleDataSourcesChange()},keeps:function(a){this.virtual.updateParam("keeps",a),this.virtual.handleSlotSizeChange()},start:function(a){this.scrollToIndex(a)},offset:function(a){this.scrollToOffset(a)}},created:function(){this.isHorizontal=this.direction==="horizontal",this.directionKey=this.isHorizontal?"scrollLeft":"scrollTop",this.installVirtual(),this.$on(z.ITEM,this.onItemResized),(this.$slots.header||this.$slots.footer)&&this.$on(z.SLOT,this.onSlotResized)},activated:function(){this.scrollToOffset(this.virtual.offset),this.pageMode&&document.addEventListener("scroll",this.onScroll,{passive:!1})},deactivated:function(){this.pageMode&&document.removeEventListener("scroll",this.onScroll)},mounted:function(){this.start?this.scrollToIndex(this.start):this.offset&&this.scrollToOffset(this.offset),this.pageMode&&(this.updatePageModeFront(),document.addEventListener("scroll",this.onScroll,{passive:!1}))},beforeDestroy:function(){this.virtual.destroy(),this.pageMode&&document.removeEventListener("scroll",this.onScroll)},methods:{getSize:function(a){return this.virtual.sizes.get(a)},getSizes:function(){return this.virtual.sizes.size},getOffset:function(){if(this.pageMode)return document.documentElement[this.directionKey]||document.body[this.directionKey];var a=this.$refs.root;return a?Math.ceil(a[this.directionKey]):0},getClientSize:function(){var a=this.isHorizontal?"clientWidth":"clientHeight";if(this.pageMode)return document.documentElement[a]||document.body[a];var r=this.$refs.root;return r?Math.ceil(r[a]):0},getScrollSize:function(){var a=this.isHorizontal?"scrollWidth":"scrollHeight";if(this.pageMode)return document.documentElement[a]||document.body[a];var r=this.$refs.root;return r?Math.ceil(r[a]):0},scrollToOffset:function(a){if(this.pageMode)document.body[this.directionKey]=a,document.documentElement[this.directionKey]=a;else{var r=this.$refs.root;r&&(r[this.directionKey]=a)}},scrollToIndex:function(a){if(a>=this.dataSources.length-1)this.scrollToBottom();else{var r=this.virtual.getOffset(a);this.scrollToOffset(r)}},scrollToBottom:function(){var a=this,r=this.$refs.shepherd;if(r){var l=r[this.isHorizontal?"offsetLeft":"offsetTop"];this.scrollToOffset(l),setTimeout(function(){a.getOffset()+a.getClientSize()+1<a.getScrollSize()&&a.scrollToBottom()},3)}},updatePageModeFront:function(){var a=this.$refs.root;if(a){var r=a.getBoundingClientRect(),l=a.ownerDocument.defaultView,g=this.isHorizontal?r.left+l.pageXOffset:r.top+l.pageYOffset;this.virtual.updateParam("slotHeaderSize",g)}},reset:function(){this.virtual.destroy(),this.scrollToOffset(0),this.installVirtual()},installVirtual:function(){this.virtual=new F({slotHeaderSize:0,slotFooterSize:0,keeps:this.keeps,estimateSize:this.estimateSize,buffer:Math.round(this.keeps/3),uniqueIds:this.getUniqueIdFromDataSources()},this.onRangeChanged),this.range=this.virtual.getRange()},getUniqueIdFromDataSources:function(){var a=this.dataKey;return this.dataSources.map(function(r){return typeof a=="function"?a(r):r[a]})},onItemResized:function(a,r){this.virtual.saveSize(a,r),this.$emit("resized",a,r)},onSlotResized:function(a,r,l){a===_.HEADER?this.virtual.updateParam("slotHeaderSize",r):a===_.FOOTER&&this.virtual.updateParam("slotFooterSize",r),l&&this.virtual.handleSlotSizeChange()},onRangeChanged:function(a){this.range=a},onScroll:function(a){var r=this.getOffset(),l=this.getClientSize(),g=this.getScrollSize();r<0||r+l>g+1||!g||(this.virtual.handleScroll(r),this.emitEvent(r,l,g,a))},emitEvent:function(a,r,l,g){this.$emit("scroll",g,this.virtual.getRange()),this.virtual.isFront()&&this.dataSources.length&&a-this.topThreshold<=0?this.$emit("totop"):this.virtual.isBehind()&&a+r+this.bottomThreshold>=l&&this.$emit("tobottom")},getRenderSlots:function(a){for(var r=[],l=this.range,g=l.start,S=l.end,L=this.dataSources,w=this.dataKey,R=this.itemClass,N=this.itemTag,X=this.itemStyle,$=this.isHorizontal,H=this.extraProps,K=this.dataComponent,V=this.itemScopedSlots,U=this.$scopedSlots&&this.$scopedSlots.item,I=g;I<=S;I++){var j=L[I];if(j){var q=typeof w=="function"?w(j):j[w];typeof q=="string"||typeof q=="number"?r.push(a(C,{props:{index:I,tag:N,event:z.ITEM,horizontal:$,uniqueKey:q,source:j,extraProps:H,component:K,slotComponent:U,scopedSlots:V},style:X,class:"".concat(R).concat(this.itemClassAdd?" "+this.itemClassAdd(I):"")})):console.warn("Cannot get the data-key '".concat(w,"' from data-sources."))}else console.warn("Cannot get the index '".concat(I,"' from data-sources."))}return r}},render:function(a){var r=this.$slots,l=r.header,g=r.footer,S=this.range,L=S.padFront,w=S.padBehind,R=this.isHorizontal,N=this.pageMode,X=this.rootTag,$=this.wrapTag,H=this.wrapClass,K=this.wrapStyle,V=this.headerTag,U=this.headerClass,I=this.headerStyle,j=this.footerTag,q=this.footerClass,dt=this.footerStyle,tt={padding:R?"0px ".concat(w,"px 0px ").concat(L,"px"):"".concat(L,"px 0px ").concat(w,"px")},ut=K?Object.assign({},K,tt):tt;return a(X,{ref:"root",on:{"&scroll":!N&&this.onScroll}},[l?a(A,{class:U,style:I,props:{tag:V,event:z.SLOT,uniqueKey:_.HEADER}},l):null,a($,{class:H,attrs:{role:"group"},style:ut},this.getRenderSlots(a)),g?a(A,{class:q,style:dt,props:{tag:j,event:z.SLOT,uniqueKey:_.FOOTER}},g):null,a("div",{ref:"shepherd",style:{width:R?"0px":"100%",height:R?"100%":"0px"}})])}});return M})})(ht);var te=ht.exports;const ee=gt(te),se=W({name:"RouteDropdown",components:{RouteDropDown:G,VirtualList:ee},props:{highlightedTransitLines:{type:Array,required:!0},listProps:{type:Object,required:!0}},data(){return{listComponent:G}},watch:{"listProps.activeTransitLines"(){}},computed:{visibleLines(){return this.highlightedTransitLines.map((e,t)=>(e.offset=t,e)).filter(e=>e.show)}}});var ie=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("virtual-list",{staticClass:"my-list",attrs:{"data-sources":t.visibleLines,"data-key":"id","data-component":t.listComponent,keeps:48,"estimate-size":48,"extra-props":t.listProps}})},re=[],ae=Y(se,ie,re,!1,null,"b40e4d1c");const oe=ae.exports,ne="/assets/icon-pie-chart-BS7BHQ_l.png",le="/assets/icon-blue-ramp-D1d4h-6x.png",ce={messages:{en:{metrics:"Metrics",viewer:"Transit Network"},de:{metrics:"Metrics",viewer:"ÖV Netzwerk"}}},he="EPSG:31468",de=10,lt=[{match:{gtfsRouteType:[3,700,701,702,703,704]},color:"#95276E",label:"Bus (GTFS)"},{match:{gtfsRouteType:[109]},color:"#408335",label:"S-Bahn (GTFS)"},{match:{gtfsRouteType:[401,402]},color:"#115D91",label:"U-Bahn (GTFS)"},{match:{gtfsRouteType:[0,3,900,901,902,903,904,905,906]},color:"#BE1414",label:"Tram (GTFS)"},{match:{gtfsRouteType:[4,1e3,1200]},color:"#0480c1",label:"Ferry (GTFS)"},{match:{transportMode:["rail","subway"],id:"U*"},color:"#115D91",label:"U-Bahn"},{match:{transportMode:"rail",id:"S*"},color:"#408335",label:"S-Bahn"},{match:{transportMode:"ferry"},color:"#0480c1",label:"Ferry"},{match:{transportMode:"tram"},color:"#9E1444",label:"Tram"},{match:{transportMode:"pt"},color:"#05c",label:"Public Transport"},{match:{transportMode:"rail"},color:"#EC0016 ",label:"Train"},{match:{transportMode:"train"},color:"#0a0",label:"Rail"},{match:{transportMode:"bus"},color:"#95276E",label:"Bus"},{match:{id:"**"},color:"#aae",label:"Other"}],ue=W({name:"TransitViewer",i18n:ce,components:{CollapsiblePanel:wt,DrawingTool:Ot,LeftDataPanel:Nt,LegendBox:Vt,RouteDropDown:G,TransitLayers:qt,ZoomButtons:Dt,LazyList:oe},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:{type:Object},thumbnail:Boolean,datamanager:{type:Object}},data(){const e=[{field:"departures",name_en:"Departures",name_de:"Abfahrten"}];return{viewId:Math.floor(1e12*Math.random()),icons:{piechart:ne,blueramp:le},loadProgress:0,loadSteps:0,totalLoadSteps:7,searchText:"",isDraggingDivider:0,dragStartWidth:250,legendSectionWidth:275,stopHTML:{html:"",x:0,y:0},buttonColors:["#5E8AAE","#BF7230","#269367","#9C439C"],metrics:e,activeMetric:e[0].field,activeRoutes:[],checkedTransitLines:[],vizDetails:{transitSchedule:"",network:"",demand:"",projection:"",title:"",description:"",colors:[]},myDataManager:this.datamanager||new Rt(this.root,this.subfolder),debounceHandleSearchText:{},myState:{subfolder:"",yamlConfig:"",thumbnail:!0},avroNetwork:null,isDarkMode:O.state.isDarkMode,isMapMoving:!1,isHighlightingLink:!1,loadingText:"MATSim Transit Inspector",projection:he,routesOnLink:[],selectedLinkId:"",selectedRouteIds:[],selectedTransitLine:"",selectedFeatures:[],summaryStats:{departures:0,pax:0,loadfac:0},stopMarkers:[],_departures:{},_mapExtentXYXY:null,_maximum:-1/0,_network:{},transitLinks:{type:"FeatureCollection",features:[]},transitLinkOffset:{},routeData:{},_stopFacilities:{},transitLines:[],highlightedTransitLineIds:new Set,_roadFetcher:{},_transitFetcher:{},_transitHelper:{},pieSlider:30,widthSlider:50,resolvers:{},resolverId:0,xmlWorker:null,cfDemand1:null,cfDemand2:null,cfDemandLink1:null,cfDemandLink2:null,cfDemandStop1:null,cfDemandStop2:null,stopLevelDemand:{},routeColors:[],usedLabels:[],listComponent:G}},computed:{fileApi(){return new Tt(this.fileSystem,O)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},routeListProps(){return{activeTransitLines:this.activeTransitLines,selectedRoutes:this.selectedRouteIds,searchTerm:this.searchTermClean,color:"#06f",cbToggleLineChecked:this.toggleLineChecked,cbToggleLineOpen:this.toggleLineOpen,cbToggleRouteChecked:this.toggleRouteChecked}},searchTermClean(){return this.searchText.trim().toLocaleLowerCase()},highlightedTransitLines(){const e=!this.highlightedTransitLineIds.size;return this.transitLines.forEach(t=>{t.show=e||this.highlightedTransitLineIds.has(t.id)}),[...this.transitLines]},activeTransitLines(){const e={};if(this.routesOnLink.forEach(i=>{i.lineId in e||(e[i.lineId]={id:i.lineId,routes:[],isOpen:!1,stats:{departures:0,pax:0,cap:0}}),e[i.lineId].routes.push(i)}),!this.selectedLinkId)return e;const t={};this.cfDemandStop1?.filterAll(),this.cfDemandStop2?.filterAll(),this.cfDemandLink1?.filter(i=>i.indexOf(this.selectedLinkId)>-1);let s=this.cfDemand1?.allFiltered();return s&&s.forEach(i=>{i.transitRoute in t||(t[i.transitRoute]=[]),t[i.transitRoute].push(i)}),this.cfDemandLink2?.filter(i=>i.indexOf(this.selectedLinkId)>-1),s=this.cfDemand2?.allFiltered(),s&&s.forEach(i=>{i.transitRoute in t||(t[i.transitRoute]=[]),t[i.transitRoute].push(i)}),Object.values(e).forEach(i=>{i.routes.sort((n,c)=>rt(n.id,c.id)),i.routes.forEach(n=>{n.pax=0,n.cap=0,i.stats.departures+=n.departures;const c=t[n.id];if(c){const d=c.reduce((u,p)=>u+p.passengersAtArrival,0);i.stats.pax+=d,n.pax+=d;const h=c.reduce((u,p)=>u+p.totalVehicleCapacity,0);i.stats.cap+=h,n.cap+=h}n.loadfac=n.pax/n.cap})}),e},legendRows(){return this.routeColors.filter(e=>this.usedLabels.includes(e.label)).map(e=>[e.color,e.label])}},watch:{"$store.state.viewState"(){Z[this.viewId]&&Z[this.viewId]()},"$store.state.colorScheme"(){this.isDarkMode=this.$store.state.colorScheme===vt.DarkMode,this.highlightAllAttachedRoutes()},selectedRouteIds(){this.showTransitRoutes(),this.showTransitStops(),this.updateSummaryStats()},searchText(){this.debounceHandleSearchText()}},methods:{clickedLegend(e){console.log("boop!",e)},toggleRouteChecked(e){e.isChecked?this.routesOnLink.push(this.routeData[e.route]):this.routesOnLink=this.routesOnLink.filter(t=>t.id!==e.route),this.routesOnLink.length?this.highlightAllAttachedRoutes():(this.selectedLinkId="",this.resetLinkColors(),this.highlightedTransitLineIds=new Set,this.transitLinks={...this.transitLinks}),this.selectedRouteIds=this.routesOnLink.map(t=>t.id)},toggleLineOpen(e){const t=this.transitLines[e.offset];t.isOpen=e.isOpen},toggleLineChecked(e){const t=this.transitLines[e.offset],s=t.id.toLocaleLowerCase();t.check=e.isChecked;const i=Object.values(this.routeData).filter(n=>n.lineId.toLocaleLowerCase()==s);if(t.check)i.forEach(n=>{this.selectedRouteIds.includes(n.id)||this.routesOnLink.push(n)}),this.selectedTransitLine=t.id;else{const n=i.map(c=>c.id);this.routesOnLink=this.routesOnLink.filter(c=>!n.includes(c.id))}this.selectedRouteIds=this.routesOnLink.map(n=>n.id),this.routesOnLink.length?this.highlightAllAttachedRoutes():(this.selectedLinkId="",this.resetLinkColors(),this.highlightedTransitLineIds=new Set,this.transitLinks={...this.transitLinks})},updateSummaryStats(){this.summaryStats={departures:0,pax:0,loadfac:0};for(const e of this.selectedRouteIds){const t=this.routeData[e];t.departures&&(this.summaryStats.departures+=t.departures),t.pax&&(this.summaryStats.pax+=t.pax)}},handleMapClick(e){if(e.index>-1&&e.layer?.id==="linkLayer")this.clickedOnTransitLink(e.index);else{if(e.index>-1)return;this.handleEmptyClick(!0,!1)}},incrementLoadProgress(){this.loadSteps+=1,this.loadProgress=100*this.loadSteps/this.totalLoadSteps},handleSearchText(){this.handleEmptyClick(null,!0),this.selectedLinkId="";const e=this.searchText.trim().toLocaleLowerCase();if(!e){this.resetLinkColors();return}let t=Object.keys(this.routeData).filter(i=>i.toLocaleLowerCase().indexOf(e)>-1);this.routesOnLink=t.map(i=>this.routeData[i]),this.highlightAllAttachedRoutes();const s=this.transitLines.filter(i=>i.id.toLocaleLowerCase().indexOf(e)>-1).map(i=>i.id);this.highlightedTransitLineIds=new Set(s),this.selectedRouteIds=this.routesOnLink.map(i=>i.id)},hoverOverStop(e,t){this.stopHTML.html="";const s=[];e.name&&s.push(`<b>${e.name}</b>`);for(const i of["id","linkRefId"])e[i]&&s.push(`${i}: ${e[i]}`);this.stopHTML.html="<p>"+s.join("<br/>")+"</p>",this.stopHTML.x=e.xy.x+8,this.stopHTML.y=e.xy.y-36},dividerDragStart(e){console.log("dragstart"),this.isDraggingDivider=e.clientX,this.dragStartWidth=this.legendSectionWidth},dividerDragEnd(e){this.isDraggingDivider=0},dividerDragging(e){if(!this.isDraggingDivider)return;const t=this.isDraggingDivider-e.clientX;this.legendSectionWidth=Math.max(0,this.dragStartWidth+t)},async getVizDetails(){if(this.config)return this.vizDetails=Object.assign({},this.config),!0;if(this.myState.yamlConfig?.endsWith("yaml")||this.myState.yamlConfig?.endsWith("yml"))return this.loadYamlConfig();const e=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("transitSchedule"));return this.vizDetails={transitSchedule:this.myState.yamlConfig,network:"",title:e,description:"",demand:"",projection:"",colors:[]},this.$emit("title",e),!0},async findInputFiles(){const{files:e}=await this.fileApi.getDirectory(this.myState.subfolder);let t=this.vizDetails.network;if(!t){const i=e.filter(n=>n.toLocaleLowerCase().endsWith(".avro")).filter(n=>n.toLocaleLowerCase().indexOf("network")>-1);i.length&&(t=i[0]),i.length>1&&console.warn("MULTIPLE Avro files found - using first of ",i)}if(t||(t=this.myState.yamlConfig.replaceAll("transitSchedule","network")),e.indexOf(t)==-1){const i=e.filter(n=>n.endsWith("network.xml.gz"));i.length?t=i[0]:(this.loadingText="No road network found.",t="")}let s=[];if(this.myState.yamlConfig.indexOf("output_transitSchedule")>-1)try{s=(await this.fileApi.getDirectory(`${this.myState.subfolder}/analysis/pt/`)).files.filter(n=>n.endsWith("pt_pax_volumes.csv.gz"))}catch(i){console.warn("error",""+i)}this.vizDetails.network=t,s.length&&(this.vizDetails.demand=`analysis/pt/${s[0]}`)},async guessProjection(e){if(this.vizDetails.projection)return this.vizDetails.projection;if(this.config?.projection)return this.config.projection;if(e?.roadXML?.crs)return e?.roadXML?.crs;if(e?.roadXML?.network?.attributes?.attribute?.name==="coordinateReferenceSystem")return e?.roadXML?.network?.attributes?.attribute["#text"];const t=`${this.root}/${this.subfolder}`,s=/EPSG:.\d/,{files:i}=await this.fileApi.getDirectory(this.myState.subfolder),n=i.filter(h=>h.indexOf(".output_config.xml")>-1||h.indexOf(".output_config_reduced.xml")>-1);if(n.length&&this.fileSystem)for(const h of n)try{return(await this.fetchXML({worker:null,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+h})).config.module.filter(b=>b.$name==="global")[0].param.filter(b=>b.$name==="coordinateSystem")[0].$value}catch{console.warn("Failed parsing",h)}let c=prompt("Need coordinate EPSG number:","")||"";if(!c)return"";if(Number.isNaN(parseInt(c,10))&&!s.test(c))return this.guessProjection(e);c.startsWith("EPSG:")||(c="EPSG:"+c);const d=c;return localStorage.setItem(t,JSON.stringify({networkProjection:d})),d},async loadYamlConfig(){const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig;try{const s=await this.fileApi.getFileText(e);this.vizDetails=_t.parse(s)}catch(s){const i=s;if(this.fileSystem&&this.fileSystem.needPassword&&i.status===401)this.$store.commit("requestLogin",this.fileSystem.slug);else{const n="Could not load "+e;this.$emit("error",n),this.loadingText=n}return!1}const t=this.vizDetails.title?this.vizDetails.title:"Transit Ridership";return this.$emit("title",t),this.projection=this.vizDetails.projection,!0},isMobile(){const e=window,t=document,s=t.documentElement,i=t.getElementsByTagName("body")[0],n=e.innerWidth||s.clientWidth||i.clientWidth;return e.innerHeight||s.clientHeight||i.clientHeight,n<640},drawMetric(){this.transitLinks.features.forEach(e=>{let t=1;switch(this.activeMetric){case"departures":t=e.properties.departures*.025;break;case"pax":t=e.properties.pax*15e-5;break;case"loadfac":t=e.properties.loadfac*25;break}e.properties.width=t}),this.transitLinks={...this.transitLinks}},handleClickedMetric(e){console.log("metric:",e.field),this.activeMetric=e.field,this.drawMetric()},handleEmptyClick(e,t){if(!e&&this.isHighlightingLink){this.isHighlightingLink=!1;return}this.isHighlightingLink=!1,this.highlightedTransitLineIds=new Set,t||(this.searchText=""),!(this.searchText&&!t)&&(this.removeStopMarkers(),this.removeSelectedRoute(),this.resetLinkColors(),this.routesOnLink=[],this.stopHTML.html="",this.summaryStats={departures:0,pax:0,loadfac:0},this.transitLinks={...this.transitLinks})},async loadEverything(){const e=await this.loadNetworks(),t=await this.guessProjection(e);this.vizDetails.projection=t,this.projection=this.vizDetails.projection,e&&this.processInputs(e)},setupKeyListeners(){window.addEventListener("keyup",e=>{e.keyCode===27&&this.pressedEscape()}),window.addEventListener("keydown",e=>{e.keyCode===38&&this.pressedArrowKey(-1),e.keyCode===40&&this.pressedArrowKey(1)})},fetchXML(e){let t=e.worker;t.onmessage=n=>{const{resolve:c,reject:d}=this.resolvers[n.data.id];t.terminate(),n.data.error&&d(n.data.error),c(n.data.xml)};const s=this.resolverId++;return t.postMessage({id:s,fileSystem:this.fileSystem,filePath:e.filePath,options:e.options}),new Promise((n,c)=>{this.resolvers[s]={resolve:n,reject:c}})},async updateStatus(e){this.loadingText=e},async loadAvroRoadNetwork(){console.log("LOADING AVRO:",this.vizDetails.network);const e=`${this.subfolder}/${this.vizDetails.network}`,t=await this.fileApi.getFileBlob(e),s=await new Promise((i,n)=>{const c=[];kt.createBlobDecoder(t).on("metadata",d=>{}).on("data",d=>{c.push(d)}).on("end",()=>{i(c)})});return this.avroNetwork=s[0],s[0]},async loadNetworks(){try{if(!this.fileSystem||!this.vizDetails.network||!this.vizDetails.transitSchedule)return;this.loadingText="Loading networks...",this.incrementLoadProgress();const t=this.vizDetails.network.indexOf(".avro")>-1?this.loadAvroRoadNetwork():this.fetchXML({worker:this._roadFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+this.vizDetails.network,options:{attributeNamePrefix:""}}),s=this.fetchXML({worker:this._transitFetcher,slug:this.fileSystem.slug,filePath:this.myState.subfolder+"/"+this.vizDetails.transitSchedule,options:{attributeNamePrefix:"",alwaysArray:["transitSchedule.transitLine.transitRoute","transitSchedule.transitLine.transitRoute.departures.departure"]}}),i=await Promise.all([t,s]);return{roadXML:i[0],transitXML:i[1],ridership:[]}}catch(e){return console.error("TRANSIT:",e),this.loadingText,this.$emit("error",""+e),null}},loadDemandData(e){return this.totalLoadSteps+=3,this.loadingText="Loading demand...",new Promise((s,i)=>{e||s([]),this.incrementLoadProgress();const n=new At;n.onmessage=c=>{if(this.loadingText="Processing demand...",this.incrementLoadProgress(),n.terminate(),c.data.error){this.$emit("error",c.data.error),this.loadingText="";return}const d=new TextDecoder("utf-8").decode(c.data);Lt.parse(d,{header:!0,skipEmptyLines:!0,dynamicTyping:!1,worker:!0,complete:h=>{const u=this.processDemand(h);s(u)}})},n.postMessage({filePath:this.myState.subfolder+"/"+e,fileSystem:this.fileSystem})})},processDemand(e){this.loadingText="Summarizing demand data...",this.incrementLoadProgress();const t=["passengersAlighting","passengersAtArrival","passengersBoarding","stopSequence","totalVehicleCapacity"];e.data.forEach(h=>{for(const u of t)h[u]=parseFloat(h[u])});const s=Math.floor(e.data.length/2),i=e.data.slice(0,s),n=e.data.slice(s);this.cfDemand1=it(i),this.cfDemand2=it(n),this.cfDemandLink1=this.cfDemand1.dimension(h=>h.linkIdsSincePreviousStop),this.cfDemandLink2=this.cfDemand2.dimension(h=>h.linkIdsSincePreviousStop);for(const h of e.data){const u=h.stop;this.stopLevelDemand[u]||(this.stopLevelDemand[u]={b:0,a:0}),this.stopLevelDemand[u].b+=h.passengersBoarding,this.stopLevelDemand[u].a+=h.passengersAlighting}console.log("---Calculating link-by-link pax/cap");const c={},d={};for(const h of e.data){const u=h.linkIdsSincePreviousStop.split(";");for(const p of u)c[p]||(c[p]=0),c[p]+=h.passengersAtArrival,d[p]||(d[p]=0),d[p]+=h.totalVehicleCapacity}for(const h of this.transitLinks.features)h.properties||(h.properties={}),h.properties.pax=c[h.properties.id],h.properties.cap=d[h.properties.id],h.properties.loadfac=Math.round(1e3*c[h.properties.id]/d[h.properties.id])/1e3;return this.metrics=this.metrics.concat([{field:"pax",name_en:"Passengers",name_de:"Passagiere"},{field:"loadfac",name_en:"Load Factor",name_de:"Auslastung"}]),this.loadProgress=100,[]},async processInputs(e){this.loadingText="Examining networks...",this.incrementLoadProgress(),this._transitHelper=new nt,this._transitHelper.onmessage=t=>{this.receivedProcessedTransit(t)},this._transitHelper.postMessage({xml:e,projection:this.projection})},async receivedProcessedTransit(e){if(e.data.status){this.loadingText=e.data.status,this.incrementLoadProgress();return}if(e.data.error){console.error(e.data.error),this.$emit("error",""+e.data.error),this.loadingText="";return}const{network:t,routeData:s,stopFacilities:i,transitLines:n,mapExtent:c}=e.data;this._network=t,this.routeData=s,this._stopFacilities=i,this.transitLines=n,this._mapExtentXYXY=c,this._transitHelper.terminate(),this.loadingText="Summarizing departures...",this.incrementLoadProgress();const d=this.vizDetails.customRouteTypes||this.vizDetails.colors||null;d&&Array.isArray(d)&&d.length>0?this.routeColors=d:d&&!Array.isArray(d)?(this.$emit("error","YAML colors must be a list of rules, see docs"),this.routeColors=lt):this.routeColors=lt,await this.processDepartures(),this.transitLinks=await this.constructDepartureFrequencyGeoJson(),this._network={links:{},nodes:{}},this.transitLinkOffset={},this.transitLinks.features.forEach((v,b)=>{this.transitLinkOffset[v.properties.id]=b}),this.drawMetric(),this.handleClickedMetric({field:"departures"});const h=.5*(this._mapExtentXYXY[0]+this._mapExtentXYXY[2]),u=.5*(this._mapExtentXYXY[1]+this._mapExtentXYXY[3]),p=Math.abs(this._mapExtentXYXY[0]-this._mapExtentXYXY[2]),m=Math.floor(Math.log2(360/p));this.$store.commit("setMapCamera",{longitude:h,latitude:u,zoom:m,initial:!0}),localStorage.setItem(this.$route.fullPath+"-bounds",JSON.stringify(this._mapExtentXYXY)),this.vizDetails.demand&&await this.loadDemandData(this.vizDetails.demand),this.loadingText=""},async processDepartures(){this.loadingText="Processing departures...",this.incrementLoadProgress();for(const e of this.transitLines){e.transitRoutes.sort((t,s)=>rt(t.id,s.id));for(const t of e.transitRoutes)for(const s of t.route)s in this._departures||(this._departures[s]={total:0,routes:new Set}),this._departures[s].total+=t.departures,this._departures[s].routes.add(t.id)}Object.values(this._departures).forEach(e=>this._maximum=Math.max(this._maximum,e.total))},async constructDepartureFrequencyGeoJson(){const e=[];this.usedLabels=[];const t=this.avroNetwork?.nodeCoordinates;for(const s in this._departures)if(this._departures.hasOwnProperty(s)){const i=this._network.links[s];if(i==null)continue;let n;try{if(this.avroNetwork){const m=2*this.avroNetwork.from[i],v=2*this.avroNetwork.to[i];n=[[t[m],t[1+m]],[t[v],t[1+v]]]}else n=[[this._network.nodes[i.from].x,this._network.nodes[i.from].y],[this._network.nodes[i.to].x,this._network.nodes[i.to].y]]}catch(m){console.warn(""+m);continue}const c=this._departures[s].total,h=[...this._departures[s].routes][0],{color:u,hideThisLine:p}=this.determineRouteColor(h);if(!p){let m={type:"Feature",geometry:{type:"LineString",coordinates:n},properties:{...this.$props,color:u,departures:c,id:s,from:i.from,to:i.to,currentColor:u}};m=this.offsetLineByMeters(m,5),e.push(m)}}return{type:"FeatureCollection",features:e}},determineRouteColor(e){let t="#888",s=!1;const i=this.routeData[e];for(const c of this.routeColors){s=!1,c.hide&&(s=!0);let d=!0,h=c.match;try{if(Array.isArray(h)){const u={};for(const p of h){const[m,v]=Object.entries(p)[0];u[m]=v}h=u}}catch{console.warn("Match rules malformed",h)}for(const[u,p]of Object.entries(h)){const m=i[u];if(!m){d=!1;break}if(u==="gtfsRouteType"){if(Array.isArray(p)){if(!p.includes(m)){d=!1;break}}else if(m!==p){d=!1;break}}else if(!xt.isMatch(m,p)){d=!1;break}}if(d){t=c.color,!this.usedLabels.includes(c.label)&&!s&&this.usedLabels.push(c.label);break}}t=="#888"&&console.log("OHE NOES",e);const n=Array.isArray(t)?t:this.colorToRGB(t);return i.color=n,{color:n,hideThisLine:s}},colorToRGB(e){try{const t=ct(e);return t?[t.r,t.g,t.b]:[0,0,0]}catch{return[0,0,0]}},offsetLineByMeters(e,t){try{return yt(e,t,{units:"meters"})}catch{}return e},removeStopMarkers(){this.stopMarkers=[],this.stopHTML.html=""},XXtoggleTransitLine(e){e.isOpen=!e.isOpen,e.isOpen?(this.selectedTransitLine=e.id,this.selectAllRoutesInLine(e)):(this.selectedTransitLine="",this.removeStopMarkers(),this.removeSelectedRoute()),this.$forceUpdate()},selectAllRoutesInLine(e){const t=e.routes.map(s=>s.id);this.selectedRouteIds=t,this.showTransitRoutes(),this.showTransitStops()},showRouteDetails(e,t){if(t>1&&this.selectedRouteIds.length==t)this.selectedRouteIds=[e];else{const s=new Set(this.selectedRouteIds);s.has(e)?s.delete(e):s.add(e),this.selectedRouteIds=[...s]}this.showTransitRoutes(),this.showTransitStops()},showTransitStops(){const e={};this.selectedRouteIds.forEach(t=>{const s=this.routeData[t],i=s.routeProfile,n=i.length;let c;for(const[d,h]of i.entries()){const u=this._stopFacilities[h.refId],p=st([u.x,u.y]);if(d<n-1){const v=this._stopFacilities[s.routeProfile[d+1].refId],b=st([v.x,v.y]);c=St(p,b)}const m={i:d,bearing:c,xy:[u.x,u.y],name:u.name||"",id:h.refId||"",linkRefId:u.linkRefId||""};if(this.stopLevelDemand){const v=this.stopLevelDemand[h.refId];v&&(m.boardings=v.b,m.alightings=v.a)}m.id in e?(e[m.id].boardings=m.boardings,e[m.id].alightings=m.alightings):e[m.id]=m}}),this.stopMarkers=Object.values(e)},showTransitRoutes(){this.stopHTML.html="";const e=[];this.selectedRouteIds.forEach(t=>{const s=this.routeData[t];e.push(s.geojson)}),this.selectedFeatures=e},removeSelectedRoute(){this.selectedFeatures=[],this.selectedRouteIds=[]},clickedOnTransitLink(e){this.isHighlightingLink=!0,this.removeStopMarkers(),this.removeSelectedRoute();const t=this.transitLinks.features[e].properties;this.selectedLinkId=t.id;const s=this._departures[t.id].routes;let i={departures:0,pax:0,loadfac:0};const n=this.transitLinks[this.transitLinkOffset[t.id]];this.summaryStats=n?n.properties:i;const c=[],d=new Set;for(const h of s){const u=this.routeData[h];u.color=t.color,u.currentColor=t.color,c.push(u),d.add(u.lineId)}this.routesOnLink=c,this.highlightAllAttachedRoutes(),this.selectedRouteIds=this.routesOnLink.map(h=>h.id),this.highlightedTransitLineIds=d},resetLinkColors(e){if(e)for(const t of this.transitLinks.features)t.properties.currentColor=e,t.properties.sort=0;else for(const t of this.transitLinks.features)t.properties.currentColor=t.properties.color,t.properties.sort=1},highlightAllAttachedRoutes(){if(this.transitLinks){if(this.routesOnLink.length){const e=this.colorToRGB(this.isDarkMode?"#333344":"#ccccdd");this.resetLinkColors(e)}else this.resetLinkColors();for(const e of this.routesOnLink)for(const t of e.route){const s=this.transitLinkOffset[t],i=this.transitLinks.features[s];i.properties.currentColor=e.color||i.properties.color,i.properties.sort=5}if(this.selectedLinkId){const e=this.transitLinks.features[this.transitLinkOffset[this.selectedLinkId]];e.properties.currentColor=this.colorToRGB("#f4f"),e.properties.sort=5}this.transitLinks={...this.transitLinks}}},pressedEscape(){console.log("ESC"),this.removeSelectedRoute(),this.removeStopMarkers(),this.resetLinkColors(),this.routesOnLink=[]},pressedArrowKey(e){},clearData(){this._departures={},this._mapExtentXYXY=[180,90,-180,-90],this._maximum=0,this._network={nodes:{},links:{}},this.routeData={},this._stopFacilities={},this.transitLinks={type:"FeatureCollection",features:[]},this.transitLines=[],this.selectedRouteIds=[],this.cfDemand1=null,this.cfDemand2=null,this.cfDemandLink1?.dispose(),this.cfDemandLink2?.dispose(),this.cfDemandStop1?.dispose(),this.cfDemandStop2?.dispose(),this.resolvers={},this.routesOnLink=[],this.stopMarkers=[],this.searchText=""}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.debounceHandleSearchText=Ct.debounce(this.handleSearchText,350),this.clearData(),this._roadFetcher=new at,this._transitFetcher=new at,this._transitHelper=new nt,this.myState.subfolder=this.subfolder,this.myState.yamlConfig=this.yamlConfig??"",this.myState.thumbnail=this.thumbnail,await this.getVizDetails()&&(this.thumbnail||(await this.findInputFiles(),this.loadEverything()))},beforeDestroy(){this.clearData(),this.xmlWorker&&this.xmlWorker.terminate(),this._roadFetcher&&this._roadFetcher.terminate(),this._transitFetcher&&this._transitFetcher.terminate(),this._transitHelper&&this._transitHelper.terminate(),this.$store.commit("setFullScreen",!1)}});bt({colormap:"viridis",nshades:de});var fe=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("div",{staticClass:"transit-viz",class:{"hide-thumbnail":!t.thumbnail}},[t.thumbnail?t._e():s("div",{staticClass:"main-layout",on:{mousemove:t.dividerDragging,mouseup:t.dividerDragEnd}},[s("div",{staticClass:"dragger",on:{mousedown:t.dividerDragStart,mouseup:t.dividerDragEnd,mousemove:function(i){return i.stopPropagation(),t.dividerDragging.apply(null,arguments)}}}),s("div",{staticClass:"map-container",class:{"hide-thumbnail":!t.thumbnail},attrs:{oncontextmenu:"return false"}},[t.transitLinks?.features.length?s("transit-layers",{staticClass:"map-styles",attrs:{viewId:t.viewId,links:t.transitLinks,selectedFeatures:t.selectedFeatures,stopMarkers:t.stopMarkers,handleClickEvent:t.handleMapClick,pieSlider:t.pieSlider,widthSlider:t.widthSlider}}):t._e(),t.transitLines.length?s("div",{staticClass:"width-sliders flex-row",style:{backgroundColor:t.isDarkMode?"#00000099":"#ffffffaa"}},[s("img",{staticClass:"icon-blue-ramp",attrs:{src:t.icons.blueramp}}),s("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!1,size:"is-small"},model:{value:t.widthSlider,callback:function(i){t.widthSlider=i},expression:"widthSlider"}}),t.cfDemand1?s("img",{staticClass:"icon-pie-slider",attrs:{src:t.icons.piechart}}):t._e(),t.cfDemand1?s("b-slider",{staticClass:"pie-slider",attrs:{type:"is-success",tooltip:!1,size:"is-small"},model:{value:t.pieSlider,callback:function(i){t.pieSlider=i},expression:"pieSlider"}}):t._e()],1):t._e(),s("zoom-buttons"),t.loadingText?s("div",{staticClass:"status-corner"},[s("p",[t._v(t._s(t.loadingText))]),t.loadProgress>0?s("b-progress",{staticClass:"load-progress",attrs:{value:t.loadProgress,rounded:!1,type:"is-success"}}):t._e()],1):t._e()],1),s("div",{staticClass:"right-panel-holder",style:{width:`${t.legendSectionWidth}px`}},[s("div",{staticClass:"right-side-column"},[t._m(0),t.metrics.length>1?s("div",{staticClass:"panel-item"},[s("div",{staticClass:"metric-buttons"},t._l(t.metrics,function(i,n){return s("button",{key:i.field,staticClass:"button is-small metric-button",style:{color:t.activeMetric===i.field?"white":t.buttonColors[n],border:`1px solid ${t.buttonColors[n]}`,"background-color":t.activeMetric===i.field?t.buttonColors[n]:t.isDarkMode?"#333":"white"},on:{click:function(c){return t.handleClickedMetric(i)}}},[t._v(t._s(t.$i18n.locale==="de"?i.name_de:i.name_en))])}),0)]):t._e(),t.transitLines.length?s("b-input",{staticClass:"searchbox",staticStyle:{padding:"0rem 0.5rem 0.75rem 0"},attrs:{size:"is-small",placeholder:"Search line ID..."},model:{value:t.searchText,callback:function(i){t.searchText=i},expression:"searchText"}}):t._e(),s("div",{staticClass:"transit-lines flex-col flex1"},[s("lazy-list",{staticClass:"flex1",attrs:{highlightedTransitLines:t.highlightedTransitLines,listProps:t.routeListProps}})],1),s("div",{staticClass:"summary-stats flex-col"},[t._m(1),s("p",{style:{visibility:t.selectedRouteIds.length?"visible":"hidden"}},[s("b",[t._v(t._s(t.selectedRouteIds.length))]),t._v("  selected route"+t._s(t.selectedRouteIds.length!=1?"s":""))]),s("div",{staticClass:"flex-row",style:{visibility:t.selectedRouteIds.length?"visible":"hidden",gap:"0.5rem"}},[s("div",{staticClass:"aa"},[s("b",[t._v(t._s(t.summaryStats.departures))]),t._v(" Departures")]),t.cfDemand1?s("div",{staticClass:"aa"},[s("b",[t._v(t._s(t.summaryStats.pax))]),t._v(" Passengers")]):t._e()])]),t.thumbnail?t._e():s("legend-box",{staticClass:"legend",attrs:{rows:t.legendRows},on:{click:t.clickedLegend}})],1)])])])},pe=[function(){var e=this,t=e._self._c;return e._self._setupProxy,t("p",{staticStyle:{"margin-top":"0.25rem"}},[t("b",[e._v("TRANSIT INSPECTOR")])])},function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"sum-stat-title"},[t("b",[e._v("SUMMARY STATISTICS")])])}],me=Y(ue,fe,pe,!1,null,"2aa25a52");const Ke=me.exports;export{Ke as default};
