import{r as A,g as v,R as O,j as h,M as Q,d as tt,C as X,n as et}from"./index-DXwMd8J6.js";import{d as st}from"./index-1GW52lzC.js";import{r as it}from"./index-BRmf_z99.js";import{Y as nt}from"./index-6F3aLhar.js";import{n as C,H as ot}from"./HTTPFileSystem-mhJZeBxO.js";import{c as rt}from"./index-BaMiGLGj.js";import{P as at,C as lt}from"./LegendColors-0mK6uY0f.js";import{Z as ct}from"./ZoomButtons-DjT_93U7.js";import{a as ht,p as pt,f as dt,g as ut}from"./util-DDCxpZ5I.js";import{W as mt}from"./RoadNetworkLoader.worker-Dk5IXYzf.js";import{D as gt,S as ft}from"./set-rtl-text-plugin-Cr2Q1psc.js";import{P as vt}from"./PathOffsetLayer-BBMNA7jZ.js";import{P as bt}from"./path-layer-CD8MEmh-.js";import{A as V}from"./arc-layer-C4UL1X_E.js";import{T as Y,S as G}from"./text-layer-BIdA0DCN.js";import"./layer-extension-DxsIWJLz.js";import"./fxp-4YEvQr-_.js";import"./extends-CCbyfPlC.js";import"./cut-by-mercator-bounds-4NGqEMJI.js";const L={pickup:[0,150,255],delivery:[240,0,60],service:[255,64,255]};function yt(s){const[t,e]=A.useState(v.state.viewState),[i,n]=A.useState({}),[r,p]=A.useState({type:"activity",pickups:[],deliveries:[]}),{dark:b,activeTab:l,numSelectedTours:c,shipments:g,depots:d,legs:k,settings:T,stopActivities:_,center:F,onClick:D,projection:P}=s,{simplifyTours:H,scaleFactor:S,shipmentDotsOnTourMap:B}=T;let I=S==0?1e-6:1/Math.pow(2,(100-S)/5-6);const y=[];O[s.viewId]=()=>{e(v.state.viewState)},A.useEffect(()=>{const o={},a={};g.forEach(u=>{let m=`${u.fromX}-${u.fromY}`;o[m]||(o[m]={type:"pickup",shipmentIds:[],coord:[u.fromX,u.fromY]}),o[m].shipmentIds.push(u.$id),m=`${u.toX}-${u.toY}`,a[m]||(a[m]={type:"delivery",shipmentIds:[],coord:[u.toX,u.toY]}),a[m].shipmentIds.push(u.$id)}),p({type:"activity",pickups:Object.values(o),deliveries:Object.values(a)})},[g]);function z(o){o.object?D(o.object):D(null)}function x(o){e(o),o.center=[o.longitude,o.latitude],v.commit("setMapCamera",o)}function $(o){const{object:a}=o;return a?a?.type=="pickup"?R(o,"pickup"):a?.type=="delivery"?R(o,"delivery"):a?.color?Z(o):a?.type=="depot"?null:q(o):null}function R(o,a){const{object:u,x:m,y:w}=o;return h.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:m+20,top:w+20}},h.createElement("table",{style:{maxWidth:"30rem",fontSize:"0.8rem"}},h.createElement("tbody",null,h.createElement("tr",null,h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},a,":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},u.shipmentIds.join(", "))))))}function Z(o){const{object:a,x:u,y:m}=o;return h.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:u+20,top:m-30}},h.createElement("b",null,a?.tour?.vehicleId),h.createElement("br",null),"Leg # ",1+a?.count," ",h.createElement("br",null),"Shipments on board: ",a?.shipmentsOnBoard?.length," ",h.createElement("br",null),"Total size: ",a?.totalSize)}function q(o){const{object:a,x:u,y:m}=o,w=a.visits.length,j=a.visits.reduce((f,M)=>f+M.pickup.length,0),N=a.visits.reduce((f,M)=>f+M.delivery.length,0),K=j+N,W={visits:w,pickups:j,deliveries:N},U=Object.keys(a).length*20+32;let E=m-30;return E+U>window.innerHeight&&(E=m-U),h.createElement("div",{className:"tooltip",style:{fontSize:"0.7rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:u+20,top:E}},h.createElement("table",{style:{fontSize:"0.8rem"}},h.createElement("tbody",null,Object.keys(W).map(f=>h.createElement("tr",{key:f},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem"}},f,":"),h.createElement("td",{style:{fontWeight:"bold"}}," ",W[f]))),K==1&&Object.keys(a.details).map(f=>h.createElement("tr",{key:f},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},f.slice(1),":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},a.details[f]))))))}if(l=="tours"&&(y.push(new bt({id:"shipmentLocationDashedLine",data:_,getPath:o=>[o.ptFrom,o.ptTo],getColor:[128,128,128],getOffset:2,opacity:1,widthMinPixels:3,rounded:!0,shadowEnabled:!1,pickable:!1,autoHighlight:!1,highlightColor:[255,255,255],parameters:{depthTest:!1},getDashArray:[3,2],dashJustified:!0,extensions:[new at({dash:!0})]})),H?y.push(new V({id:"leg-arcs",data:k,getSourcePosition:o=>o.points[0],getTargetPosition:o=>o.points[o.points.length-1],getSourceColor:o=>o.color,getTargetColor:o=>o.color,getWidth:S?o=>o.totalSize/2:3,getHeight:.5,widthMinPixels:2,widthMaxPixels:200,widthUnits:"pixels",widthScale:I,opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[S]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n})):y.push(new vt({id:"deliveryroutes",data:k,getPath:o=>o.points,getColor:o=>o.color,getWidth:S?o=>o.totalSize:3,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:200,widthUnits:"pixels",widthScale:I,rounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,parameters:{depthTest:!1},updateTriggers:{getWidth:[S]},transitions:{getWidth:150}})),y.push(new Y({id:"dest-labels",data:_,background:!0,backgroundPadding:c!==1?[2,1,2,1]:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:o=>{const a=o.visits.reduce((m,w)=>m+w.pickup.length,0),u=o.visits.reduce((m,w)=>m+w.delivery.length,0);return a&&u?[0,0,255]:a?L.pickup:u?L.delivery:[240,130,0]},getPosition:o=>o.midpoint,getText:o=>o.label=="Depot"?o.label:c!==1?" ":`${o.label}`,getSize:o=>o.label=="Depot"?11:c!==1?4:11,getTextAnchor:"middle",getAlignmentBaseline:"center",opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,visible:B}))),l=="shipments"){y.push(new G({id:"deliveries",data:r.deliveries,getPosition:a=>a.coord,getColor:L.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n})),y.push(new G({id:"pickups",data:r.pickups,getPosition:a=>a.coord,getColor:L.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n}));const o=g.length>1?32:255;y.push(new V({id:"shipments",data:g,getSourcePosition:a=>[a.fromX,a.fromY],getTargetPosition:a=>[a.toX,a.toY],getSourceColor:[0,228,255,o],getTargetColor:[240,0,60,224],getWidth:S?a=>parseInt(a.$size)||1:1,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthScale:I,widthMinPixels:1,widthMaxPixels:100,updateTriggers:{getWidth:[S]},transitions:{getWidth:200}}))}y.push(new Y({id:"depots",data:d,background:!0,backgroundPadding:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:[0,150,240],getPosition:o=>o.midpoint,getText:o=>"Depot",getTextAnchor:"middle",getAlignmentBaseline:"center",getSize:11,opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n}));const J=P&&P!=="Atlantis";return h.createElement(gt,{layers:y,pickingRadius:3,controller:!0,getCursor:()=>"pointer",onClick:z,viewState:t,onViewStateChange:o=>x(o.viewState)},J&&h.createElement(ft,{mapboxApiAccessToken:Q,mapStyle:v.getters.mapStyle}),$(i))}const kt={messages:{en:{carriers:"Carriers",vehicles:"VEHICLES",services:"SERVICES",shipments:"SHIPMENTS",tours:"TOURS",pickup:"Pickup",delivery:"Delivery",flatten:"Simple&nbsp;tours",shipmentDots:"Show shipments",scaleSize:"Widths",scaleFactor:"Width"},de:{carriers:"Unternehmen",vehicles:"FAHRZEUGE",services:"BETRIEBE",shipments:"LIEFERUNGEN",tours:"TOUREN",pickup:"Abholung",delivery:"Lieferung"}}};C.insensitive=!0;const St=tt({name:"CarrierPlugin",i18n:kt,components:{LegendColors:lt,ToggleButton:st.ToggleButton,TourViz:yt,ZoomButtons:ct},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>({linkLayerId:Math.floor(1e12*Math.random()),vizSettings:{simplifyTours:!1,scaleShipmentSizes:!0,shipmentDotsOnTourMap:!0,scaleFactor:0},vizDetails:{network:"",carriers:"",projection:"",title:"",description:"",thumbnail:"",center:null},myState:{statusMessage:"",isRunning:!1,subfolder:"",yamlConfig:"",thumbnail:!0,data:[]},searchTerm:"",searchEnabled:!1,globalState:v.state,isLoaded:!0,showHelp:!1,activeTab:"shipments",speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],links:null,toggleTours:!0,toggleVehicles:!0,toggleShipments:!0,toggleServices:!0,detailContent:"",data:null,carriers:[],vehicles:[],shipments:[],shipmentLookup:{},services:[],stopActivities:[],tours:[],plans:[],shownShipments:[],shipmentIdsInTour:[],depots:[],shownDepots:[],shownLegs:[],selectedCarrier:"",selectedTours:[],selectedPlan:null,selectedPlanIndex:null,selectedShipment:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},rgb:rt({colormap:"phase",nshades:9,format:"rba"}).map(s=>s.slice(0,3)).reverse(),dropdownIsActive:!1}),computed:{fileApi(){return new ot(this.fileSystem,v)},fileSystem(){const s=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(s.length===0)throw console.log("no such project"),Error;return s[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const s={text:"#3498db",bg:"#eeeef480"},t={text:"white",bg:"#181518aa"};return this.globalState.isDarkMode?t:s}},watch:{"$store.state.viewState"(){O[this.linkLayerId]&&O[this.linkLayerId]()},"globalState.isDarkMode"(){this.updateLegendColors()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()}},methods:{handleSelectShipment(s){if(this.selectedShipment===s){if(this.selectedShipment=null,this.shownShipments=[],!this.selectedTours.length){const t=this.carriers.filter(e=>e.$id==this.selectedCarrier);this.selectedCarrier="",this.handleSelectCarrier(t[0])}return}this.shownShipments=this.shipments.filter(t=>t.$id===s.$id),this.selectedShipment=s},processActivitiesInTour(s){const t=[];let e=0;const i={};let n=this.vehicles.filter(c=>c.$id===s.vehicleId)[0];const r=this.links[n.$depotLinkId];let p=[.5*(r[0]+r[2]),.5*(r[1]+r[3])],b=n.$depotLinkId;i[`L${n.$depotLinkId}`]={link:n.$depotLinkId,midpoint:p,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:s,details:{},ptFrom:[r[0],r[1]],ptTo:[r[2],r[3]]};for(const c of s.plan){if(!c.$shipmentId)continue;t.push(c.$shipmentId);const g=this.shipmentLookup[c.$shipmentId];if(!g)continue;const d=c.$type==="pickup"?g.$from:g.$to,k=[this.links[d][0],this.links[d][1]],T=[this.links[d][2],this.links[d][3]],_=[.5*(k[0]+T[0]),.5*(k[1]+T[1])],F=this.$t(c.$type),{from:D,fromX:P,fromY:H,to:S,toX:B,toY:I,id:y,...z}=g,x={id:g.$id,type:F,count:e++,link:d,midpoint:_,label:"",tour:s,details:z,ptFrom:k,ptTo:T};if(d==b)i[`L${d}`].visits[i[`L${d}`].visits.length-1][c.$type].push(x);else if(`L${d}`in i){const $={pickup:[],delivery:[],service:[]};$[c.$type].push(x),i[`L${d}`].visits.push($)}else{const $={pickup:[],delivery:[],service:[]};$[c.$type].push(x),i[`L${d}`]={link:d,midpoint:_,label:"",tour:s,details:z,ptFrom:k,ptTo:T,visits:[$]}}b=d}const l=Object.values(i);for(let c=0;c<l.length;c++)l[c].label=`${c}`;return l[0].label="Depot",{shipmentIdsInTour:t,stopActivities:l}},setupDepots(){const s={};this.vehicles.forEach(t=>{const e=t.$depotLinkId;let i=this.links[e];i&&(s[e]||(s[e]={type:"depot",link:t.$depotLinkId,midpoint:[.5*(i[0]+i[2]),.5*(i[1]+i[3])],coords:this.links[t.$depotLinkId],vehicles:{}}),s[e].vehicles[t.$id]=t)}),this.depots=Object.values(s),this.shownDepots=this.depots.slice(0)},selectAllTours(){this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0);for(const s of this.tours){s.legs.forEach((e,i)=>this.addRouteToMap(s,e,i++));const t=this.processActivitiesInTour(s);this.stopActivities=this.stopActivities.concat(t.stopActivities),this.setupDepots()}},async handleSelectTour(s){if(!s.legs.length){console.log("No Route.");for(let n=0;n<s.plan.length;n++)if(s.plan[n].$shipmentId){const r=s.plan[n].$shipmentId,p=[this.shipmentLookup[r].$from,this.shipmentLookup[r].$to];s.legs.push({links:p})}this.vizSettings.simplifyTours=!0}if(this.selectedTours.includes(s)){this.selectedTours=this.selectedTours.filter(n=>n!==s),this.shownLegs=this.shownLegs.filter(n=>n.tour!==s),this.stopActivities=this.stopActivities.filter(n=>n.tour!==s),this.selectedTours.length||this.selectAllTours();return}this.selectedTours.length||(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[]),this.selectedTours.push(s);const{shipmentIdsInTour:t,stopActivities:e}=this.processActivitiesInTour(s);this.shipmentIdsInTour=t;let i=0;for(const n of s.legs)this.addRouteToMap(s,n,i++);this.stopActivities=this.stopActivities.concat(e)},addRouteToMap(s,t,e){const i=[[this.links[t.links[0]][0],this.links[t.links[0]][1]]];for(const n of t.links){const r=i[i.length-1],p=[this.links[n][0],this.links[n][1]];(p[0]!==r[0]||p[1]!==r[1])&&i.push(p),i.push([this.links[n][2],this.links[n][3]])}this.shownLegs=this.shownLegs.concat([{tour:s,shipmentsOnBoard:t.shipmentsOnBoard,totalSize:t.totalSize,count:e,points:i,color:this.rgb[(3+s.tourNumber)%this.rgb.length],type:"leg"}])},handleSelectCarrier(s){if(this.dropdownIsActive=!1,!this.links)return;const t=s.$id;if(this.vehicles=[],this.shipments=[],this.services=[],this.tours=[],this.plans=[],this.shownShipments=[],this.shownDepots=[],this.selectedShipment=null,this.shipmentIdsInTour=[],this.stopActivities=[],this.shownLegs=[],this.selectedCarrier===t){this.selectedCarrier="";return}this.selectedCarrier=t;let e=s.capabilities.vehicles.vehicle||[];this.vehicles=e.sort((i,n)=>C(i,n)),this.setupDepots(),this.shipments=this.processShipments(s),s.services?.service?.length&&(this.services=s.services.service.map(i=>i.$).sort((i,n)=>C(i.$id,n.$id))),this.tours=this.processTours(s),this.shownShipments=this.shipments,this.selectAllTours()},getAllPlans(s){if(s.plan!=null){this.plans.push(s.plan),this.selectedPlan=s.plan;return}if(s.plans!=null){if(s.plans.plan.length==null){this.plans.push(s.plans.plan),this.selectedPlan=s.plans.plan;return}this.plans=s.plans.plan;for(let t=0;t<s.plans.plan.length;t++){if(s.plans.plan[t].selected=="true"){this.selectedPlan=s.plans.plan[t];break}this.selectedPlan=s.plans.plan[t]}}},processTours(s){if(this.getAllPlans(s),!this.selectPlan||!this.plans.length)return[];Array.isArray(this.selectedPlan.tour)||(this.selectedPlan.tour=[this.selectedPlan.tour]);const t=this.selectedPlan.tour.map((e,i)=>{const n=[e.act[0]],r=new Set;for(let l=1;l<e.act.length;l++)e.leg[l-1].shipmentsOnBoard=[...r],n.push(e.leg[l-1]),n.push(e.act[l]),e.act[l].$type=="pickup"&&e.act[l].$shipmentId&&r.add(e.act[l].$shipmentId),e.act[l].$type=="delivery"&&e.act[l].$shipmentId&&r.delete(e.act[l].$shipmentId);const p=e.leg.filter(l=>l.route&&l.route.length).map(l=>{const c=l.shipmentsOnBoard.map(d=>this.shipmentLookup[d]),g=c.reduce((d,k)=>d+parseFloat(k?.$size||0),0);return{shipmentsOnBoard:c,totalSize:g,links:l.route?l.route.split(" "):[]}});return{vehicleId:e.$vehicleId,tourId:e.$tourId,plan:n,legs:p,tourNumber:0}});return t.sort((e,i)=>C(e.vehicleId,i.vehicleId)),t.forEach((e,i)=>e.tourNumber=i),t},processShipments(s){if(this.shipmentLookup={},!s.shipments?.shipment?.length)return[];const t=s.shipments.shipment.sort((e,i)=>C(e.$id,i.$id));try{for(const e of t)e.fromX=.5*(this.links[e.$from][0]+this.links[e.$from][2]),e.fromY=.5*(this.links[e.$from][1]+this.links[e.$from][3]),e.toX=.5*(this.links[e.$to][0]+this.links[e.$to][2]),e.toY=.5*(this.links[e.$to][1]+this.links[e.$to][3]),this.shipmentLookup[e.$id]=e}catch{}return t},buildRouteFromUrl(){const s=this.$route.params;if(!s.project||!s.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const t=1+s.pathMatch.lastIndexOf("/"),e=s.pathMatch.substring(0,t),i=s.pathMatch.substring(t);this.myState.subfolder=e,this.myState.yamlConfig=i},async getVizDetails(){if(this.config){this.vizDetails=Object.assign({},this.config);return}if(this.yamlConfig?.endsWith("yaml")||this.yamlConfig?.endsWith("yml"))try{const n=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig,r=await this.fileApi.getFileText(n);this.vizDetails=nt.parse(r),this.vizDetails.title&&this.$emit("title",this.vizDetails.title);return}catch(n){console.log("failed"+n);const r=n;this.fileSystem.needPassword&&r.status===401?v.commit("requestLogin",this.fileSystem.slug):this.$emit("error",""+n);return}const s=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("carriers")),{files:t}=await this.fileApi.getDirectory(this.myState.subfolder);let e=this.myState.yamlConfig.replaceAll("carriers","network");if(t.indexOf(e)==-1){const n=t.filter(r=>r.indexOf("network")>-1);n.length?e=n[0]:(this.myState.statusMessage="No road network found.",e="")}this.vizDetails={network:e,carriers:this.yamlConfig,title:s,description:"",center:this.vizDetails.center,projection:"",thumbnail:""},this.$emit("title","Carrier Explorer"),this.buildThumbnail()},async setMapCenter(){let s=0,t=0,e=0;if(this.vizDetails.center)typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),t=this.vizDetails.center[0],e=this.vizDetails.center[1];else if(!this.vizDetails.center){if(this.data=Object.entries(this.links),!this.data.length)return;const i=this.data.length/2,n=4096;for(let r=0;r<i;r+=n)t+=this.data[r*2][1][0],e+=this.data[r*2+1][1][1],s++;t=t/s,e=e/s}t&&e&&this.$store.commit("setMapCamera",{longitude:t,latitude:e,zoom:9,bearing:0,pitch:0,jump:!1})},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const s=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),t=await it.arraybuffer(s),e=ht(t);e&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${e})`)}catch(s){console.error(s)}},handleClick(s){console.log("CLICK!",s),s||this.clickedEmptyMap(),s?.type=="depot"&&this.clickedDepot(s),s?.type=="leg"&&this.clickedLeg(s)},clickedDepot(s){const t=Object.values(s.vehicles).map(e=>e.$id);this.selectedTours=[],this.shownShipments=[];for(const e of this.tours)t.includes(e.vehicleId)&&(this.handleSelectTour(e),this.shipmentIdsInTour.forEach(i=>{this.shownShipments.push(this.shipmentLookup[i])}))},clickedLeg(s){s?.tour&&this.handleSelectTour(s?.tour)},clickedEmptyMap(){this.selectAllTours()},updateLegendColors(){},async loadCarriers(){const s=await this.loadFileOrGzippedFile(this.vizDetails.carriers);return s?(await pt(s,{alwaysArray:["carriers.carrier","carriers.carrier.capabilities.vehicles.vehicle","carriers.carrier.plan.tour","carriers.carrier.shipments.shipment","carriers.carrier.services.service"]})).carriers.carrier.sort((i,n)=>C(i.$id,n.$id)):[]},async loadNetwork(){if(this.myState.statusMessage="Loading network...",this.vizDetails.network.indexOf(".xml.")>-1){const s=`${this.myState.subfolder}/${this.vizDetails.network}`,t=await this.fetchNetwork(s,{});this.vizDetails.projection=""+t.projection,this.myState.statusMessage="Building network link table";const e={};return t.linkIds.forEach((i,n)=>{e[i]=[t.source[n*2],t.source[n*2+1],t.dest[n*2],t.dest[n*2+1]]}),e}else{const s=await this.fileApi.getFileJson(this.myState.subfolder+"/"+this.vizDetails.network);return this.vizDetails.projection="EPSG:4326",s}},async fetchNetwork(s,t){return new Promise((e,i)=>{const n=new mt;try{n.postMessage({filePath:s,fileSystem:this.fileSystem,vizDetails:t}),n.onmessage=r=>{if(r.data.promptUserForCRS){let p=prompt("Enter the coordinate reference system, e.g. EPSG:25832")||"EPSG:31468";Number.isFinite(parseInt(p))&&(p=`EPSG:${p}`),n.postMessage({crs:p});return}if(r.data.status){this.myState.statusMessage=""+r.data.status;return}n.terminate(),r.data.error&&(console.error(r.data.error),v.commit("error",r.data.error),this.myState.statusMessage=r.data.error,i(r.data.error)),e(r.data.links)}}catch(r){n.terminate(),console.error(r),i(r)}})},toggleLoaded(s){this.isLoaded=s},rotateColors(){localStorage.setItem("plugin/agent-animation/colorscheme",this.globalState.isDarkMode?X.DarkMode:X.LightMode)},async loadFileOrGzippedFile(s){let t=`${this.subfolder}/${s}`;try{if(t.indexOf("*")>-1||t.indexOf("?")>-1){const n=t.substring(1+t.lastIndexOf("/")),r=t.substring(0,t.lastIndexOf("/")),{files:p}=await this.fileApi.getDirectory(r),b=dt(p,n);if(b.length==0)throw Error(`No files matched "${n}"`);if(b.length>1)throw Error(`More than one file matched "${n}": ${b}`);t=`${r}/${b[0]}`}let i="";if(t.endsWith("xml")||t.endsWith("gz")){const r=await(await this.fileApi.getFileBlob(t)).arrayBuffer(),p=ut(r);return new TextDecoder("utf-8").decode(p)}}catch{}const e=`Error loading ${t}`;return v.commit("error",e),this.myState.statusMessage=e,""},selectDropdown(){this.dropdownIsActive=!this.dropdownIsActive},selectPlan(s){for(let t=0;t<this.plans.length;t++)this.plans[t].$selected="false";s.$selected="true",this.selectedPlanIndex=this.plans.indexOf(s),this.selectedTours=[],this.selectDropdown(),this.selectedPlan=s}},async mounted(){v.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails(),!this.thumbnail&&(this.showHelp=!1,this.updateLegendColors(),this.myState.statusMessage="Loading carriers...",this.carriers=await this.loadCarriers(),await this.$nextTick(),this.links=await this.loadNetwork(),this.setMapCenter(),this.myState.statusMessage="",this.carriers.length&&this.handleSelectCarrier(this.carriers[0]),this.tours.length&&this.handleSelectTour(this.tours[0]))},beforeDestroy(){this.myState.isRunning=!1,v.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1)}});var $t=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"carrier-viewer",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[e("div",{staticClass:"container-1"},[e("div",{staticClass:"main-panel"},[t.thumbnail?t._e():e("tour-viz",{staticClass:"anim",attrs:{activeTab:t.activeTab,shipments:t.shownShipments,depots:t.shownDepots,legs:t.shownLegs,stopActivities:t.stopActivities,dark:t.globalState.isDarkMode,center:t.vizDetails.center,viewId:t.linkLayerId,settings:t.vizSettings,numSelectedTours:t.selectedTours.length,onClick:t.handleClick,projection:t.vizDetails.projection}}),t.thumbnail?t._e():e("ZoomButtons"),t.myState.statusMessage?e("div",{staticClass:"xmessage"},[t._v(t._s(t.myState.statusMessage))]):t._e()],1),t.thumbnail?t._e():e("div",{staticClass:"right-panel",attrs:{darkMode:!0}},[t.carriers.length?e("h3",{staticStyle:{"margin-left":"0.25rem"}},[t._v(t._s(t.$t("carriers")))]):t._e(),e("div",{staticClass:"carrier-list"},t._l(t.carriers,function(i){return e("div",{key:i.$id,staticClass:"carrier",class:{selected:i.$id===t.selectedCarrier},on:{click:function(n){return t.handleSelectCarrier(i)}}},[e("div",{staticClass:"carrier-title"},[t._v(t._s(i.$id))])])}),0),e("h4",[t._v(t._s(t.selectedCarrier||"Details"))]),t.selectedCarrier?e("b-field",{staticClass:"detail-buttons",attrs:{size:"is-small"}},[e("b-radio-button",{attrs:{"native-value":"shipments",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("shipments")))])]),e("b-radio-button",{attrs:{"native-value":"tours",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("tours")))])]),e("b-radio-button",{attrs:{"native-value":"vehicles",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("vehicles")))])]),t.services.length?e("b-radio-button",{attrs:{"native-value":"services",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(i){t.activeTab=i},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("services")))])]):t._e()],1):t._e(),e("div",{staticClass:"detail-area"},[t.activeTab=="shipments"?e("div",{staticClass:"shipments"},[e("span",[t._v(t._s(t.$t("shipments"))+": "+t._s(t.shipments.length))]),t._l(t.shipments,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour",class:{selected:i==t.selectedShipment,"shipment-in-tour":t.shipmentIdsInTour.includes(i.$id)},on:{click:function(r){return t.handleSelectShipment(i)}}},[t._v(t._s(`${i.$id}: ${i.$from}-${i.$to}`))])})],2):t._e(),t.activeTab=="tours"?e("div",{staticClass:"tours"},[this.plans.length>1?e("div",{staticClass:"dropdown",class:{"is-active":t.dropdownIsActive},staticStyle:{width:"100%"}},[e("div",{staticClass:"dropdown-trigger",on:{click:function(i){return t.selectDropdown()}}},[e("button",[e("span",[t._v("Plan "+t._s(t.selectedPlanIndex+1))]),t._m(0)])]),e("div",{staticClass:"dropdown-menu"},[e("div",{staticClass:"dropdown-content"},t._l(this.plans,function(i,n){return e("a",{staticClass:"dropdown-item",class:{"is-active":i.$selected=="true"},on:{click:function(r){return t.selectPlan(i)}}},[t._v("Plan "+t._s(n+1))])}),0)])]):t._e(),e("span",[t._v(t._s(t.$t("tours"))+": "+t._s(t.tours.length))]),t._l(t.tours,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour",class:{selected:t.selectedTours.includes(i)},on:{click:function(r){return t.handleSelectTour(i)}}},[i.tourId?e("div",[t._v(t._s(i.tourId)+": "+t._s(`${i.vehicleId}`))]):e("div",[t._v(t._s(`${i.vehicleId}`))])])})],2):t._e(),t.activeTab=="vehicles"?e("div",{staticClass:"vehicles"},[e("span",[t._v(t._s(t.$t("vehicles"))+": "+t._s(t.vehicles.length))]),t._l(t.vehicles,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour"},[t._v(t._s(i.$id))])})],2):t._e(),t.activeTab=="services"?e("div",{staticClass:"services"},[e("span",[t._v(t._s(t.$t("services"))+": "+t._s(t.services.length))]),t._l(t.services,function(i,n){return e("div",{key:`${n}-${i.$id}`,staticClass:"leaf tour"},[t._v(t._s(`${i.$id}`))])})],2):t._e()]),e("div",{staticClass:"switchbox"},[e("div",{staticClass:"switches"},[e("p",[t._v(t._s(t.$t("scaleSize")))]),e("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:t.vizSettings.scaleFactor,callback:function(i){t.$set(t.vizSettings,"scaleFactor",i)},expression:"vizSettings.scaleFactor"}})],1),e("div",{staticClass:"switches"},[e("b-switch",{model:{value:t.vizSettings.shipmentDotsOnTourMap,callback:function(i){t.$set(t.vizSettings,"shipmentDotsOnTourMap",i)},expression:"vizSettings.shipmentDotsOnTourMap"}},[e("span",{domProps:{innerHTML:t._s(t.$t("shipmentDots"))}})]),e("b-switch",{model:{value:t.vizSettings.simplifyTours,callback:function(i){t.$set(t.vizSettings,"simplifyTours",i)},expression:"vizSettings.simplifyTours"}},[e("span",{domProps:{innerHTML:t._s(t.$t("flatten"))}})])],1)])],1)])])},wt=[function(){var s=this,t=s._self._c;return s._self._setupProxy,t("span",{staticClass:"icon is-small"},[t("i",{staticClass:"fas fa-angle-down"})])}],Tt=et(St,$t,wt,!1,null,"750f72cb");const Ut=Tt.exports;export{Ut as default};
