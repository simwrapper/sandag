import{r as z,g as o,R as l,j as y,M as E,d as A,h,n as M}from"./index-DXwMd8J6.js";import{G as L}from"./lil-gui.esm-D2cLj-mk.js";import{Y as v}from"./index-6F3aLhar.js";import{w as I,p as R}from"./comlink-DESosX-g.js";import{u as F}from"./util-DDCxpZ5I.js";import{C as $}from"./CollapsiblePanel-Xr3kzqwk.js";import{D as x}from"./DrawingTool-ryYUP9o2.js";import{H as j}from"./HTTPFileSystem-mhJZeBxO.js";import{L as _}from"./LegendBox-DtHkMABV.js";import{L as O}from"./LegendStore-CGgeb9zL.js";import{T as Y}from"./TimeSlider-OYUHpxMD.js";import{D as N,S as W}from"./set-rtl-text-plugin-Cr2Q1psc.js";import{I as P}from"./moving-icons-vehicles-layer-Cx5pZNO6.js";import{D as V}from"./data-filter-B-yN-K81.js";import{Z as B}from"./ZoomButtons-DjT_93U7.js";import{D as G}from"./DashboardDataManager-BPyHyjlN.js";import"./fxp-4YEvQr-_.js";import"./extends-CCbyfPlC.js";import"./geojson-layer-BIUM1AhK.js";import"./text-layer-BIdA0DCN.js";import"./path-layer-CD8MEmh-.js";import"./cut-by-mercator-bounds-4NGqEMJI.js";import"./solid-polygon-layer-GmKLAUU6.js";import"./index-DgdUD6UN.js";import"./icon-manager-D8vYbXtY.js";import"./layer-extension-DxsIWJLz.js";import"./avro-Dd9UqmeZ.js";import"./RoadNetworkLoader.worker-Dk5IXYzf.js";import"./Coords-D-UV8-Xi.js";import"./group-DobYzF2-.js";import"./index-_doEQLKC.js";const H="/",q={vehicle:{x:0,y:0,width:256,height:256,mask:!1}};new V({filterSize:1});function U({viewId:e=0,eventLayers:t=[],eventData:i=[],network:a={},dark:r=!1,colors:n=[[1,0,0],[.25,.25,1]],breakpoints:et=[0],mapIsIndependent:S=!1,simulationTime:m=18e3,projection:c="",dotsize:b=22,tick:w=0}){const[C,g]=z.useState(o.state.viewState);l[e]=()=>{g(o.state.viewState)};function k(s){s.latitude&&(s.center||(s.center=[0,0]),s.center[0]=s.longitude,s.center[1]=s.latitude,g(s),S||o.commit("setMapCamera",s))}function d(s){return s.index<0,null}const u=[];let f=0;i.forEach((s,T)=>{const p=m<s.timeRange[0]-5||m>s.timeRange[1]+5;p||f++,u.push(new P({data:{length:s.data.t0.length,attributes:{getTimeStart:s.data.t0,getTimeEnd:s.data.t1,getPathStart:s.data.p0,getPathEnd:s.data.p1,getColorCode:s.data.colors}},id:"vehicles"+T,iconMoving:"vehicle",iconStill:"vehicle",colorMap:[30,208,170,40,255,40,240,240,64,240,0,0],getSize:b,opacity:1,currentTime:m,shadowEnabled:!1,iconAtlas:`${H}veh-curvy5.png`,iconMapping:q,sizeScale:1,billboard:!1,positionFormat:"XY",pickable:!1,depthTest:!0,autoHighlight:!1,highlightColor:[255,255,255,140],parameters:{depthTest:!1},visible:!p}))});const D=c&&c!=="Atlantis";return w==1&&console.log(m,f,i.length),y.createElement(N,{layers:u,controller:!0,useDevicePixels:!0,viewState:C,onViewStateChange:s=>k(s.viewState),pickingRadius:4,onClick:d,getTooltip:d},D&&y.createElement(W,{mapStyle:o.getters.mapStyle,preventStyleDiffing:!0,mapboxApiAccessToken:E}))}function X(e){return new Worker("/assets/WASMEventStreamer.worker-Cg6t3E3k.js",{name:e?.name})}const Z={messages:{en:{loading:"Loading data...",sorting:"Sorting into bins...",aggregate:"Summary",maxHeight:"3D Height",showDetails:"Show Details",selection:"Selection",areas:"Areas",count:"Count",promptCRS:`Enter the coordinate reference system, e.g. EPSG:25832

These coordinates are not in long/lat format. To fix this permanently, convert them to long/lat or add "# EPSG:xxxx" to your CSV header`},de:{loading:"Dateien laden...",sorting:"Sortieren...",aggregate:"Daten",maxHeight:"3-D Höhe",showDetails:"Details anzeigen",selection:"Ausgewählt",areas:"Orte",count:"Anzahl"}}},J=A({name:"EventViewerPlugin",i18n:Z,components:{CollapsiblePanel:$,DrawingTool:x,EventMap:U,LegendBox:_,TimeSlider:Y,ZoomButtons:B},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean,datamanager:{type:Object}},data:()=>({tick:0,myDataManager:null,network:{source:new Float32Array,dest:new Float32Array,linkIds:[],projection:""},linkIdLookup:{},guiConfig:{speed:.1,size:16},viewId:"xyt-id-"+Math.floor(1e12*Math.random()),configId:"gui-config-"+Math.floor(1e12*Math.random()),timeLabels:[0,1],startTime:0,isAnimating:!1,simTime:0,timeFilter:[0,3600],colors:[[128,128,128],[128,128,128]],breakpoints:[0],range:[1/0,-1/0],timeRange:[1/0,-1/0],legendStore:null,standaloneYAMLconfig:{title:"",description:"",file:"",projection:"",thumbnail:"",radius:250,maxHeight:0,center:null,zoom:9},YAMLrequirementsXY:{file:""},columnLookup:[],gzipWorker:null,vizDetails:{title:"",description:"",file:"",projection:"",thumbnail:"",center:null,zoom:9},myState:{statusMessage:"",subfolder:"",yamlConfig:"",thumbnail:!1},eventLayers:[],eventData:[],isLoaded:!1,animator:null,guiController:null,resizer:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",ANIMATE_SPEED:.25,animationElapsedTime:0,animationClockTime:0}),computed:{fileApi(){return new j(this.fileSystem,o)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl}},watch:{"$store.state.viewState"(){l[this.viewId]&&l[this.viewId]()}},methods:{setupLogoMover(){this.resizer=new ResizeObserver(this.moveLogo);const e=document.getElementById(`id-${this.viewId}`);this.resizer.observe(e)},moveLogo(){const e=document.getElementById(`${this.viewId}`),t=e?.querySelector(".mapboxgl-ctrl-bottom-left");if(t){const i=e.clientWidth>640?"280px":"36px";t.style.right=i}},setupGui(){this.guiController=new L({title:"VIEW SETTINGS",injectStyles:!0,width:200,container:document.getElementById(this.configId)||void 0});const e=this.guiController;e.add(this.guiConfig,"size",4,40,1).onChange(this.setConfig),e.add(this.guiConfig,"speed",[-2,-1,-.5,-.25,-.1,0,.1,.25,.5,1,2],1).onChange(this.setConfig)},async solveProjection(){if(!this.thumbnail){console.log("WHAT PROJECTION:");try{const e=await this.fileApi.getFileText(this.myState.subfolder+"/"+this.myState.yamlConfig);this.vizDetails=v.parse(e)}catch(e){console.error(e),this.$emit("error",""+e)}}},async getVizDetails(){if(this.config){this.validateYAML(),this.vizDetails=Object.assign({},this.config);return}new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig)?await this.loadStandaloneYAMLConfig():(console.log("NO YAML WTF"),this.setConfigForRawCSV())},setConfigForRawCSV(){let e="";this.vizDetails={title:"EVENTS: "+this.myState.yamlConfig,description:this.myState.yamlConfig,file:this.myState.yamlConfig,projection:e,center:this.vizDetails.center,zoom:this.vizDetails.zoom},this.$emit("title",this.vizDetails.title||this.vizDetails.file)},async loadStandaloneYAMLConfig(){if(this.fileApi)try{const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(e);this.standaloneYAMLconfig=Object.assign({},v.parse(t)),this.validateYAML(),this.setVizDetails()}catch{console.log("failed"),this.$emit("error",{type:h.ERROR,msg:"File not found",desc:`Could not find: ${this.myState.subfolder}/${this.myState.yamlConfig}`})}},validateYAML(){const e=new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig);let t;e?(console.log("has yaml"),t=this.standaloneYAMLconfig):(console.log("no yaml"),t=this.config);for(const i in this.YAMLrequirementsXY)i in t||this.$emit("error",{type:h.ERROR,msg:`EventViewer missing required key: ${i}`,desc:`Required keys: ${Object.keys(this.YAMLrequirementsXY)}`});t.radius==0&&this.$emit("error",{type:h.WARNING,msg:"Radius set to zero",desc:"Radius can not be zero, preset value used instead. "}),(t.zoom<5||t.zoom>20)&&this.$emit("error",{type:h.WARNING,msg:"Zoom is out of the recommended range ",desc:"Zoom levels should be between 5 and 20. "})},setVizDetails(){this.vizDetails=Object.assign({},this.vizDetails,this.standaloneYAMLconfig);const e=this.vizDetails.title?this.vizDetails.title:"EVENTS: "+this.vizDetails.file;this.$emit("title",e)},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),i=F.arrayBufferToBase64(t);i&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${i})`)}catch(e){console.error(e)}},async streamEventFile(e){this.myState.statusMessage="Loading events: "+e,this.gzipWorker&&this.gzipWorker.terminate(),this.gzipWorker=new X;const t=I(this.gzipWorker),i=Object.assign({},this.fileSystem),a=[{viewer:"vehicleViewer"}];t.startStream({filename:e,layers:a,network:this.network,fsConfig:i},R(this.receiveDataFromEventStreamer))},async receiveDataFromEventStreamer(e){this.eventData=[...this.eventData,e],this.tick=1,await this.$nextTick(),this.tick=0},setFirstZoom(e,t){const i=.5*(e[0]+e[t*2-2]),a=.5*(e[1]+e[t*2-1]);Number.isFinite(i)&&Number.isFinite(a)&&o.commit("setMapCamera",Object.assign({},o.state.viewState,{longitude:i,latitude:a,zoom:10}))},toggleAnimation(){this.isAnimating=!this.isAnimating,this.isAnimating&&(this.animationElapsedTime=this.timeFilter[0]-this.timeRange[0],this.startTime=Date.now()-this.animationElapsedTime/this.guiConfig.speed,this.animate())},setConfig(){},setLegend(e,t){this.range[1]-this.range[0]!==0&&(this.legendStore=new O,this.legendStore.setLegendSection({section:"Legend",column:"Legend",values:e.map((i,a)=>{const r=t[a==0?a:a-1];let n=""+Math.round(1e6*r)/1e6;return a==0&&(n="< "+n),a==e.length-1&&(n="> "+n),{label:n,value:i}})}))},async loadNetwork(){if(!this.myDataManager)throw Error("event viewer: no datamanager");const{files:e}=await this.fileApi.getDirectory(this.subfolder);let t="";e.indexOf("network.avro")>-1?t="network.avro":t=this.vizDetails.file.replace("events.xml","network.xml"),console.log(t);const i=await this.myDataManager.getRoadNetwork(t,this.myState.subfolder,Object.assign({},this.vizDetails));return this.vizDetails.projection=""+i.projection,{network:i}},async loadFiles(){const{network:e}=await this.loadNetwork();this.network=e;let t=`${this.myState.subfolder}/${this.vizDetails.file}`;await this.streamEventFile(t)},handleTimeSliderValues(e){this.animationElapsedTime=e[0],this.simTime=this.animationElapsedTime,this.animationClockTime=this.animationElapsedTime+this.timeRange[0],this.timeFilter=e,this.timeLabels=[this.convertSecondsToClockTimeMinutes(e[0]),this.convertSecondsToClockTimeMinutes(e[1])]},animate(){if(!this.isAnimating)return;this.animationElapsedTime=this.guiConfig.speed*(Date.now()-this.startTime),this.animationClockTime=this.animationElapsedTime+this.timeRange[0],this.animationClockTime>this.timeRange[1]&&(this.startTime=Date.now(),this.animationElapsedTime=0);const e=3600;this.timeFilter=[this.animationClockTime,this.animationClockTime+e],this.simTime=this.animationClockTime,this.animator=window.requestAnimationFrame(this.animate)},convertSecondsToClockTimeMinutes(e){const t=Math.floor(e/3600),i=Math.floor((e-t*3600)/60),a=e-t*3600-i*60,r={h:`${t}`,m:`${i}`.padStart(2,"0"),s:`${a}`.padStart(2,"0")};return`${r.h}:${r.m}`}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,this.myDataManager=this.datamanager||new G(this.root,this.subfolder),await this.getVizDetails(),await this.buildThumbnail(),!this.thumbnail&&(this.setupLogoMover(),this.setupGui(),this.myState.statusMessage=`${this.$i18n.t("loading")}`,this.isLoaded||await this.loadFiles(),this.isLoaded=!0,this.myState.statusMessage="",this.timeRange=[0,86400],this.toggleAnimation())},beforeDestroy(){this.resizer?.disconnect(),l[this.viewId]=void 0,delete l[this.viewId];try{this.gzipWorker&&(this.gzipWorker.postMessage({terminate:!0}),this.gzipWorker.terminate()),this.guiController&&this.guiController.destroy()}catch(e){console.warn(e)}this.animator&&window.cancelAnimationFrame(this.animator),this.$store.commit("setFullScreen",!1)}});var K=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"viz-plugin",attrs:{oncontextmenu:"return false",id:`id-${t.viewId}`}},[t.isLoaded&&!t.thumbnail?i("event-map",{staticClass:"map-layer",attrs:{viewId:t.viewId,eventData:t.eventData,eventLayers:t.eventLayers,network:t.network,linkIdLookup:t.linkIdLookup,timeFilter:t.timeFilter,dark:this.$store.state.isDarkMode,colors:this.colors,breakpoints:this.breakpoints,radius:this.guiConfig.radius,mapIsIndependent:!1,simulationTime:t.simTime,projection:t.vizDetails.projection,dotsize:t.guiConfig.size,tick:t.tick}}):t._e(),t.thumbnail?t._e():i("zoom-buttons",{attrs:{corner:"bottom"}}),i("div",{staticClass:"top-right"},[i("div",{staticClass:"gui-config",attrs:{id:t.configId}})]),i("div",{staticClass:"bottom-right"},[t.legendStore?i("div",{staticClass:"legend-area"},[i("legend-box",{attrs:{legendStore:t.legendStore}})],1):t._e()]),t.isLoaded?i("time-slider",{staticClass:"time-slider-area",attrs:{range:t.timeRange,activeTimeExtent:t.timeFilter,labels:t.timeLabels,isAnimating:t.isAnimating},on:{timeExtent:t.handleTimeSliderValues,toggleAnimation:t.toggleAnimation,drag:function(a){t.isAnimating=!1}}}):t._e(),!t.thumbnail&&t.myState.statusMessage?i("div",{staticClass:"message"},[i("p",{staticClass:"status-message"},[t._v(t._s(t.myState.statusMessage))])]):t._e()],1)},Q=[],tt=M(J,K,Q,!1,null,"6f6e5dc9");const Ft=tt.exports;export{Ft as default};
